<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExamPro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #6C63FF;
            --primary-dark: #5a52d5;
            --primary-light: #6c63ff26;
            --bg: #F4F7F6;
            --card-bg: #ffffff;
            --text: #2d3436;
            --text-sec: #636e72;
            --border: #eeeeee;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --radius: 18px;
            --danger: #ff4757;
            --success: #2ecc71;
            --white: #ffffff;
            --warning: #ffa502;
            --live-color: #ff3838;
            --medium: #f39c12;
            --teacher-color: #3498db;
            --owner-color: #9b59b6;
        }

        .dark-mode {
            --bg: #1e1e2e;
            --card-bg: #27293d;
            --text: #e0e0e0;
            --text-sec: #a0a0a0;
            --border: #444444;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
            --primary-light: #6c63ff4d;
            --live-color: #ff6b6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Hind Siliguri', sans-serif; }
        body {
            background: var(--bg); color: var(--text); padding-bottom: 90px;
            transition: background 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }

        /* UTILS */
        .screen { display: none; min-height: 100vh; animation: fadeIn 0.4s ease; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* SPLASH SCREEN STYLES */
        #splash-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease-out;
        }
        .splash-logo-container {
            position: relative; width: 120px; height: 120px;
        }
        .splash-logo {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: pulseLogo 2s infinite ease-in-out;
            border: 4px solid var(--primary);
        }
        .splash-text {
            margin-top: 20px; font-size: 1.5rem; font-weight: 700; color: var(--primary);
            animation: fadeInUp 1s ease forwards; opacity: 0;
        }
        @keyframes pulseLogo {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108, 99, 255, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(108, 99, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108, 99, 255, 0); }
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* NETWORK STATUS POPUP */
        #network-status {
            position: fixed; top: 0; left: 0; width: 100%;
            background: var(--danger); color: white; text-align: center;
            padding: 12px; z-index: 100000; display: none;
            font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* INPUTS */
        input, select, textarea {
            width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 15px;
            background: var(--card-bg); color: var(--text); font-size: 1rem; margin-bottom: 12px;
            outline: none; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15); }

        /* BUTTONS */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 15px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-top: 5px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(0,0,0, 0.2); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sec { background: var(--border); color: var(--text); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-teacher { background: var(--teacher-color); color: white; }
        .btn-owner { background: var(--owner-color); color: white; }
        .btn:active { transform: scale(0.98); }

        /* HEADER */
        header {
            background: var(--primary);
            padding: 30px 15px 15px 20px;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: background 0.3s ease;
        }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--white) !important; }
        #theme-icon { color: var(--white) !important; opacity: 0.9; }

        /* CARDS */
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }

        /* NOTIFICATION SLIDER */
        .news-slider { width: 100%; overflow: hidden; margin-bottom: 15px; display: none; }
        .news-track { display: flex; gap: 10px; animation: slideLeft 15s linear infinite; }
        .news-item {
            background: var(--card-bg); padding: 10px 15px; border-radius: 50px;
            white-space: nowrap; border: 1px solid var(--primary); color: var(--primary);
            font-size: 0.9rem; font-weight: 500; box-shadow: var(--shadow);
            display: flex; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .news-item.new-notification {
            animation: pulseNotification 2s infinite;
            background: linear-gradient(45deg, var(--primary), #8f94fb);
            color: white;
            border: none;
        }
        @keyframes slideLeft { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes pulseNotification {
            0% { box-shadow: 0 0 0 0 rgba(108, 99, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(108, 99, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(108, 99, 255, 0); }
        }

        /* NOTIFICATION POPUP */
        .notification-popup {
            position: fixed; top: 70px; right: 20px;
            background: var(--card-bg); padding: 15px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 10000;
            display: none; width: 320px; border-left: 5px solid var(--primary);
            animation: slideInRight 0.3s ease;
            border: 1px solid var(--border);
            max-height: 400px; overflow-y: auto;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
        .notification-item {
            padding: 10px; border-radius: 10px; margin-bottom: 8px;
            background: var(--bg); border-left: 3px solid var(--primary);
            font-size: 0.85rem; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .notification-item-content {
            flex: 1;
        }
        .notification-item.unread { background: var(--primary-light); font-weight: 500; }
        .notification-delete {
            background: transparent; border: none; color: var(--danger);
            cursor: pointer; font-size: 1rem; margin-left: 10px;
            width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: 0.2s;
        }
        .notification-delete:hover { background: rgba(255, 71, 87, 0.1); }
        .notification-clear-all {
            width: 100%; margin-top: 10px; padding: 10px;
            background: var(--danger); color: white; border-radius: 10px;
            border: none; cursor: pointer; font-weight: 600;
        }

        /* MCQ STYLES */
        .mcq-anim { animation: slideUp 0.5s ease forwards; opacity: 0; }
        .mcq-option {
            display: flex; align-items: center; padding: 15px; margin-top: 10px;
            border: 2px solid var(--border); border-radius: 12px; cursor: pointer;
            transition: all 0.2s; background: var(--card-bg);
        }
        .mcq-option:hover { border-color: var(--primary); background: var(--bg); transform: translateX(5px); }
        .mcq-option.selected { border-color: var(--primary); background: var(--primary-light); font-weight: 600; }
        .mcq-circle {
            height: 20px; width: 20px; border: 2px solid var(--text-sec); border-radius: 50%;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
        }
        .mcq-option.selected .mcq-circle { border-color: var(--primary); background: var(--primary); }
        .mcq-option.selected .mcq-circle::after { content: ''; width: 8px; height: 8px; background: white; border-radius: 50%; }

        /* RESULT CARD COLOR BASED ON PERCENTAGE */
        .result-card-green {
            border-left: 5px solid var(--success) !important;
            background: linear-gradient(90deg, rgba(46, 204, 113, 0.1), transparent) !important;
        }
        .result-card-red {
            border-left: 5px solid var(--danger) !important;
            background: linear-gradient(90deg, rgba(255, 71, 87, 0.1), transparent) !important;
        }
        .result-card-medium {
            border-left: 5px solid var(--medium) !important;
            background: linear-gradient(90deg, rgba(243, 156, 18, 0.1), transparent) !important;
        }

        /* GRID CARDS */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 10px; }
        .mini-card {
            background: var(--card-bg); padding: 15px; border-radius: 15px;
            box-shadow: var(--shadow); text-align: center; cursor: pointer;
            border: 1px solid var(--border); transition: 0.2s; position: relative; overflow: hidden;
        }
        .mini-card:active { transform: scale(0.95); }
        .mini-card img { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; border: 2px solid var(--border); }
        .mini-card h4 { font-size: 0.9rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-card small { font-size: 0.75rem; color: var(--text-sec); }
        .banned-badge { position: absolute; top: 0; right: 0; background: var(--danger); color: white; font-size: 0.6rem; padding: 2px 8px; border-bottom-left-radius: 10px; }

        /* PROFILE BADGES */
        .role-badge {
            display: inline-block; padding: 3px 10px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 600; margin-left: 5px;
        }
        .student-badge { background: linear-gradient(45deg, var(--primary), #8f94fb); color: white; }
        .teacher-badge { background: linear-gradient(45deg, var(--teacher-color), #3498db); color: white; }
        .owner-badge { background: linear-gradient(45deg, var(--owner-color), #9b59b6); color: white; }

        /* DASHBOARD & ADMIN */
        .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
        .dash-btn { background: var(--card-bg); padding: 20px 10px; border-radius: 18px; text-align: center; box-shadow: var(--shadow); cursor: pointer; border: 1px solid var(--border); }

        .admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .admin-item { background: var(--card-bg); padding: 20px; border-radius: 18px; text-align: center; box-shadow: var(--shadow); cursor: pointer; border-bottom: 4px solid var(--primary); }
        .admin-item i { font-size: 1.8rem; color: var(--primary); margin-bottom: 10px; }

        /* LEVEL BADGE */
        .level-badge {
            display: inline-block; padding: 3px 10px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 600; margin-left: 5px;
            background: linear-gradient(45deg, var(--primary), #8f94fb);
            color: white;
        }

        /* LIVE BADGE */
        .live-badge {
            position: absolute; top: 10px; right: 10px;
            background: var(--live-color); color: white; font-size: 0.6rem;
            padding: 3px 8px; border-radius: 10px; animation: pulseLive 1.5s infinite;
            display: flex; align-items: center; gap: 3px;
        }
        @keyframes pulseLive {
            0% { box-shadow: 0 0 0 0 rgba(255, 56, 56, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(255, 56, 56, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 56, 56, 0); }
        }

        /* AVATAR SELECTION */
        .avatar-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0;
        }
        .avatar-option {
            width: 70px; height: 70px; border-radius: 50%; object-fit: cover;
            border: 3px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .avatar-option.selected { border-color: var(--primary); transform: scale(1.05); }

        /* MESSAGE STYLES */
        .message-card {
            background: var(--card-bg); padding: 15px; border-radius: 15px;
            margin-bottom: 10px; border-left: 4px solid var(--primary);
        }
        .message-sender { font-weight: 600; color: var(--primary); margin-bottom: 5px; }
        .message-time { font-size: 0.7rem; color: var(--text-sec); }
        .message-reply {
            margin-top: 10px; padding: 10px; background: var(--bg);
            border-radius: 10px; border-left: 3px solid var(--success);
        }
        .message-reply-admin { border-left: 3px solid var(--teacher-color); }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg); display: flex; justify-content: space-around;
            padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            z-index: 1000; border-top: 1px solid var(--border);
        }
        .nav-item {
            text-align: center; color: #aaa; font-size: 0.7rem; cursor: pointer;
            flex: 1; display: flex; flex-direction: column; align-items: center;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { font-size: 1.3rem; margin-bottom: 3px; display: block; }

        /* MODAL & ALERT */
        #custom-alert {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: var(--card-bg); padding: 25px; width: 90%; max-width: 350px;
            border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center; z-index: 10000; display: none; transition: 0.3s; border: 1px solid var(--border);
        }
        #custom-alert.show { display: block; animation: popIn 0.3s forwards; }
        @keyframes popIn { to { transform: translate(-50%, -50%) scale(1); } }

        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            z-index: 2000; display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px); padding: 20px;
        }
        .modal-content {
            background: var(--card-bg); width: 90%; max-width: 450px;
            padding: 25px; border-radius: 20px; max-height: 85vh;
            overflow-y: auto; animation: slideUp 0.3s;
        }

        /* FIXED POPUP CENTER */
        #confirm-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 110000;
            backdrop-filter: blur(4px); display: none;
            justify-content: center; align-items: center;
        }
        #confirm-modal.active { display: flex !important; }
        .confirm-box {
            background: var(--card-bg); width: 90%; max-width: 320px; padding: 25px;
            border-radius: 20px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .confirm-icon { font-size: 3rem; color: var(--danger); margin-bottom: 15px; }
        .confirm-btns { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }

        /* PULL TO REFRESH INDICATOR */
        #refresh-indicator {
            position: fixed; top: -50px; left: 50%; transform: translateX(-50%);
            background: var(--card-bg); padding: 10px; border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 9999;
            transition: top 0.3s; display: flex; justify-content: center;
            align-items: center; width: 40px; height: 40px; color: var(--primary);
        }

        /* SMALL SPINNER FOR API */
        #loader {
            position: fixed; inset: 0; background: rgba(255,255,255,0.7);
            z-index: 9999; display: none; justify-content: center;
            align-items: center; backdrop-filter: blur(2px);
        }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* SHARE MODAL */
        .share-options { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .share-option-btn {
            display: flex; align-items: center; gap: 10px;
            padding: 15px; border-radius: 12px; background: var(--bg);
            border: 2px solid var(--border); cursor: pointer; transition: 0.2s;
        }
        .share-option-btn:hover {
            border-color: var(--primary); background: var(--primary-light);
            transform: translateX(5px);
        }
        .share-option-btn i { font-size: 1.5rem; width: 40px; text-align: center; }
        .telegram-btn { color: #0088cc; }
        .website-btn { color: var(--primary); }
        .app-btn { color: var(--success); }

        /* SUPPORT MESSAGES */
        .message-container { margin-top: 20px; }
        .message-input-container {
            display: flex; gap: 10px; margin-top: 15px;
        }
        .message-input-container textarea {
            flex: 1; margin-bottom: 0;
        }
        .message-bubble {
            max-width: 80%; padding: 10px 15px; border-radius: 15px;
            margin-bottom: 10px; position: relative;
        }
        .message-bubble.sent {
            background: var(--primary-light); margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .message-bubble.received {
            background: var(--bg); margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        /* EXAM REVIEW */
        .review-container { max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .review-item {
            background: var(--bg); padding: 15px; border-radius: 12px;
            margin-bottom: 10px; border-left: 4px solid var(--primary);
        }
        .review-correct { border-left-color: var(--success); }
        .review-wrong { border-left-color: var(--danger); }
        .review-skipped { border-left-color: var(--warning); }
    </style>
</head>
<body>

    <div id="refresh-indicator"><i class="fas fa-sync-alt fa-spin"></i></div>

    <!-- Network Status Popup -->
    <div id="network-status">
        <i class="fas fa-wifi-slash"></i> No internet connection. Please check your network.
    </div>

    <!-- Notification Popup -->
    <div class="notification-popup" id="notification-popup">
        <div class="notification-header">
            <h4 style="color: var(--primary); margin:0;">Notifications</h4>
            <i class="fas fa-times" onclick="closeNotificationPopup()" style="cursor:pointer;"></i>
        </div>
        <div id="notification-list"></div>
        <button class="notification-clear-all" onclick="clearAllNotifications()" id="clear-all-btn" style="display:none;">
            <i class="fas fa-trash"></i> Clear All
        </button>
    </div>

    <div id="splash-screen">
        <div class="splash-logo-container">
            <img src="13877.jpg" alt="Logo" class="splash-logo">
        </div>
        <div class="splash-text">ExamPro</div>
    </div>

    <div id="loader"><div class="spinner"></div></div>

    <div id="custom-alert">
        <h2 style="color:var(--primary); margin-bottom:10px;">ExamPro</h2>
        <p id="alert-msg" style="color:var(--text-sec); margin-bottom:20px; font-size:1rem;">Message</p>
        <button onclick="closeAlert()" class="btn btn-primary">OK</button>
    </div>

    <div id="confirm-modal">
        <div class="confirm-box">
            <i class="fas fa-exclamation-triangle confirm-icon"></i>
            <h3 style="margin-bottom:10px;">Are you sure?</h3>
            <p id="conf-msg" style="color:var(--text-sec); font-size:0.95rem;">This action cannot be undone.</p>
            <div class="confirm-btns">
                <button onclick="resolveConfirm(false)" class="btn btn-sec" style="margin-top:0;">Cancel</button>
                <button onclick="resolveConfirm(true)" class="btn btn-danger" style="margin-top:0;">Yes, Delete</button>
            </div>
        </div>
    </div>

    <section id="auth-screen" class="screen">
        <div style="min-height:100vh; display:flex; justify-content:center; align-items:center; background:linear-gradient(135deg, var(--primary), #8f94fb); padding:20px;">
            <div class="card" style="width:100%; max-width:400px; text-align:center; border:none;">
                <h1 style="color:var(--primary); font-size:2.5rem; margin-bottom:5px;">ExamPro</h1>
                <p style="color:var(--text-sec); margin-bottom:30px;">Login to continue</p>

                <div id="login-form">
                    <input type="email" id="l-email" placeholder="Email Address">
                    <input type="password" id="l-pass" placeholder="Password">
                    <button onclick="handleLogin()" class="btn btn-primary">Log In</button>
                    <p style="margin-top:20px; color:var(--text-sec);">New User? <b onclick="toggleAuth('signup')" style="color:var(--primary); cursor:pointer;">Register</b></p>
                </div>

                <div id="signup-form" style="display:none;">
                    <input type="text" id="s-name" placeholder="Full Name">
                    <select id="s-role">
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                    </select>
                    <select id="s-gender"><option value="">Select Gender</option><option value="Male">Male</option><option value="Female">Female</option></select>
                    <input type="text" id="s-edu" placeholder="Education (e.g. HSC)">
                    <input type="email" id="s-email" placeholder="Email">
                    <input type="password" id="s-pass" placeholder="Password">
                    <button onclick="handleSignup()" class="btn btn-primary">Sign Up</button>
                    <p style="margin-top:20px; color:var(--text-sec);">Have account? <b onclick="toggleAuth('login')" style="color:var(--primary); cursor:pointer;">Log In</b></p>
                </div>

                <div style="margin:20px 0; border-top:1px solid var(--border);"></div>
                <button onclick="handleGoogle()" class="btn" style="background:white; border:1px solid #ddd; color:#333;">
                    <i class="fab fa-google" style="color:#EA4335"></i> Continue with Google
                </button>
            </div>
        </div>
    </section>

    <section id="app-screen" class="screen">
        <header>
            <div class="logo">ExamPro</div>
            <div style="display:flex; gap:15px; align-items:center;">
                <i onclick="toggleNotificationPopup()" class="fas fa-bell" id="notification-icon" style="font-size:1.4rem; cursor:pointer; color:var(--white); position:relative;">
                    <span id="notification-count" style="display:none; position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; border-radius:50%; width:18px; height:18px; font-size:0.6rem; display:flex; align-items:center; justify-content:center;">0</span>
                </i>
                <i onclick="toggleTheme()" id="theme-icon" class="fas fa-moon" style="font-size:1.4rem; cursor:pointer;"></i>
            </div>
        </header>

        <div id="main-content" class="container"></div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="renderHome()"><i class="fas fa-home"></i> <span>Home</span></div>
            <div class="nav-item" onclick="renderLeaderboard()"><i class="fas fa-trophy"></i> <span>Rank</span></div>
            <div class="nav-item" onclick="renderProfile()"><i class="fas fa-user"></i> <span>Profile</span></div>
            <div class="nav-item" id="support-nav" onclick="renderSupport()"><i class="fas fa-headset"></i> <span>Support</span></div>
            <div class="nav-item" id="admin-nav" style="display:none;" onclick="renderAdmin()"><i class="fas fa-th-large"></i> <span>Admin</span></div>
        </nav>
    </section>

    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom:20px; color:var(--primary);">Title</h2>
            <div id="modal-body"></div>
            <button onclick="closeModal()" class="btn btn-sec" style="margin-top:20px;">Close</button>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px; color:var(--primary); text-align:center;">
                <i class="fas fa-share-alt"></i> Share ExamPro
            </h2>
            <div class="share-options">
                <div class="share-option-btn telegram-btn" onclick="shareViaPlatform('telegram')">
                    <i class="fab fa-telegram"></i>
                    <div>
                        <div style="font-weight:600;">Telegram Bot</div>
                        <small style="color:var(--text-sec);">Share via Telegram bot</small>
                    </div>
                </div>
                <div class="share-option-btn website-btn" onclick="shareViaPlatform('website')">
                    <i class="fas fa-globe"></i>
                    <div>
                        <div style="font-weight:600;">Website</div>
                        <small style="color:var(--text-sec);">Share website link</small>
                    </div>
                </div>
                <div class="share-option-btn app-btn" onclick="shareViaPlatform('app')">
                    <i class="fas fa-mobile-alt"></i>
                    <div>
                        <div style="font-weight:600;">App</div>
                        <small style="color:var(--text-sec);">Share app download link</small>
                    </div>
                </div>
            </div>
            <button onclick="closeShareModal()" class="btn btn-sec" style="margin-top:20px;">Cancel</button>
        </div>
    </div>

    <!-- Audio for notification sound -->
    <audio id="notification-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, deleteDoc, updateDoc, onSnapshot, Timestamp, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBW0-UiTB83ikUOztrT6ECAkOlnzxykKYQ",
            authDomain: "mcq-exam-b150e.firebaseapp.com",
            projectId: "mcq-exam-b150e",
            storageBucket: "mcq-exam-b150e.firebasestorage.app",
            messagingSenderId: "751727102033",
            appId: "1:751727102033:web:35995f15619e300872d070",
            measurementId: "G-9NS51NRGER"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUser = null;
        let timerInterval;
        let allStudentsCache = [];
        let allNotifications = [];
        let unreadNotifications = 0;

        // AVATAR IMAGES - Multiple options
        const MALE_AVATARS = [
            "https://cdn-icons-png.flaticon.com/512/4825/4825038.png",
            "https://cdn-icons-png.flaticon.com/512/4825/4825039.png",
            "https://cdn-icons-png.flaticon.com/512/4825/4825040.png",
            "https://cdn-icons-png.flaticon.com/512/4825/4825041.png",
            "https://cdn-icons-png.flaticon.com/512/4825/4825042.png",
            "https://cdn-icons-png.flaticon.com/512/4825/4825043.png"
        ];

        const FEMALE_AVATARS = [
            "https://cdn-icons-png.flaticon.com/512/4825/4825112.png",
            "https://cdn-icons-png.flaticon.com/512/4825/4825113.png",
            "https://cdn-icons-png.flaticon.com/512/4825/4825114.png",
            "https://cdn-icons-png.flaticon.com/512/4825/4825115.png",
            "https://cdn-icons-png.flaticon.com/512/4825/4825116.png",
            "https://cdn-icons-png.flaticon.com/512/4825/4825117.png"
        ];

        // DEFAULT AVATARS
        const DEFAULT_MALE_AVATAR = MALE_AVATARS[0];
        const DEFAULT_FEMALE_AVATAR = FEMALE_AVATARS[0];

        // SHARE LINKS DEFAULT
        let shareLinks = {
            telegram: "https://t.me/your_bot",
            website: "https://yourexampro.com",
            app: "https://play.google.com/store/apps/details?id=com.exampro"
        };

        // --- NETWORK CONNECTIVITY ---
        function updateNetworkStatus() {
            const networkStatus = document.getElementById('network-status');
            if (!navigator.onLine) {
                networkStatus.style.display = 'block';
            } else {
                networkStatus.style.display = 'none';
            }
        }

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        updateNetworkStatus(); // Initial check

        // --- SPLASH SCREEN LOGIC ---
        function hideSplash() {
            const splash = document.getElementById('splash-screen');
            if(splash) {
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 600);
            }
        }

        // --- PULL TO REFRESH LOGIC ---
        let touchStart = 0;
        let touchEnd = 0;
        const refInd = document.getElementById('refresh-indicator');

        window.addEventListener('touchstart', e => {
            if(window.scrollY === 0) touchStart = e.changedTouches[0].screenY;
        }, {passive: true});

        window.addEventListener('touchmove', e => {
            if(window.scrollY === 0 && touchStart > 0) {
                touchEnd = e.changedTouches[0].screenY;
                if(touchEnd > touchStart) {
                    const pull = Math.min((touchEnd - touchStart) * 0.4, 80);
                    refInd.style.top = `${pull}px`;
                }
            }
        }, {passive: true});

        window.addEventListener('touchend', e => {
            if(window.scrollY === 0 && touchStart > 0) {
                touchEnd = e.changedTouches[0].screenY;
                if(touchEnd - touchStart > 120) {
                    refInd.style.top = '20px';
                    setTimeout(() => location.reload(), 300);
                } else {
                    refInd.style.top = '-50px';
                }
            }
            touchStart = 0;
        }, {passive: true});

        // --- CUSTOM CONFIRM LOGIC (FIXED) ---
        let confirmResolver = null;
        window.customConfirm = (msg) => {
            const m = document.getElementById('confirm-modal');
            document.getElementById('conf-msg').innerText = msg;
            m.classList.add('active');
            return new Promise((resolve) => {
                confirmResolver = resolve;
            });
        }
        window.resolveConfirm = (val) => {
            const m = document.getElementById('confirm-modal');
            m.classList.remove('active');
            if(confirmResolver) confirmResolver(val);
        }

        // --- UTILS ---
        window.showMsg = (msg) => {
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('custom-alert').classList.add('show');
        }
        window.closeAlert = () => document.getElementById('custom-alert').classList.remove('show');
        window.toggleTheme = () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').className = 'fas fa-sun';
        }

        // --- SHARE FUNCTIONS ---
        window.showShareOptions = () => {
            document.getElementById('share-modal').style.display = 'flex';
        }

        window.closeShareModal = () => {
            document.getElementById('share-modal').style.display = 'none';
        }

        window.shareViaPlatform = async (platform) => {
            // Load share links from Firebase
            const shareLinksSnap = await getDoc(doc(db, "settings", "shareLinks"));
            if (shareLinksSnap.exists()) {
                shareLinks = shareLinksSnap.data();
            }

            let shareUrl = "";
            let platformName = "";

            switch(platform) {
                case 'telegram':
                    shareUrl = shareLinks.telegram || "https://t.me/your_bot";
                    platformName = "Telegram Bot";
                    break;
                case 'website':
                    shareUrl = shareLinks.website || "https://yourexampro.com";
                    platformName = "Website";
                    break;
                case 'app':
                    shareUrl = shareLinks.app || "https://play.google.com/store/apps/details?id=com.exampro";
                    platformName = "App";
                    break;
            }

            const shareText = `Hey! Check out ExamPro - the best exam preparation app! Join me using this ${platformName} link: ${shareUrl}`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'ExamPro',
                        text: shareText,
                        url: shareUrl,
                    });
                } catch (err) {
                    console.log('Error sharing:', err);
                    copyToClipboard(shareText);
                }
            } else {
                copyToClipboard(shareText);
            }

            closeShareModal();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMsg("Link copied to clipboard! Share it with your friends.");
            });
        }

        // --- NOTIFICATION FUNCTIONS ---
        function playNotificationSound() {
            const audio = document.getElementById('notification-sound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio play failed:", e));
        }

        function showNotificationPopup(title, message) {
            const popup = document.getElementById('notification-popup');
            popup.style.display = 'block';

            // Auto hide after 5 seconds
            setTimeout(() => {
                popup.style.display = 'none';
            }, 5000);
        }

        window.toggleNotificationPopup = () => {
            const popup = document.getElementById('notification-popup');
            if(popup.style.display === 'block') {
                popup.style.display = 'none';
            } else {
                loadNotifications();
                popup.style.display = 'block';
            }
        }

        window.closeNotificationPopup = () => {
            document.getElementById('notification-popup').style.display = 'none';
        }

        async function loadNotifications() {
            const q = query(collection(db, "notifications"), where("userId", "==", currentUser.uid));
            const snap = await getDocs(q);

            allNotifications = [];
            unreadNotifications = 0;
            snap.forEach(doc => {
                const notif = { id: doc.id, ...doc.data() };
                allNotifications.push(notif);
                if(!notif.read) unreadNotifications++;
            });

            // Sort by timestamp (newest first)
            allNotifications.sort((a, b) => b.timestamp?.toMillis() - a.timestamp?.toMillis());

            updateNotificationUI();
        }

        function updateNotificationUI() {
            const list = document.getElementById('notification-list');
            const countElem = document.getElementById('notification-count');
            const clearAllBtn = document.getElementById('clear-all-btn');

            if(allNotifications.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:var(--text-sec); padding:10px;">No notifications</p>';
                clearAllBtn.style.display = 'none';
            } else {
                let html = '';
                allNotifications.forEach(notif => {
                    const icon = getNotificationIcon(notif.type);
                    const time = formatTime(notif.timestamp?.toMillis() || Date.now());
                    html += `
                        <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="markAsRead('${notif.id}')">
                            <div class="notification-item-content">
                                <div style="display:flex; gap:10px;">
                                    <i class="fas ${icon}" style="color:var(--primary);"></i>
                                    <div>
                                        <div style="font-weight:600;">${notif.title}</div>
                                        <div style="font-size:0.8rem; color:var(--text-sec);">${notif.message}</div>
                                        <div style="font-size:0.7rem; color:var(--text-sec); margin-top:3px;">${time}</div>
                                    </div>
                                </div>
                            </div>
                            <button class="notification-delete" onclick="deleteNotification('${notif.id}', event)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                });
                list.innerHTML = html;
                clearAllBtn.style.display = 'block';
            }

            // Update notification count badge
            if(unreadNotifications > 0) {
                countElem.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
                countElem.style.display = 'flex';
            } else {
                countElem.style.display = 'none';
            }
        }

        window.deleteNotification = async (notificationId, event) => {
            if (event) event.stopPropagation();
            await deleteDoc(doc(db, "notifications", notificationId));
            loadNotifications();
        }

        window.clearAllNotifications = async () => {
            if(await customConfirm("Clear all notifications?")) {
                const q = query(collection(db, "notifications"), where("userId", "==", currentUser.uid));
                const snap = await getDocs(q);

                const batch = writeBatch(db);
                snap.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                loadNotifications();
                showMsg("All notifications cleared!");
            }
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'exam': return 'fa-file-alt';
                case 'routine': return 'fa-calendar';
                case 'note': return 'fa-book';
                case 'broadcast': return 'fa-bullhorn';
                case 'message': return 'fa-comment';
                default: return 'fa-bell';
            }
        }

        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;

            if(diff < 60000) return 'Just now';
            if(diff < 3600000) return `${Math.floor(diff/60000)} min ago`;
            if(diff < 86400000) return `${Math.floor(diff/3600000)} hour ago`;
            return `${Math.floor(diff/86400000)} day ago`;
        }

        async function markAsRead(notificationId) {
            await updateDoc(doc(db, "notifications", notificationId), { read: true });
            loadNotifications();
        }

        async function sendNotification(userId, title, message, type = 'general') {
            await addDoc(collection(db, "notifications"), {
                userId: userId,
                title: title,
                message: message,
                type: type,
                read: false,
                timestamp: Timestamp.now()
            });
        }

        // --- MESSAGE/SUPPORT FUNCTIONS ---
        async function sendMessageToAdmin(message) {
            await addDoc(collection(db, "messages"), {
                userId: currentUser.uid,
                userName: currentUser.name,
                userEmail: currentUser.email,
                message: message,
                timestamp: Timestamp.now(),
                replied: false,
                replyMessage: "",
                repliedBy: "",
                repliedAt: null
            });

            // Send notification to all admins
            const adminsSnap = await getDocs(query(collection(db, "users"), where("role", "in", ["admin", "owner"])));
            adminsSnap.forEach(async (adminDoc) => {
                await sendNotification(
                    adminDoc.id,
                    "New Support Message",
                    `${currentUser.name} sent a support message`,
                    'message'
                );
            });

            showMsg("Message sent to admin!");
        }

        async function loadMessages() {
            const q = query(collection(db, "messages"), where("userId", "==", currentUser.uid), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            let html = '';
            snap.forEach(doc => {
                const msg = doc.data();
                const time = formatTime(msg.timestamp?.toMillis() || Date.now());
                html += `
                    <div class="message-card">
                        <div class="message-sender">You</div>
                        <p>${msg.message}</p>
                        <div class="message-time">${time}</div>
                        ${msg.replied ? `
                            <div class="message-reply ${msg.repliedBy === 'admin' ? 'message-reply-admin' : ''}">
                                <div style="font-weight:600; color:var(--success);">Admin Reply:</div>
                                <p>${msg.replyMessage}</p>
                                <div style="font-size:0.7rem; color:var(--text-sec); margin-top:5px;">
                                    Replied by: ${msg.repliedBy}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            return html || '<p style="text-align:center; color:var(--text-sec); padding:20px;">No messages yet</p>';
        }

        async function loadAdminInbox() {
            const q = query(collection(db, "messages"), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            let html = '';
            snap.forEach(doc => {
                const msg = doc.data();
                const time = formatTime(msg.timestamp?.toMillis() || Date.now());
                const repliedBadge = msg.replied ? '<span style="background:var(--success); color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">Replied</span>' :
                                                   '<span style="background:var(--danger); color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">Pending</span>';

                html += `
                    <div class="message-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="message-sender">${msg.userName} (${msg.userEmail})</div>
                            ${repliedBadge}
                        </div>
                        <p>${msg.message}</p>
                        <div class="message-time">${time}</div>

                        ${!msg.replied ? `
                            <div style="margin-top:10px; display:flex; gap:10px;">
                                <textarea id="reply-${doc.id}" placeholder="Type your reply..." rows="2" style="flex:1; margin-bottom:0;"></textarea>
                                <button onclick="sendReply('${doc.id}')" class="btn btn-success" style="width:auto; padding:10px 15px;">Send</button>
                            </div>
                        ` : `
                            <div class="message-reply">
                                <div style="font-weight:600; color:var(--success);">Your Reply:</div>
                                <p>${msg.replyMessage}</p>
                            </div>
                        `}
                    </div>
                `;
            });
            return html || '<p style="text-align:center; color:var(--text-sec); padding:20px;">No messages yet</p>';
        }

        window.sendReply = async (messageId) => {
            const replyText = document.getElementById(`reply-${messageId}`).value;
            if(!replyText) return showMsg("Please write a reply");

            await updateDoc(doc(db, "messages", messageId), {
                replied: true,
                replyMessage: replyText,
                repliedBy: currentUser.name,
                repliedAt: Timestamp.now()
            });

            // Send notification to the user
            const msgDoc = await getDoc(doc(db, "messages", messageId));
            if(msgDoc.exists()) {
                await sendNotification(
                    msgDoc.data().userId,
                    "Admin Replied to Your Message",
                    replyText,
                    'message'
                );
            }

            showMsg("Reply sent!");
            admView('inbox');
        }

        // --- AUTH ---
        window.toggleAuth = (m) => {
            document.getElementById('login-form').style.display = m==='login'?'block':'none';
            document.getElementById('signup-form').style.display = m==='signup'?'block':'none';
        }
        window.handleLogin = async () => {
            try {
                toggleLoader(true);
                await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value);
            }
            catch(e) {
                showMsg(e.message);
                toggleLoader(false);
            }
        }
        window.handleSignup = async () => {
            const n=document.getElementById('s-name').value,
                  r=document.getElementById('s-role').value,
                  g=document.getElementById('s-gender').value,
                  e=document.getElementById('s-edu').value;
            if(!n || !g || !r) return showMsg("Please fill all details");
            try {
                toggleLoader(true);
                const res = await createUserWithEmailAndPassword(auth, document.getElementById('s-email').value, document.getElementById('s-pass').value);

                // Set default avatar based on gender
                const defaultAvatar = g === 'Female' ? DEFAULT_FEMALE_AVATAR : DEFAULT_MALE_AVATAR;

                await setDoc(doc(db, "users", res.user.uid), {
                    name: n,
                    role: r,
                    gender: g,
                    education: e,
                    email: res.user.email,
                    points: 0,
                    level: 1,
                    avatar: defaultAvatar,
                    joined: new Date().toLocaleDateString(),
                    isBanned: false,
                    examsTaken: []
                });
                showMsg("Account Created!");
            } catch(e) { showMsg(e.message); toggleLoader(false); }
        }
        window.handleGoogle = async () => {
            try {
                const res = await signInWithPopup(auth, googleProvider);
                const ref = doc(db, "users", res.user.uid);
                const snap = await getDoc(ref);
                if(!snap.exists()) {
                    await setDoc(ref, {
                        name: res.user.displayName,
                        email: res.user.email,
                        role: 'student',
                        gender: 'Male',
                        education: 'Not Set',
                        avatar: DEFAULT_MALE_AVATAR,
                        points: 0,
                        level: 1,
                        joined: new Date().toLocaleDateString(),
                        isBanned: false,
                        examsTaken: []
                    });
                }
            } catch(e) { showMsg(e.message); }
        }
        window.handleLogout = () => signOut(auth).then(()=>location.reload());

        // --- AUTH STATE ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                await loadServerTheme();
                // Load share links
                const shareLinksSnap = await getDoc(doc(db, "settings", "shareLinks"));
                if (shareLinksSnap.exists()) {
                    shareLinks = shareLinksSnap.data();
                }

                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists()) {
                    currentUser = { uid: user.uid, ...snap.data() };

                    if(currentUser.isBanned) {
                        await signOut(auth);
                        showMsg("You are BANNED by Admin.");
                        toggleLoader(false);
                        hideSplash();
                        return;
                    }

                    document.getElementById('auth-screen').classList.remove('active-screen');
                    document.getElementById('app-screen').classList.add('active-screen');

                    // Show admin nav for admin/owner
                    if(currentUser.role === 'admin' || currentUser.role === 'owner') {
                        document.getElementById('admin-nav').style.display = 'block';
                    }

                    // Show support nav for students
                    if(currentUser.role === 'student') {
                        document.getElementById('support-nav').style.display = 'block';
                    }

                    loadNotifications();
                    setupNotificationListener();

                    renderHome();
                } else {
                    await signOut(auth);
                }
            } else {
                document.getElementById('app-screen').classList.remove('active-screen');
                document.getElementById('auth-screen').classList.add('active-screen');
            }
            toggleLoader(false);
            setTimeout(hideSplash, 500);
        });

        // Notification listener
        function setupNotificationListener() {
            if(!currentUser) return;

            const q = query(collection(db, "notifications"), where("userId", "==", currentUser.uid));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if(change.type === "added") {
                        const newNotif = change.doc.data();
                        if(!newNotif.read) {
                            playNotificationSound();
                            showNotificationPopup(newNotif.title, newNotif.message);
                            loadNotifications();
                        }
                    }
                });
            });
        }

        // --- HOME ---
        window.renderHome = async () => {
            updateNav(0);
            const div = document.getElementById('main-content');

            const bcSnap = await getDoc(doc(db, "settings", "broadcast"));
            let bcHTML = bcSnap.exists() ? `<div class="card" style="background:linear-gradient(to right, #ff9966, #ff5e62); color:white; padding:15px; animation:fadeIn 0.5s; display:flex; gap:10px; align-items:center;"><i class="fas fa-bullhorn"></i> <div><b>NOTICE:</b> ${bcSnap.data().message}</div></div>` : '';

            div.innerHTML = `
                ${bcHTML}
                <div class="card" style="background:linear-gradient(135deg, var(--primary), #8f94fb); color:white; border:none; padding:25px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h2>Hi, ${currentUser.name.split(' ')[0]}! </h2>
                            <p style="opacity:0.9; margin-top:5px;">Points: <b>${currentUser.points || 0}</b> | Level: <span class="level-badge">${currentUser.level || 1}</span></p>
                            <p style="font-size:0.9rem; opacity:0.8;">${currentUser.education}</p>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:2rem; font-weight:bold; color:white;">${currentUser.level || 1}</div>
                            <div style="font-size:0.8rem;">Level</div>
                        </div>
                    </div>
                </div>

                <div class="dash-grid">
                    <div class="dash-btn" onclick="showRoutineView()"><i class="fas fa-calendar-alt" style="color:#FF9F43; font-size:1.5rem; margin-bottom:5px;"></i><br>Routine</div>
                    <div class="dash-btn" onclick="renderLeaderboard()"><i class="fas fa-trophy" style="color:#28C76F; font-size:1.5rem; margin-bottom:5px;"></i><br>Rank</div>
                    <div class="dash-btn" onclick="showNotesView()"><i class="fas fa-book-open" style="color:#00CFE8; font-size:1.5rem; margin-bottom:5px;"></i><br>Notes</div>
                </div>

                <div id="news-area" class="news-slider"><div class="news-track" id="news-track"></div></div>

                <h3 style="margin-bottom:15px; color:var(--text); display:flex; align-items:center; gap:10px;"><i class="fas fa-clock" style="color:var(--primary)"></i> Live Exams</h3>
                <div id="exam-list">Loading...</div>
            `;

            loadRecentUpdates();

            const s = await getDocs(collection(db, "exams"));
            const l = document.getElementById('exam-list');
            l.innerHTML = '';
            if(s.empty) return l.innerHTML = '<p style="text-align:center; color:var(--text-sec); padding:20px;">No exams available right now.</p>';

            s.forEach(d => {
                const data = d.data();
                const examId = d.id;
                const isTaken = currentUser.examsTaken && currentUser.examsTaken.includes(examId);
                const isRecent = data.createdAt && (Date.now() - data.createdAt) < 24 * 60 * 60 * 1000;

                l.innerHTML += `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center; border-left: 5px solid var(--primary); position:relative;">
                        ${isRecent ? '<div class="live-badge"><i class="fas fa-circle"></i> LIVE</div>' : ''}
                        <div style="flex:1;">
                            <h4 style="font-size:1.1rem; margin-bottom:5px;">${data.title}</h4>
                            <small style="color:var(--text-sec); background:var(--bg); padding:3px 8px; border-radius:5px;"> ${data.time} Min</small>
                        </div>
                        <button onclick="${isTaken ? 'showMsg(\'You have already taken this exam!\')' : `startExam('${examId}', '${data.title}', ${data.time})`}"
                                class="btn ${isTaken ? 'btn-sec' : 'btn-primary'}"
                                style="width:auto; margin:0; padding:8px 20px; font-size:0.9rem;"
                                ${isTaken ? 'disabled' : ''}>
                            ${isTaken ? 'Already Taken' : 'Start'}
                        </button>
                    </div>`;
            });
        }

        async function loadRecentUpdates() {
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            let updates = [];

            const eSnap = await getDocs(collection(db, "exams"));
            eSnap.forEach(d => {
                if(d.data().createdAt && (now - d.data().createdAt) < oneDay)
                    updates.push(` New Exam: ${d.data().title}`);
            });

            const rSnap = await getDocs(collection(db, "routines"));
            rSnap.forEach(d => {
                if(d.data().createdAt && (now - d.data().createdAt) < oneDay)
                    updates.push(` Routine Updated: ${d.data().title}`);
            });

            const nSnap = await getDocs(collection(db, "notes"));
            nSnap.forEach(d => {
                if(d.data().createdAt && (now - d.data().createdAt) < oneDay)
                    updates.push(` New Note: ${d.data().title}`);
            });

            if(currentUser) {
                const notifQuery = query(collection(db, "notifications"), where("userId", "==", currentUser.uid));
                const notifSnap = await getDocs(notifQuery);
                notifSnap.forEach(d => {
                    const data = d.data();
                    if(data.timestamp && (now - data.timestamp.toMillis()) < oneDay && !data.read) {
                        updates.push(` ${data.title}: ${data.message}`);
                    }
                });
            }

            if(updates.length > 0) {
                document.getElementById('news-area').style.display = 'block';
                const track = document.getElementById('news-track');
                let html = updates.map(u => `<div class="news-item ${updates.indexOf(u) === 0 ? 'new-notification' : ''}"><i class="fas fa-bell"></i> ${u}</div>`).join('');
                if(updates.length < 3) html += html + html;
                track.innerHTML = html;
            }
        }

        // --- FEATURES ---
        window.showRoutineView = async () => {
            openModal("Class Routine", "Loading...");
            const snap = await getDocs(collection(db, "routines"));
            let h = snap.empty ? "<p>No routine added.</p>" : "";
            snap.forEach(d => h += `<div style="padding:15px; background:var(--bg); border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; border:1px solid var(--border);"><b>${d.data().title}</b><span style="color:var(--primary)">${d.data().time}</span></div>`);
            document.getElementById('modal-body').innerHTML = h;
        }
        window.showNotesView = async () => {
            openModal("Notes & PDF", "Loading...");
            const snap = await getDocs(collection(db, "notes"));
            let h = snap.empty ? "<p>No notes found.</p>" : "";
            snap.forEach(d => h += `<div style="padding:15px; background:var(--bg); border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;"><span> ${d.data().title}</span><a href="${d.data().link}" target="_blank" style="background:var(--primary); color:white; padding:5px 15px; border-radius:8px; text-decoration:none; font-size:0.8rem;">PDF</a></div>`);
            document.getElementById('modal-body').innerHTML = h;
        }

        // --- LEADERBOARD ---
        window.renderLeaderboard = async () => {
            updateNav(1);
            document.getElementById('main-content').innerHTML = `
            <div class="card" style="background:var(--bg); text-align:center;"><h3> Top Students</h3></div>
            <div id="lb-list" style="margin-top:10px;">Loading...</div>`;

            const snap = await getDocs(collection(db, "users"));
            let u = []; snap.forEach(d => u.push({id: d.id, ...d.data()}));
            u.sort((a,b) => (b.points||0) - (a.points||0));

            let h = '';
            u.slice(0, 50).forEach((x, i) => {
                let badge = i<3 ? ["","",""][i] : `#${i+1}`;
                let bg = i<3 ? 'border: 2px solid var(--primary);' : '';
                h += `<div class="card" style="display:flex; align-items:center; padding:15px; ${bg}">
                    <b style="font-size:1.3rem; margin-right:15px; width:40px; text-align:center;">${badge}</b>
                    <div style="flex:1;">
                        <h4 style="margin-bottom:2px;">${x.name} <span class="level-badge">Level ${x.level || 1}</span></h4>
                        <small style="color:var(--text-sec)">${x.education}</small>
                    </div>
                    <div style="background:var(--bg); padding:5px 10px; border-radius:8px;">
                        <b style="color:var(--primary)">${x.points||0}</b> <small>pts</small>
                    </div>
                </div>`;
            });
            document.getElementById('lb-list').innerHTML = h;
        }

        // --- SUPPORT ---
        window.renderSupport = async () => {
            updateNav(3);
            document.getElementById('main-content').innerHTML = `
                <div class="card">
                    <h3 style="color:var(--primary); margin-bottom:15px;"><i class="fas fa-headset"></i> Support Center</h3>
                    <p style="color:var(--text-sec); margin-bottom:20px;">Send a message to admin for any queries or issues.</p>

                    <div class="message-input-container">
                        <textarea id="support-message" placeholder="Type your message here..." rows="3"></textarea>
                    </div>
                    <button onclick="sendSupportMessage()" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Message
                    </button>
                </div>

                <h3 style="margin:20px 0 10px 0;">Previous Messages</h3>
                <div id="messages-list">Loading...</div>
            `;

            const messagesHtml = await loadMessages();
            document.getElementById('messages-list').innerHTML = messagesHtml;
        }

        window.sendSupportMessage = async () => {
            const message = document.getElementById('support-message').value;
            if(!message.trim()) return showMsg("Please write a message");

            await sendMessageToAdmin(message);
            document.getElementById('support-message').value = '';

            // Reload messages
            const messagesHtml = await loadMessages();
            document.getElementById('messages-list').innerHTML = messagesHtml;
        }

        // --- PROFILE ---
        window.renderProfile = async () => {
            updateNav(2);

            // Determine role badge
            let roleBadgeClass = 'student-badge';
            let roleText = 'Student';
            if(currentUser.role === 'teacher') {
                roleBadgeClass = 'teacher-badge';
                roleText = 'Teacher';
            } else if(currentUser.role === 'admin' || currentUser.role === 'owner') {
                roleBadgeClass = 'owner-badge';
                roleText = currentUser.role === 'owner' ? 'Owner' : 'Admin';
            }

            document.getElementById('main-content').innerHTML = `
                <div class="card" style="text-align:center; padding-top:30px; position:relative;">
                    <div style="position:absolute; top:20px; right:20px;">
                        <span class="role-badge ${roleBadgeClass}">${roleText}</span>
                    </div>
                    <div style="width:110px; height:110px; border-radius:50%; margin:0 auto 15px; display:flex; justify-content:center; align-items:center; box-shadow:0 10px 20px rgba(0,0,0,0.1); border: 4px solid var(--bg); overflow:hidden; position:relative;">
                        <img src="${currentUser.avatar || (currentUser.gender === 'Female' ? DEFAULT_FEMALE_AVATAR : DEFAULT_MALE_AVATAR)}" style="width:100%; height:100%; object-fit:cover;">
                        <div onclick="editProfile()" style="position:absolute; bottom:0; right:0; background:var(--primary); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                            <i class="fas fa-camera" style="font-size:0.8rem;"></i>
                        </div>
                    </div>
                    <h2 style="margin-bottom:5px;">${currentUser.name}</h2>
                    <p style="color:var(--text-sec); font-size:0.9rem;">${currentUser.email}</p>
                    <div style="margin:15px 0; display:flex; justify-content:center; gap:10px;">
                        <span style="background:var(--bg); padding:5px 15px; border-radius:20px; font-size:0.8rem;"> Points: ${currentUser.points || 0}</span>
                        <span style="background:var(--primary-light); padding:5px 15px; border-radius:20px; font-size:0.8rem; color:var(--primary);"> Level ${currentUser.level || 1}</span>
                    </div>
                    <div style="margin:15px 0;">
                        <span style="background:var(--bg); padding:5px 15px; border-radius:20px; font-size:0.8rem;"> Joined: ${currentUser.joined || 'N/A'}</span>
                        <span style="background:var(--bg); padding:5px 15px; border-radius:20px; font-size:0.8rem; margin-left:5px;">${currentUser.education || 'Not Set'}</span>
                    </div>

                    <!-- Share Button -->
                    <button onclick="showShareOptions()" class="btn btn-primary" style="margin-top:10px;">
                        <i class="fas fa-share-alt"></i> Share with Friends
                    </button>

                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button onclick="editProfile()" class="btn btn-sec" style="width:48%;"><i class="fas fa-pen"></i> Edit Profile</button>
                        <button onclick="clearHistory()" class="btn btn-danger" style="width:48%;"><i class="fas fa-trash"></i> Clear History</button>
                    </div>

                    <button onclick="handleLogout()" class="btn" style="margin-top:15px; background:var(--bg); color:var(--danger); border:1px solid var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout Securely</button>
                </div>
                <h3 style="margin-left:5px;">Recent Results</h3>
                <div id="hist-list">Loading...</div>
            `;

            const q = query(collection(db, "results"), where("userId", "==", currentUser.uid), orderBy("date", "desc"));
            const s = await getDocs(q);
            let h = s.empty ? "<p style='text-align:center; color:var(--text-sec); margin-top:20px;'>No exams taken yet.</p>" : "";
            s.forEach(d => {
                const data = d.data();
                let percentage = (data.score / data.total) * 100;
                let cardClass = "result-card-medium";
                if (percentage >= 80) {
                    cardClass = "result-card-green";
                } else if (percentage <= 40) {
                    cardClass = "result-card-red";
                }
                h += `<div class="card ${cardClass}" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="showExamReview('${d.id}')">
                    <div><b style="font-size:1rem;">${data.exam}</b><br><small style="color:var(--text-sec)">${data.date}</small></div>
                    <b style="font-size:1.2rem;">${data.score}/${data.total}</b>
                </div>`
            });
            document.getElementById('hist-list').innerHTML = h;
        }

        window.showExamReview = async (resultId) => {
            const resultDoc = await getDoc(doc(db, "results", resultId));
            if(resultDoc.exists()) {
                const data = resultDoc.data();
                openModal(`Exam Review: ${data.exam}`, `
                    <div class="review-container">
                        <div style="text-align:center; margin-bottom:20px;">
                            <h1 style="font-size:3rem; color:var(--primary);">${data.score}/${data.total}</h1>
                            <p style="color:var(--text-sec)">Score: ${((data.score/data.total)*100).toFixed(1)}%</p>
                        </div>
                        ${data.review || '<p style="text-align:center; color:var(--text-sec);">No review available for this exam.</p>'}
                    </div>
                `);
            }
        }

        window.editProfile = () => {
            const avatarUrl = currentUser.avatar || (currentUser.gender === 'Female' ? DEFAULT_FEMALE_AVATAR : DEFAULT_MALE_AVATAR);
            const avatars = currentUser.gender === 'Female' ? FEMALE_AVATARS : MALE_AVATARS;

            let avatarOptions = '';
            avatars.forEach((avatar, index) => {
                const selected = avatar === avatarUrl ? 'selected' : '';
                avatarOptions += `<img src="${avatar}" class="avatar-option ${selected}" onclick="selectAvatar(this, '${avatar}')">`;
            });

            openModal("Edit Profile", `
                <input id="e-name" value="${currentUser.name}" placeholder="Name">
                <select id="e-gender" onchange="changeAvatarGender()">
                    <option value="Male" ${currentUser.gender === 'Male' ? 'selected' : ''}>Male</option>
                    <option value="Female" ${currentUser.gender === 'Female' ? 'selected' : ''}>Female</option>
                </select>
                <input id="e-edu" value="${currentUser.education}" placeholder="Education">
                <h4 style="margin-top:20px;">Select Avatar</h4>
                <div id="avatar-container" class="avatar-grid">
                    ${avatarOptions}
                </div>
                <input type="hidden" id="selected-avatar" value="${avatarUrl}">
                <button onclick="saveProfile()" class="btn btn-primary">Save Changes</button>
            `);
        }

        window.selectAvatar = (element, avatarUrl) => {
            document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selected-avatar').value = avatarUrl;
        }

        window.changeAvatarGender = () => {
            const gender = document.getElementById('e-gender').value;
            const avatars = gender === 'Female' ? FEMALE_AVATARS : MALE_AVATARS;
            let avatarOptions = '';
            avatars.forEach((avatar, index) => {
                avatarOptions += `<img src="${avatar}" class="avatar-option" onclick="selectAvatar(this, '${avatar}')">`;
            });
            document.getElementById('avatar-container').innerHTML = avatarOptions;
            // Select first avatar by default
            document.getElementById('selected-avatar').value = gender === 'Female' ? DEFAULT_FEMALE_AVATAR : DEFAULT_MALE_AVATAR;
            document.querySelector('.avatar-option').classList.add('selected');
        }

        window.saveProfile = async () => {
            const n=document.getElementById('e-name').value,
                  g=document.getElementById('e-gender').value,
                  e=document.getElementById('e-edu').value,
                  a=document.getElementById('selected-avatar').value;
            await updateDoc(doc(db, "users", currentUser.uid), { name: n, gender: g, education: e, avatar: a });
            currentUser.name = n;
            currentUser.gender = g;
            currentUser.education = e;
            currentUser.avatar = a;
            closeModal();
            renderProfile();
        }

        window.clearHistory = async () => {
            if(await customConfirm("Are you sure you want to delete all exam history?")) {
                const q = query(collection(db, "results"), where("userId", "==", currentUser.uid));
                const s = await getDocs(q);
                s.forEach(async (d) => await deleteDoc(d.ref));

                await updateDoc(doc(db, "users", currentUser.uid), { examsTaken: [] });
                currentUser.examsTaken = [];

                renderProfile();
            }
        }

        // --- MCQ ENGINE - UPDATED SCORING ---
        window.startExam = async (id, title, time) => {
            if(currentUser.examsTaken && currentUser.examsTaken.includes(id)) {
                showMsg("You have already taken this exam!");
                return;
            }

            const div = document.getElementById('main-content');
            div.innerHTML = `<div id="q-area" style="padding-bottom:50px;">Loading questions...</div>`;
            const q = query(collection(db, "questions"), where("examId", "==", id));
            const snap = await getDocs(q);
            if(snap.empty) return div.innerHTML = "<div class='card'>No questions found for this exam.</div>";

            let qs = []; snap.forEach(d => qs.push({id: d.id, ...d.data()}));
            window.currentQ = qs; window.userAns = {};
            window.currentExamId = id;

            let html = `
                <div style="position:sticky; top:75px; background:var(--card-bg); color:var(--text); padding:15px; border-radius:15px; margin-bottom:20px; z-index:90; display:flex; justify-content:space-between; align-items:center; box-shadow:var(--shadow); border:1px solid var(--border);">
                    <b style="color:var(--primary); font-size:1.1rem;">${title}</b>
                    <span id="timer" style="background:var(--danger); color:white; padding:5px 12px; border-radius:20px; font-weight:bold;">00:00</span>
                </div>`;

            qs.forEach((d, i) => {
                const qText = d.question || d.q || "Untitled Question";
                html += `
                <div class="card mcq-anim" style="animation-delay: ${i*0.05}s">
                    <p style="font-weight:600; font-size:1.1rem; color:var(--text); margin-bottom:15px;">
                        <span style="color:var(--primary)">Q${i+1}.</span> ${qText}
                    </p>
                    <div id="opts-${d.id}">
                        ${d.options.map((o, idx) => `
                            <div class="mcq-option" onclick="selectOpt('${d.id}', ${idx+1}, this)">
                                <div class="mcq-circle"></div>
                                <span>${o}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            });

            html += `<button onclick="submitExam('${title}')" class="btn btn-primary" style="margin-top:20px;">Submit Exam</button>`;
            document.getElementById('q-area').innerHTML = html;

            let left = time*60;
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                let m=Math.floor(left/60), s=left%60;
                document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
                if(left <= 30) {
                    document.getElementById('timer').style.animation = "pulse 1s infinite";
                    document.getElementById('timer').style.background = "var(--danger)";
                }
                left--; if(left<0) submitExam(title);
            }, 1000);
        }

        window.selectOpt = (qid, idx, el) => {
            window.userAns[qid] = idx;
            const p = document.getElementById(`opts-${qid}`);
            Array.from(p.children).forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        window.submitExam = async (title) => {
            clearInterval(timerInterval);
            toggleLoader(true);

            let score = 0, totalQuestions = window.currentQ.length;
            let pointsChange = 0;
            let review = '';

            // NEW SCORING SYSTEM: Correct = +1, Wrong = -0.5
            window.currentQ.forEach((q, i) => {
                const ans = window.userAns[q.id];
                const correct = ans === parseInt(q.correct);
                const qText = q.question || q.q;

                if(ans) { // If answered
                    if(correct) {
                        score += 1; // Correct answer = +1 mark
                        pointsChange += 1; // Points for level
                    } else {
                        score -= 0.5; // Wrong answer = -0.5 mark
                        pointsChange -= 0.5; // Points for level
                    }
                }
                // Skipped questions get 0 marks, no points change

                const answerClass = correct ? 'review-correct' : (ans ? 'review-wrong' : 'review-skipped');
                review += `<div class="review-item ${answerClass}">
                    <p style="font-size:0.9rem;"><b>Q${i+1}:</b> ${qText}</p>
                    <div style="margin-top:5px; font-size:0.9rem;">
                        Your Answer: <b style="color:${correct?'var(--success)':(ans?'var(--danger)':'var(--warning)')}">${ans ? q.options[ans-1] : 'Skipped'}</b>
                        ${!correct ? `<br>Correct Answer: <b style="color:var(--success)">${q.options[parseInt(q.correct)-1]}</b>` : ''}
                    </div>
                </div>`;
            });

            // Ensure score is not negative
            if (score < 0) score = 0;

            // Calculate percentage for card color
            const percentage = (score / totalQuestions) * 100;
            let resultCardClass = "result-card-medium";
            if (percentage >= 80) {
                resultCardClass = "result-card-green";
            } else if (percentage <= 40) {
                resultCardClass = "result-card-red";
            }

            // Calculate new points and level
            const newPoints = Math.max(0, (currentUser.points || 0) + pointsChange);
            const newLevel = Math.floor(newPoints / 100) + 1;

            // Update user data
            const examsTaken = currentUser.examsTaken || [];
            if(!examsTaken.includes(window.currentExamId)) {
                examsTaken.push(window.currentExamId);
            }

            await updateDoc(doc(db, "users", currentUser.uid), {
                points: newPoints,
                level: newLevel,
                examsTaken: examsTaken
            });

            // Save result with decimal score AND review
            await addDoc(collection(db, "results"), {
                userId: currentUser.uid,
                exam: title,
                examId: window.currentExamId,
                score: score.toFixed(1),
                total: totalQuestions,
                pointsChange: pointsChange,
                date: new Date().toLocaleDateString(),
                review: review
            });

            // Update current user object
            currentUser.points = newPoints;
            currentUser.level = newLevel;
            currentUser.examsTaken = examsTaken;

            // Send notification for exam completion
            await sendNotification(currentUser.uid, "Exam Completed!", `You scored ${score.toFixed(1)}/${totalQuestions} in ${title}. Points: ${pointsChange > 0 ? '+' : ''}${pointsChange}`, 'exam');

            renderHome();
            openModal(`Result: ${score.toFixed(1)}/${totalQuestions}`, `
                <div style="text-align:center; padding:20px 0;">
                    <h1 style="font-size:4rem; color:var(--primary); line-height:1;">${score.toFixed(1)}</h1>
                    <p style="color:var(--text-sec)">Out of ${totalQuestions}</p>
                    <div style="margin:15px 0; padding:15px; background:var(--bg); border-radius:12px;">
                        <div style="display:flex; justify-content:space-around;">
                            <div>
                                <div style="font-size:1.5rem; color:var(--primary);">${newPoints}</div>
                                <div style="font-size:0.8rem;">Total Points</div>
                            </div>
                            <div>
                                <div style="font-size:1.5rem; color:${pointsChange >= 0 ? 'var(--success)' : 'var(--danger)'};">${pointsChange > 0 ? '+' : ''}${pointsChange}</div>
                                <div style="font-size:0.8rem;">Points Change</div>
                            </div>
                            <div>
                                <div style="font-size:1.5rem; color:var(--warning);">${newLevel}</div>
                                <div style="font-size:0.8rem;">Level</div>
                            </div>
                        </div>
                    </div>
                </div>
                <h3 style="margin-bottom:15px;">Exam Review</h3>
                <div style="max-height:40vh; overflow-y:auto; padding-right:10px;">
                    ${review}
                </div>
            `);
            toggleLoader(false);
        }

        // --- ADMIN PANEL - UPDATED ---
        window.renderAdmin = () => {
            updateNav(4);
            let adminGrid = `
                <div class="admin-item" onclick="admView('exam')"><i class="fas fa-file-alt"></i><h4>Exams</h4></div>
                <div class="admin-item" onclick="admView('student')"><i class="fas fa-users"></i><h4>Students</h4></div>`;

            // Show teacher management only for owners
            if(currentUser.role === 'owner') {
                adminGrid += `<div class="admin-item" onclick="admView('teachers')"><i class="fas fa-chalkboard-teacher"></i><h4>Teachers</h4></div>`;
            }

            adminGrid += `
                <div class="admin-item" onclick="admView('routine')"><i class="fas fa-calendar"></i><h4>Routine</h4></div>
                <div class="admin-item" onclick="admView('notes')"><i class="fas fa-file-pdf"></i><h4>Notes/PDF</h4></div>
                <div class="admin-item" onclick="admView('broadcast')"><i class="fas fa-bullhorn"></i><h4>Broadcast</h4></div>
                <div class="admin-item" onclick="admView('inbox')"><i class="fas fa-inbox"></i><h4>Inbox</h4></div>
                <div class="admin-item" onclick="admView('notifications')"><i class="fas fa-bell"></i><h4>Notifications</h4></div>
                <div class="admin-item" onclick="admView('settings')"><i class="fas fa-cogs"></i><h4>Settings</h4></div>
            `;

            document.getElementById('main-content').innerHTML = `
                <div class="admin-grid">
                    ${adminGrid}
                </div>
                <div id="adm-area" style="margin-top:20px;"></div>
            `;
        }

        window.admView = async (m) => {
            const area = document.getElementById('adm-area');
            area.innerHTML = '<div class="card">Loading...</div>';

            if(m === 'exam') {
                area.innerHTML = `
                    <div class="card"><h3>Create Exam</h3><input id="nt" placeholder="Title"><input id="nm" type="number" placeholder="Time (Min)"><button onclick="addExam()" class="btn btn-primary">Create</button></div>
                    <div class="card">
                        <h3>Manage Exams</h3>
                        <p style="font-size:0.8rem; color:var(--text-sec); margin-bottom:10px;">Tap to Delete</p>
                        <div id="el" class="grid-container"></div>
                    </div>
                    <div class="card"><h3>Add MCQ (JSON)</h3><div style="display:flex; gap:10px;"><select id="es"></select><button onclick="copyFormat()" class="btn btn-sec" style="width:auto; margin:0 0 15px 0;">Copy Format</button></div><textarea id="jt" rows="4" placeholder="Paste JSON here..."></textarea><button onclick="upJson()" class="btn btn-primary">Upload</button></div>`;

                const s = await getDocs(collection(db, "exams"));
                let h='', o='';
                s.forEach(d=>{
                    h+=`<div class="mini-card" onclick="delDoc('exams','${d.id}')">
                        <i class="fas fa-file-contract" style="color:var(--primary)"></i>
                        <h4>${d.data().title}</h4>
                        <small>${d.data().time} Min</small>
                    </div>`;
                    o+=`<option value="${d.id}">${d.data().title}</option>`;
                });
                document.getElementById('el').innerHTML = h || "<p>No exams.</p>";
                document.getElementById('es').innerHTML = o;
            }

            if(m === 'student') {
                area.innerHTML = `
                    <div class="card">
                        <h3>Registered Students</h3>
                        <input id="search-box" placeholder="Search by Name or Email..." style="margin-top:10px;">
                        <div id="sl" class="grid-container">Loading...</div>
                    </div>`;

                const s = await getDocs(collection(db, "users"));
                allStudentsCache = [];
                s.forEach(d => { if(d.data().role === 'student') allStudentsCache.push({id: d.id, ...d.data()}); });

                renderStudentList(allStudentsCache);
                document.getElementById('search-box').addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = allStudentsCache.filter(u => u.name.toLowerCase().includes(term) || u.email.toLowerCase().includes(term));
                    renderStudentList(filtered);
                });
            }

            if(m === 'teachers') {
                area.innerHTML = `
                    <div class="card">
                        <h3>Manage Teachers</h3>
                        <input id="teacher-email" placeholder="Teacher Email to Add">
                        <button onclick="addTeacher()" class="btn btn-primary">Add Teacher</button>
                    </div>
                    <div class="card">
                        <h3>Current Teachers</h3>
                        <div id="teacher-list" class="grid-container">Loading...</div>
                    </div>
                `;

                const s = await getDocs(query(collection(db, "users"), where("role", "==", "teacher")));
                let h = '';
                s.forEach(d => {
                    const teacher = d.data();
                    h += `<div class="mini-card">
                        <img src="${teacher.avatar || DEFAULT_MALE_AVATAR}">
                        <h4>${teacher.name}</h4>
                        <small>${teacher.email}</small>
                        <button onclick="removeTeacher('${d.id}')" class="btn btn-danger" style="margin-top:5px; padding:5px 10px; font-size:0.7rem;">Remove</button>
                    </div>`;
                });
                document.getElementById('teacher-list').innerHTML = h || '<p>No teachers added yet.</p>';
            }

            if(m === 'routine') {
                area.innerHTML = `<div class="card"><h3>Add Routine</h3><input id="rt" placeholder="Title"><input id="rm" placeholder="Time"><button onclick="addRT()" class="btn btn-primary">Add</button></div><div class="card"><h3>Manage</h3><div id="rl"></div></div>`;
                const s = await getDocs(collection(db, "routines")); let h=''; s.forEach(d=>{ h+=`<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border);"><span>${d.data().title}</span><button class="btn btn-danger" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="delDoc('routines','${d.id}')">Del</button></div>`; });
                document.getElementById('rl').innerHTML = h;
            }

            if(m === 'notes') {
                area.innerHTML = `<div class="card"><h3>Add PDF</h3><input id="pt" placeholder="Title"><input id="pl" placeholder="Link"><button onclick="addNT()" class="btn btn-primary">Add</button></div><div class="card"><h3>Manage</h3><div id="nl"></div></div>`;
                const s = await getDocs(collection(db, "notes")); let h=''; s.forEach(d=>{ h+=`<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border);"><span>${d.data().title}</span><button class="btn btn-danger" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="delDoc('notes','${d.id}')">Del</button></div>`; });
                document.getElementById('nl').innerHTML = h;
            }

            if(m === 'broadcast') {
                area.innerHTML = `<div class="card"><h3>Broadcast Message</h3><textarea id="bcm" rows="3" placeholder="Write message..."></textarea><button onclick="sendBC()" class="btn btn-primary">Send to All</button><button onclick="clearBC()" class="btn btn-sec">Clear</button></div>`;
            }

            if(m === 'inbox') {
                area.innerHTML = `
                    <div class="card">
                        <h3>Support Inbox</h3>
                        <div id="inbox-list"></div>
                    </div>
                `;

                const inboxHtml = await loadAdminInbox();
                document.getElementById('inbox-list').innerHTML = inboxHtml;
            }

            if(m === 'notifications') {
                area.innerHTML = `
                    <div class="card">
                        <h3>Send Notification</h3>
                        <input id="notif-title" placeholder="Notification Title">
                        <textarea id="notif-message" rows="3" placeholder="Notification Message"></textarea>
                        <select id="notif-type">
                            <option value="general">General</option>
                            <option value="exam">Exam</option>
                            <option value="routine">Routine</option>
                            <option value="note">Note</option>
                            <option value="broadcast">Broadcast</option>
                        </select>
                        <select id="notif-target">
                            <option value="all">All Users</option>
                            <option value="specific">Specific User</option>
                        </select>
                        <input id="notif-user" placeholder="User Email (if specific)" style="display:none;">
                        <button onclick="sendNotificationToUsers()" class="btn btn-primary">Send Notification</button>
                    </div>
                    <div class="card">
                        <h3>Recent Notifications</h3>
                        <div id="notif-list"></div>
                    </div>
                `;

                document.getElementById('notif-target').addEventListener('change', function() {
                    document.getElementById('notif-user').style.display = this.value === 'specific' ? 'block' : 'none';
                });

                // Load recent notifications with user names
                const notifSnap = await getDocs(collection(db, "notifications"));
                let notifHtml = '';
                for (const doc of notifSnap.docs) {
                    const data = doc.data();
                    // Get user name
                    let userName = "Unknown User";
                    try {
                        const userDoc = await getDoc(doc(db, "users", data.userId));
                        if(userDoc.exists()) {
                            userName = userDoc.data().name;
                        }
                    } catch(e) {
                        console.log("Error fetching user:", e);
                    }

                    notifHtml += `<div style="padding:10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div><b>${data.title}</b></div>
                            <div style="font-size:0.8rem;">${data.message}</div>
                            <div style="font-size:0.7rem; color:var(--text-sec);">To: ${userName}</div>
                        </div>
                        <button onclick="deleteNotificationAdmin('${doc.id}')" class="notification-delete">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>`;
                }
                document.getElementById('notif-list').innerHTML = notifHtml || '<p>No notifications sent yet.</p>';
            }

            if(m === 'settings') {
                // Load existing share links
                const shareLinksSnap = await getDoc(doc(db, "settings", "shareLinks"));
                if (shareLinksSnap.exists()) {
                    shareLinks = shareLinksSnap.data();
                }

                area.innerHTML = `<div class="card"><h3>Theme Color</h3>
                <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                    <div onclick="setTh('#6C63FF')" style="width:35px; height:35px; background:#6C63FF; border-radius:50%; cursor:pointer;"></div>
                    <div onclick="setTh('#00b894')" style="width:35px; height:35px; background:#00b894; border-radius:50%; cursor:pointer;"></div>
                    <div onclick="setTh('#FF6584')" style="width:35px; height:35px; background:#FF6584; border-radius:50%; cursor:pointer;"></div>
                    <div onclick="setTh('#f39c12')" style="width:35px; height:35px; background:#f39c12; border-radius:50%; cursor:pointer;"></div>
                    <div onclick="setTh('#3498db')" style="width:35px; height:35px; background:#3498db; border-radius:50%; cursor:pointer;"></div>
                    <div onclick="setTh('#9b59b6')" style="width:35px; height:35px; background:#9b59b6; border-radius:50%; cursor:pointer;"></div>
                </div>

                <h4 style="margin-top:20px;">Adjust Tone</h4>
                <div class="theme-slider-container">
                    <input type="range" min="0" max="360" value="0" class="thermo" id="hue-slider" oninput="slideTheme(this.value)">
                    <p style="text-align:center; font-size:0.8rem;">Slide to change color</p>
                </div>

                <h3 style="margin-top:20px;">Share Links</h3>
                <input id="telegram-link" value="${shareLinks.telegram || ''}" placeholder="Telegram Bot Link">
                <input id="website-link" value="${shareLinks.website || ''}" placeholder="Website Link">
                <input id="app-link" value="${shareLinks.app || ''}" placeholder="App Download Link">
                <button onclick="saveShareLinks()" class="btn btn-primary">Save Share Links</button>

                <h3 style="margin-top:20px;">Actions</h3>
                <button onclick="resetRank()" class="btn btn-danger">Reset All Ranks</button></div>`;
            }
        }

        window.renderStudentList = (list) => {
            let h = '';
            list.forEach(u => {
                const isBan = u.isBanned ? '<span class="banned-badge">BANNED</span>' : '';
                const av = u.avatar || (u.gender === 'Female' ? DEFAULT_FEMALE_AVATAR : DEFAULT_MALE_AVATAR);

                h += `<div class="mini-card" onclick="viewUser('${u.id}')">
                    ${isBan}
                    <img src="${av}">
                    <h4>${u.name} <span class="level-badge">Lvl ${u.level || 1}</span></h4>
                    <small>${u.education}</small>
                    <small style="color:var(--primary); font-weight:600;">${u.points || 0} pts</small>
                </div>`;
            });
            document.getElementById('sl').innerHTML = h || '<p>No students found.</p>';
        }

        // --- ACTIONS ---
        window.addExam = async () => {
            await addDoc(collection(db, "exams"), {
                title:document.getElementById('nt').value,
                time:parseInt(document.getElementById('nm').value),
                createdAt: Date.now()
            });

            const usersSnap = await getDocs(collection(db, "users"));
            usersSnap.forEach(async (userDoc) => {
                if(userDoc.data().role !== 'admin' && userDoc.data().role !== 'owner') {
                    await sendNotification(
                        userDoc.id,
                        "New Exam Available!",
                        `A new exam "${document.getElementById('nt').value}" has been added. Check it out!`,
                        'exam'
                    );
                }
            });

            showMsg("Created");
            admView('exam');
        }

        window.upJson = async () => {
            try {
                const d=JSON.parse(document.getElementById('jt').value);
                for(const q of d) {
                   await addDoc(collection(db,"questions"),{
                       examId:document.getElementById('es').value,
                       question: q.question || q.q,
                       options: q.options,
                       correct: q.correct
                   });
                }
                showMsg("Uploaded Successfully");
            } catch(e){showMsg("JSON Error: Check format");}
        }

        window.addRT = async () => {
            await addDoc(collection(db, "routines"), {
                title:document.getElementById('rt').value,
                time:document.getElementById('rm').value,
                createdAt: Date.now()
            });

            const usersSnap = await getDocs(collection(db, "users"));
            usersSnap.forEach(async (userDoc) => {
                if(userDoc.data().role !== 'admin' && userDoc.data().role !== 'owner') {
                    await sendNotification(
                        userDoc.id,
                        "Routine Updated!",
                        `New routine "${document.getElementById('rt').value}" has been added.`,
                        'routine'
                    );
                }
            });

            showMsg("Added");
            admView('routine');
        }

        window.addNT = async () => {
            await addDoc(collection(db, "notes"), {
                title:document.getElementById('pt').value,
                link:document.getElementById('pl').value,
                createdAt: Date.now()
            });

            const usersSnap = await getDocs(collection(db, "users"));
            usersSnap.forEach(async (userDoc) => {
                if(userDoc.data().role !== 'admin' && userDoc.data().role !== 'owner') {
                    await sendNotification(
                        userDoc.id,
                        "New Note Added!",
                        `A new note "${document.getElementById('pt').value}" is available.`,
                        'note'
                    );
                }
            });

            showMsg("Added");
            admView('notes');
        }

        window.delDoc = async (c, id) => {
            if(await customConfirm("Are you sure you want to delete this?")) {
                await deleteDoc(doc(db, c, id));
                showMsg("Deleted");
                if(c==='exams') admView('exam');
                else if(c==='routines') admView('routine');
                else if(c==='notes') admView('notes');
            }
        }

        window.sendBC = async () => {
            const message = document.getElementById('bcm').value;
            await setDoc(doc(db, "settings", "broadcast"), {message: message});

            const usersSnap = await getDocs(collection(db, "users"));
            usersSnap.forEach(async (userDoc) => {
                if(userDoc.data().role !== 'admin' && userDoc.data().role !== 'owner') {
                    await sendNotification(
                        userDoc.id,
                        "Important Announcement!",
                        message,
                        'broadcast'
                    );
                }
            });

            showMsg("Broadcast Sent to All Users");
        }

        window.clearBC = async () => {
            await deleteDoc(doc(db, "settings", "broadcast"));
            showMsg("Cleared");
        }

        window.setTh = async (c) => {
            await setDoc(doc(db,"settings","theme"),{color:c});
            document.documentElement.style.setProperty('--primary', c);
            showMsg("Theme Set");
        }

        window.slideTheme = (val) => {
            const color = `hsl(${val}, 70%, 60%)`;
            document.documentElement.style.setProperty('--primary', color);
            if(window.saveThemeTimeout) clearTimeout(window.saveThemeTimeout);
            window.saveThemeTimeout = setTimeout(async() => {
                 await setDoc(doc(db,"settings","theme"),{color:color});
            }, 1000);
        }

        window.resetRank = async () => {
            if(await customConfirm("Reset all points to 0 and levels to 1?")) {
                const s=await getDocs(collection(db,"users"));
                s.forEach(d=> updateDoc(d.ref, {points:0, level:1, examsTaken: []}));
                showMsg("Reset Done");
            }
        }

        window.viewUser = async (uid) => {
            const uSnap = await getDoc(doc(db, "users", uid));
            const u = uSnap.data();
            const q = query(collection(db, "results"), where("userId", "==", uid));
            const s = await getDocs(q);
            let h = ""; s.forEach(d => h += `<div style="font-size:0.9rem; border-bottom:1px solid var(--border); padding:5px;"><b>${d.data().exam}</b>: ${d.data().score}/${d.data().total} (${d.data().pointsChange > 0 ? '+' : ''}${d.data().pointsChange} pts)</div>`);

            const btnText = u.isBanned ? "Unban Student" : "Ban Student";
            const btnColor = u.isBanned ? "var(--success)" : "var(--danger)";

            openModal("Student Details", `
                <div style="text-align:center;">
                    <h3 style="color:var(--primary)">${u.name}</h3>
                    <p>${u.email}</p>
                    <p style="font-size:0.8rem; color:var(--text-sec)">Joined: ${u.joined}</p>
                    <div style="display:flex; justify-content:center; gap:10px; margin:10px 0;">
                        <div style="background:var(--bg); padding:10px; border-radius:10px;">
                            <div style="font-size:1.5rem; color:var(--primary);">${u.points || 0}</div>
                            <div style="font-size:0.8rem;">Points</div>
                        </div>
                        <div style="background:var(--bg); padding:10px; border-radius:10px;">
                            <div style="font-size:1.5rem; color:var(--warning);">${u.level || 1}</div>
                            <div style="font-size:0.8rem;">Level</div>
                        </div>
                    </div>

                    <div style="margin:15px 0;">
                        <h4>Adjust Level/Points</h4>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="adj-points" value="${u.points || 0}" placeholder="Points" style="width:50%;">
                            <input type="number" id="adj-level" value="${u.level || 1}" placeholder="Level" style="width:50%;">
                        </div>
                        <button onclick="adjustUserPoints('${uid}')" class="btn btn-primary" style="margin-top:10px;">Update</button>
                    </div>

                    <button onclick="toggleBan('${uid}', ${u.isBanned})" class="btn" style="background:${btnColor}; color:white; margin:15px 0;">${btnText}</button>
                </div>
                <hr style="border:1px solid var(--border); margin:10px 0;">
                <h4>Exam History</h4>
                <div style="max-height:150px; overflow-y:auto;">${h||"No exams taken."}</div>
            `);
        }

        window.adjustUserPoints = async (uid) => {
            const newPoints = parseInt(document.getElementById('adj-points').value) || 0;
            const newLevel = parseInt(document.getElementById('adj-level').value) || 1;

            await updateDoc(doc(db, "users", uid), {
                points: newPoints,
                level: newLevel
            });

            showMsg("User points and level updated!");
            closeModal();
            admView('student');
        }

        window.toggleBan = async (uid, currentStatus) => {
            await updateDoc(doc(db, "users", uid), { isBanned: !currentStatus });
            showMsg(currentStatus ? "User Unbanned" : "User Banned");
            closeModal();
            admView('student');
        }

        window.addTeacher = async () => {
            const email = document.getElementById('teacher-email').value;
            const q = query(collection(db, "users"), where("email", "==", email));
            const s = await getDocs(q);
            if(s.empty) return showMsg("User not found");
            
            const userDoc = s.docs[0];
            const userData = userDoc.data();
            
            if(userData.role === 'teacher') return showMsg("User is already a teacher");
            
            await updateDoc(doc(db, "users", userDoc.id), {role:'teacher'});
            showMsg("Teacher Added!");
            document.getElementById('teacher-email').value = '';
            admView('teachers');
        }

        window.removeTeacher = async (uid) => {
            if(await customConfirm("Remove this teacher?")) {
                await updateDoc(doc(db, "users", uid), {role:'student'});
                showMsg("Teacher removed!");
                admView('teachers');
            }
        }

        window.copyFormat = () => {
            const fmt = `[{"question":"Question Name?","options":["A","B","C","D"],"correct":4}]`;
            navigator.clipboard.writeText(fmt);
            showMsg("Format Copied!");
        }

        window.sendNotificationToUsers = async () => {
            const title = document.getElementById('notif-title').value;
            const message = document.getElementById('notif-message').value;
            const type = document.getElementById('notif-type').value;
            const target = document.getElementById('notif-target').value;
            const specificUser = document.getElementById('notif-user').value;

            if(!title || !message) return showMsg("Please fill all fields");

            if(target === 'all') {
                const usersSnap = await getDocs(collection(db, "users"));
                let count = 0;

                for(const userDoc of usersSnap.docs) {
                    if(userDoc.data().role !== 'admin' && userDoc.data().role !== 'owner') {
                        await sendNotification(userDoc.id, title, message, type);
                        count++;
                    }
                }

                showMsg(`Notification sent to ${count} users!`);
            } else {
                const q = query(collection(db, "users"), where("email", "==", specificUser));
                const s = await getDocs(q);

                if(s.empty) return showMsg("User not found");

                s.forEach(async (doc) => {
                    await sendNotification(doc.id, title, message, type);
                });

                showMsg("Notification sent to specific user!");
            }

            document.getElementById('notif-title').value = '';
            document.getElementById('notif-message').value = '';
        }

        window.deleteNotificationAdmin = async (notificationId) => {
            await deleteDoc(doc(db, "notifications", notificationId));
            showMsg("Notification deleted!");
            admView('notifications');
        }

        window.saveShareLinks = async () => {
            const telegramLink = document.getElementById('telegram-link').value;
            const websiteLink = document.getElementById('website-link').value;
            const appLink = document.getElementById('app-link').value;

            await setDoc(doc(db, "settings", "shareLinks"), {
                telegram: telegramLink,
                website: websiteLink,
                app: appLink
            });

            shareLinks = { telegram: telegramLink, website: websiteLink, app: appLink };
            showMsg("Share links saved!");
        }

        // --- LOADERS ---
        async function loadServerTheme() {
            const s = await getDoc(doc(db, "settings", "theme"));
            if(s.exists()) document.documentElement.style.setProperty('--primary', s.data().color);
        }
        function updateNav(i) {
            document.querySelectorAll('.nav-item').forEach((n,x)=> {
                n.classList.remove('active');
                if(i===x) n.classList.add('active');
            });
        }
        function openModal(t, b) {
            document.getElementById('modal-title').innerText = t;
            document.getElementById('modal-body').innerHTML = b;
            document.getElementById('generic-modal').style.display = 'flex';
        }
        window.closeModal = () => document.getElementById('generic-modal').style.display = 'none';
        function toggleLoader(s) {
            document.getElementById('loader').style.display = s?'flex':'none';
        }

    </script>
</body>
</html>
