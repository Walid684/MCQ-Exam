<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExamPro Final Fixed</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- PREMIUM THEME SYSTEM --- */
        :root {
            --primary: #6C63FF; 
            --primary-dark: #5a52d5;
            --accent: #FF6584;
            --bg: #F4F7F6;
            --white: #ffffff;
            --text: #2d3436;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 25px rgba(0,0,0,0.06);
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Hind Siliguri', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 90px; -webkit-tap-highlight-color: transparent; transition: background 0.3s; }
        
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #loader { position: fixed; inset: 0; background: var(--white); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid #eee; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }

        .screen { display: none; min-height: 100vh; animation: fadeIn 0.3s ease-out; }
        .active-screen { display: block; }

        /* AUTH SCREEN */
        .auth-wrapper { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; }
        .auth-card { background: var(--white); width: 100%; max-width: 400px; padding: 40px 30px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); text-align: center; }
        
        .input-group { position: relative; margin-bottom: 15px; text-align: left; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
        .input-group input, .input-group select { width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #eee; border-radius: 12px; background: #f8f9fa; outline: none; transition: 0.3s; }
        .input-group input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1); }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3); }
        .btn-google { background: white; border: 1px solid #ddd; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* APP HEADER */
        header { background: var(--glass); backdrop-filter: blur(10px); padding: 15px 20px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .points-badge { background: #FFF0DA; color: #FF9F43; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; }

        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: var(--white); padding: 20px; border-radius: var(--radius); margin-bottom: 15px; box-shadow: var(--shadow); position: relative; }
        
        /* DASHBOARD */
        .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
        .dash-btn { background: var(--white); padding: 15px 10px; border-radius: 15px; text-align: center; box-shadow: var(--shadow); cursor: pointer; transition: 0.3s; }
        .dash-btn:active { transform: scale(0.95); }

        /* ADMIN PANEL STYLES */
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .admin-item { background: var(--white); padding: 20px; border-radius: 15px; text-align: center; box-shadow: var(--shadow); border-bottom: 4px solid var(--primary); cursor: pointer; }
        .admin-item i { font-size: 1.8rem; color: var(--primary); margin-bottom: 8px; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 10px; margin-bottom: 8px; }
        .del-btn { background: #ffebeb; color: #ff4757; border: none; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; font-weight: 600; }

        /* PROFILE */
        .avatar-container { width: 90px; height: 90px; margin: 0 auto 10px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; position: relative; border: 4px solid var(--white); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .male { background: #E3F2FD; color: #2196F3; }
        .female { background: #FCE4EC; color: #E91E63; }
        .edit-badge { position: absolute; bottom: 0; right: 0; background: var(--text); color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; cursor: pointer; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; border-radius: 20px 20px 0 0; }
        .nav-item { text-align: center; color: #b2bec3; font-size: 0.75rem; cursor: pointer; transition: 0.3s; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 3px; display: block; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }
        
        /* Review Section */
        .review-box { border-left: 4px solid #ddd; padding: 10px; background: #f9f9f9; margin-bottom: 10px; border-radius: 8px; }
        .review-box.correct { border-left-color: #00b894; background: #e6fffa; }
        .review-box.wrong { border-left-color: #ff7675; background: #fff0f0; }

    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <section id="auth-screen" class="screen">
        <div class="auth-wrapper">
            <div class="auth-card">
                <h1 style="color:var(--primary); margin-bottom:5px;">ExamPro</h1>
                <p style="color:#888; margin-bottom:25px;">Master Your Preparation</p>
                
                <div id="login-form">
                    <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="l-email" placeholder="Email Address"></div>
                    <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="l-pass" placeholder="Password"></div>
                    <button onclick="handleLogin()" class="btn btn-primary">Log In</button>
                    <p style="margin-top:15px; font-size:0.9rem;">New User? <b onclick="toggleAuth('signup')" style="color:var(--primary); cursor:pointer;">Register</b></p>
                </div>

                <div id="signup-form" style="display:none;">
                    <div class="input-group"><i class="fas fa-user"></i><input type="text" id="s-name" placeholder="Full Name"></div>
                    <div class="input-group"><i class="fas fa-venus-mars"></i>
                        <select id="s-gender"><option value="">Select Gender</option><option value="Male">Male</option><option value="Female">Female</option></select>
                    </div>
                    <div class="input-group"><i class="fas fa-graduation-cap"></i><input type="text" id="s-edu" placeholder="Education (e.g. HSC)"></div>
                    <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="s-email" placeholder="Email"></div>
                    <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="s-pass" placeholder="Password"></div>
                    <button onclick="handleSignup()" class="btn btn-primary">Sign Up</button>
                    <p style="margin-top:15px; font-size:0.9rem;">Have account? <b onclick="toggleAuth('login')" style="color:var(--primary); cursor:pointer;">Log In</b></p>
                </div>
                
                <div style="margin:20px 0; border-top:1px solid #eee;"></div>
                <button onclick="handleGoogle()" class="btn btn-google"><i class="fab fa-google" style="color:#EA4335"></i> Continue with Google</button>
            </div>
        </div>
    </section>

    <section id="app-screen" class="screen">
        <header>
            <div class="logo">ExamPro</div>
            <div style="display:flex; gap:10px; align-items:center;">
                <div class="points-badge" id="header-points">üèÜ 0</div>
                <i onclick="handleLogout()" class="fas fa-power-off" style="color:var(--accent); font-size:1.2rem; cursor:pointer; margin-left:10px;"></i>
            </div>
        </header>

        <div id="main-content" class="container"></div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="renderHome()"><i class="fas fa-home"></i> <span>Home</span></div>
            <div class="nav-item" onclick="renderLeaderboard()"><i class="fas fa-trophy"></i> <span>Rank</span></div>
            <div class="nav-item" onclick="renderProfile()"><i class="fas fa-user"></i> <span>Profile</span></div>
            <div class="nav-item" id="admin-nav" style="display:none;" onclick="renderAdmin()"><i class="fas fa-th-large"></i> <span>Admin</span></div>
        </nav>
    </section>

    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-bottom:15px;">Title</h3>
            <div id="modal-body"></div>
            <button onclick="closeModal()" class="btn" style="background:#eee; color:#333; margin-top:15px;">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, deleteDoc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBW0-UiTB83ikUOztrT6ECAkOlnzxykKYQ",
            authDomain: "mcq-exam-b150e.firebaseapp.com",
            projectId: "mcq-exam-b150e",
            storageBucket: "mcq-exam-b150e.firebasestorage.app",
            messagingSenderId: "751727102033",
            appId: "1:751727102033:web:35995f15619e300872d070",
            measurementId: "G-9NS51NRGER"
        };
        const ADMIN_EMAIL = "mdwld2005@gmail.com";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUser = null;
        let timerInterval;

        // --- AUTH SYSTEM ---
        window.toggleAuth = (m) => {
            document.getElementById('login-form').style.display = m==='login'?'block':'none';
            document.getElementById('signup-form').style.display = m==='signup'?'block':'none';
        }

        window.handleLogin = async () => {
            try { toggleLoader(true); await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value); } 
            catch(e) { alert(e.message); toggleLoader(false); }
        }

        window.handleSignup = async () => {
            const name = document.getElementById('s-name').value, gender = document.getElementById('s-gender').value, edu = document.getElementById('s-edu').value;
            if(!name || !gender) return alert("Fill all details");
            try {
                toggleLoader(true);
                const res = await createUserWithEmailAndPassword(auth, document.getElementById('s-email').value, document.getElementById('s-pass').value);
                await setDoc(doc(db, "users", res.user.uid), {
                    name, gender, education: edu, email: res.user.email, role: res.user.email === ADMIN_EMAIL ? 'admin' : 'student', points: 0, joined: new Date().toLocaleDateString()
                });
                alert("Welcome!");
            } catch(e) { alert(e.message); toggleLoader(false); }
        }

        window.handleGoogle = async () => {
            try {
                const res = await signInWithPopup(auth, googleProvider);
                const ref = doc(db, "users", res.user.uid);
                if(!(await getDoc(ref)).exists()) {
                    await setDoc(ref, { name: res.user.displayName, email: res.user.email, gender: 'Male', education: 'Not Set', role: res.user.email === ADMIN_EMAIL ? 'admin' : 'student', points: 0, joined: new Date().toLocaleDateString() });
                }
            } catch(e) { alert(e.message); }
        }
        window.handleLogout = () => signOut(auth).then(()=>location.reload());

        // --- CORE APP LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                loadTheme();
                const snap = await getDoc(doc(db, "users", user.uid));
                currentUser = { uid: user.uid, ...snap.data() };
                document.getElementById('auth-screen').classList.remove('active-screen');
                document.getElementById('app-screen').classList.add('active-screen');
                document.getElementById('header-points').innerText = `üèÜ ${currentUser.points || 0}`;
                if(currentUser.role === 'admin') document.getElementById('admin-nav').style.display = 'block';
                renderHome();
            } else {
                document.getElementById('app-screen').classList.remove('active-screen');
                document.getElementById('auth-screen').classList.add('active-screen');
            }
            toggleLoader(false);
        });

        // --- HOME DASHBOARD ---
        window.renderHome = async () => {
            updateNav(0);
            const div = document.getElementById('main-content');
            
            // Broadcast
            const bcSnap = await getDoc(doc(db, "settings", "broadcast"));
            let bcHTML = bcSnap.exists() ? `<div style="background:linear-gradient(to right, #ff9966, #ff5e62); color:white; padding:15px; border-radius:15px; margin-bottom:20px; animation:slideUp 0.5s;"><i class="fas fa-bullhorn"></i> <b>Notice:</b> ${bcSnap.data().message}</div>` : '';

            div.innerHTML = `
                ${bcHTML}
                <div class="card" style="background:linear-gradient(135deg, var(--primary), var(--primary-dark)); color:white; border:none; padding:25px;">
                    <h3>Hello, ${currentUser.name}! üëã</h3>
                    <p style="opacity:0.9">Your journey continues here.</p>
                </div>
                
                <div class="dash-grid">
                    <div class="dash-btn" onclick="showRoutineView()"><i class="fas fa-calendar-alt" style="color:#FF9F43"></i><span>Routine</span></div>
                    <div class="dash-btn" onclick="renderLeaderboard()"><i class="fas fa-trophy" style="color:#28C76F"></i><span>Rank</span></div>
                    <div class="dash-btn" onclick="showNotesView()"><i class="fas fa-book-open" style="color:#00CFE8"></i><span>Notes</span></div>
                </div>

                <h3 style="margin-bottom:15px;">Available Exams</h3>
                <div id="exam-list">Loading...</div>
            `;
            loadExams();
        }

        async function loadExams() {
            const list = document.getElementById('exam-list');
            const snap = await getDocs(collection(db, "exams"));
            list.innerHTML = '';
            if(snap.empty) return list.innerHTML = '<p style="text-align:center; color:#999;">No active exams.</p>';
            snap.forEach(d => {
                const data = d.data();
                list.innerHTML += `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div><h4>${data.title}</h4><small>‚è± ${data.time} Min</small></div>
                        <button onclick="startExam('${d.id}', '${data.title}', ${data.time})" class="btn btn-primary" style="width:auto; margin:0; padding:8px 20px;">Start</button>
                    </div>`;
            });
        }

        // --- STUDENT FEATURES ---
        window.showRoutineView = async () => {
            openModal("Class Routine", "Loading...");
            const snap = await getDocs(collection(db, "routines"));
            let html = snap.empty ? "<p>No routine added.</p>" : "";
            snap.forEach(d => html += `<div class="list-item"><span>${d.data().title}</span><b>${d.data().time}</b></div>`);
            document.getElementById('modal-body').innerHTML = html;
        }

        window.showNotesView = async () => {
            openModal("Lecture Notes / PDF", "Loading...");
            const snap = await getDocs(collection(db, "notes"));
            let html = snap.empty ? "<p>No notes available.</p>" : "";
            snap.forEach(d => html += `<div class="list-item"><span>üìÑ ${d.data().title}</span><a href="${d.data().link}" target="_blank" style="color:var(--primary); font-weight:bold; text-decoration:none;">Download</a></div>`);
            document.getElementById('modal-body').innerHTML = html;
        }

        // --- LEADERBOARD ---
        window.renderLeaderboard = async () => {
            updateNav(1);
            document.getElementById('main-content').innerHTML = `<h3>üèÜ Leaderboard</h3><div id="lb-list" style="margin-top:15px;">Loading...</div>`;
            const snap = await getDocs(collection(db, "users"));
            let users = [];
            snap.forEach(d => users.push(d.data()));
            users.sort((a,b) => (b.points||0) - (a.points||0));
            let html = '';
            users.slice(0, 20).forEach((u, i) => {
                let color = i<3 ? '#FFD700' : 'transparent';
                html += `<div class="card" style="display:flex; align-items:center; border-left:5px solid ${color};">
                    <b style="font-size:1.2rem; margin-right:15px; width:30px;">#${i+1}</b>
                    <div style="flex:1;"><h4>${u.name}</h4><small>${u.education}</small></div>
                    <b style="color:var(--primary)">${u.points||0} pts</b>
                </div>`;
            });
            document.getElementById('lb-list').innerHTML = html;
        }

        // --- PROFILE ---
        window.renderProfile = async () => {
            updateNav(2);
            const avatarClass = currentUser.gender === 'Female' ? 'female' : 'male';
            const iconClass = currentUser.gender === 'Female' ? 'fa-female' : 'fa-male';
            
            document.getElementById('main-content').innerHTML = `
                <div class="card" style="text-align:center; margin-top:30px;">
                    <div class="avatar-container ${avatarClass}">
                        <i class="fas ${iconClass}"></i>
                        <div class="edit-badge" onclick="editProfile()"><i class="fas fa-pen"></i></div>
                    </div>
                    <h2>${currentUser.name}</h2>
                    <p>${currentUser.email}</p>
                    <div style="margin-top:10px;"><span style="background:#eee; padding:5px 10px; border-radius:10px; font-size:0.8rem;">Joined: ${currentUser.joined || 'N/A'}</span></div>
                </div>
                <h3>Exam History</h3>
                <div id="hist-list">Loading...</div>
            `;
            
            const q = query(collection(db, "results"), where("userId", "==", currentUser.uid));
            const snap = await getDocs(q);
            let html = snap.empty ? "<p style='text-align:center; color:#999'>No exams taken.</p>" : "";
            snap.forEach(d => html += `<div class="card" style="display:flex; justify-content:space-between; padding:15px;"><span>${d.data().exam}</span><b>${d.data().score}/${d.data().total}</b></div>`);
            document.getElementById('hist-list').innerHTML = html;
        }

        window.editProfile = () => {
            openModal("Edit Profile", `
                <input id="e-name" value="${currentUser.name}" placeholder="Name">
                <select id="e-gender" style="width:100%; padding:14px; margin-bottom:10px; border:1px solid #eee; border-radius:12px; background:#f9f9f9;"><option value="Male">Male</option><option value="Female">Female</option></select>
                <input id="e-edu" value="${currentUser.education}" placeholder="Education">
                <button onclick="saveProfile()" class="btn btn-primary">Save Changes</button>
            `);
            document.getElementById('e-gender').value = currentUser.gender || 'Male';
        }

        window.saveProfile = async () => {
            const n = document.getElementById('e-name').value, g = document.getElementById('e-gender').value, edu = document.getElementById('e-edu').value;
            await updateDoc(doc(db, "users", currentUser.uid), { name: n, gender: g, education: edu });
            currentUser.name = n; currentUser.gender = g; currentUser.education = edu;
            closeModal(); renderProfile();
        }

        // --- EXAM SYSTEM (FIXED SUBMIT) ---
        window.startExam = async (id, title, time) => {
            const div = document.getElementById('main-content');
            div.innerHTML = `<div id="q-area">Loading...</div>`;
            const q = query(collection(db, "questions"), where("examId", "==", id));
            const snap = await getDocs(q);
            if(snap.empty) return div.innerHTML = "No questions found.";

            let questions = [];
            snap.forEach(d => questions.push({id: d.id, ...d.data()}));
            window.currentQ = questions; window.userAns = {};

            // Exam UI
            document.getElementById('q-area').innerHTML = `
                <div style="position:sticky; top:75px; background:var(--accent); color:white; padding:10px 15px; border-radius:10px; margin-bottom:15px; z-index:90; display:flex; justify-content:space-between; box-shadow:0 5px 15px rgba(255, 101, 132, 0.4);">
                    <span>${title}</span><span id="timer" style="font-weight:bold;">00:00</span>
                </div>
                ${questions.map((d, i) => `
                    <div class="card">
                        <p style="font-weight:600; margin-bottom:10px;">${i+1}. ${d.question}</p>
                        ${d.options.map((o, idx) => `
                            <label style="display:block; padding:10px; border:1px solid #eee; margin-top:5px; border-radius:8px; cursor:pointer;">
                                <input type="radio" name="${d.id}" value="${idx+1}" onchange="window.userAns['${d.id}']=${idx+1}"> ${o}
                            </label>
                        `).join('')}
                    </div>`).join('')}
                <button onclick="submitExam('${title}')" class="btn btn-primary" style="margin-bottom:50px;">Submit Exam</button>
            `;

            let left = time*60;
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                let m = Math.floor(left/60), s = left%60;
                document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
                left--;
                if(left<0) { submitExam(title); }
            }, 1000);
        }

        window.submitExam = async (title) => {
            clearInterval(timerInterval); 
            toggleLoader(true);
            
            let score = 0, review = '';
            window.currentQ.forEach((q, i) => {
                const ans = window.userAns[q.id], correct = ans === q.correct;
                if(correct) score++;
                review += `<div class="review-box ${correct?'correct':'wrong'}"><p><b>Q${i+1}:</b> ${q.question}</p><small>Your Ans: ${ans?q.options[ans-1]:'Skipped'} ${correct?'‚úÖ':'‚ùå'}</small><br><small style="color:#00b894">${!correct?'Correct: '+q.options[q.correct-1]:''}</small></div>`;
            });

            // Update DB
            const newPoints = (currentUser.points||0) + score;
            await updateDoc(doc(db, "users", currentUser.uid), { points: newPoints });
            await addDoc(collection(db, "results"), { userId: currentUser.uid, exam: title, score, total: window.currentQ.length, date: new Date().toLocaleDateString() });
            
            currentUser.points = newPoints;
            toggleLoader(false);
            
            // Go back to Home and show Modal
            renderHome(); 
            openModal(`Result: ${score}/${window.currentQ.length}`, `<h1 style="color:var(--primary); text-align:center; font-size:3rem;">${score}</h1><div style="max-height:300px; overflow-y:auto; margin-top:10px;">${review}</div>`);
        }

        // --- ADMIN PANEL (RESTORED & IMPROVED) ---
        window.renderAdmin = () => {
            updateNav(3);
            document.getElementById('main-content').innerHTML = `
                <div class="admin-grid">
                    <div class="admin-item" onclick="admView('exam')"><i class="fas fa-file-alt"></i><h4>Exams</h4></div>
                    <div class="admin-item" onclick="admView('student')"><i class="fas fa-users"></i><h4>Students</h4></div>
                    <div class="admin-item" onclick="admView('routine')"><i class="fas fa-calendar"></i><h4>Routine</h4></div>
                    <div class="admin-item" onclick="admView('notes')"><i class="fas fa-file-pdf"></i><h4>Notes/PDF</h4></div>
                    <div class="admin-item" onclick="admView('broadcast')"><i class="fas fa-bullhorn"></i><h4>Broadcast</h4></div>
                    <div class="admin-item" onclick="admView('theme')"><i class="fas fa-palette"></i><h4>Theme</h4></div>
                </div>
                <div id="adm-area" style="margin-top:20px;"></div>
            `;
        }

        window.admView = async (mode) => {
            const area = document.getElementById('adm-area');
            area.innerHTML = '<div class="card">Loading...</div>';

            if(mode === 'exam') {
                area.innerHTML = `
                    <div class="card"><h3>Create Exam</h3><input id="nt" placeholder="Title"><input id="nm" type="number" placeholder="Time (Min)"><button onclick="addExam()" class="btn btn-primary">Create</button></div>
                    <div class="card"><h3>Manage Exams</h3><div id="el"></div></div>
                    <div class="card"><h3>Add MCQ (JSON)</h3><select id="es" style="width:100%; padding:14px; margin-bottom:10px; border:1px solid #eee; border-radius:12px; background:#fff;"></select><textarea id="jt" rows="3" style="width:100%; padding:10px; border:1px solid #eee; border-radius:12px;" placeholder='[{"q":"..","options":[".."],"correct":1}]'></textarea><button onclick="upJson()" class="btn btn-primary">Upload</button></div>`;
                const s = await getDocs(collection(db, "exams"));
                let h='', o=''; s.forEach(d=>{ h+=`<div class="list-item"><span>${d.data().title}</span><button class="del-btn" onclick="delDoc('exams','${d.id}')">Delete</button></div>`; o+=`<option value="${d.id}">${d.data().title}</option>`; });
                document.getElementById('el').innerHTML = h; document.getElementById('es').innerHTML = o;
            }
            if(mode === 'student') {
                const s = await getDocs(collection(db, "users"));
                let h=''; s.forEach(d=>{ if(d.data().role!=='admin') h+=`<div class="list-item"><div style="text-align:left;"><b>${d.data().name}</b><br><small style="color:#888">Joined: ${d.data().joined}</small></div><button class="del-btn" onclick="delDoc('users','${d.id}')">Ban</button></div>`; });
                area.innerHTML = `<div class="card"><h3>Registered Students</h3>${h}</div>`;
            }
            if(mode === 'routine') {
                area.innerHTML = `<div class="card"><h3>Add Routine</h3><input id="rt" placeholder="Title (e.g. ICT Class)"><input id="rm" placeholder="Time (e.g. 8:00 PM)"><button onclick="addRoutine()" class="btn btn-primary">Add</button></div><div class="card"><h3>Current Routine</h3><div id="rl"></div></div>`;
                const s = await getDocs(collection(db, "routines"));
                let h=''; s.forEach(d=>{ h+=`<div class="list-item"><span>${d.data().title} - ${d.data().time}</span><button class="del-btn" onclick="delDoc('routines','${d.id}')">Del</button></div>`; });
                document.getElementById('rl').innerHTML = h;
            }
            if(mode === 'notes') {
                area.innerHTML = `<div class="card"><h3>Add Note/PDF</h3><input id="pt" placeholder="Title"><input id="pl" placeholder="Link (Drive/PDF)"><button onclick="addNote()" class="btn btn-primary">Add</button></div><div class="card"><h3>Manage Notes</h3><div id="nl"></div></div>`;
                const s = await getDocs(collection(db, "notes"));
                let h=''; s.forEach(d=>{ h+=`<div class="list-item"><span>${d.data().title}</span><button class="del-btn" onclick="delDoc('notes','${d.id}')">Del</button></div>`; });
                document.getElementById('nl').innerHTML = h;
            }
            if(mode === 'broadcast') {
                area.innerHTML = `<div class="card"><h3>Broadcast Message</h3><input id="bcm" placeholder="Message"><button onclick="sendBC()" class="btn btn-primary">Send</button><button onclick="clearBC()" class="btn" style="background:#eee; color:#333; margin-top:5px;">Clear</button></div>`;
            }
            if(mode === 'theme') {
                area.innerHTML = `<div class="card"><h3>App Theme</h3><div style="display:flex; gap:10px; margin-top:10px;">
                    <div onclick="setTh('#6C63FF')" style="width:40px; height:40px; background:#6C63FF; border-radius:50%; cursor:pointer;"></div>
                    <div onclick="setTh('#00b894')" style="width:40px; height:40px; background:#00b894; border-radius:50%; cursor:pointer;"></div>
                    <div onclick="setTh('#FF6584')" style="width:40px; height:40px; background:#FF6584; border-radius:50%; cursor:pointer;"></div>
                    <div onclick="setTh('#2d3436')" style="width:40px; height:40px; background:#2d3436; border-radius:50%; cursor:pointer;"></div>
                    <div onclick="setTh('#0984e3')" style="width:40px; height:40px; background:#0984e3; border-radius:50%; cursor:pointer;"></div>
                </div></div>`;
            }
        }

        // Admin Functions
        window.addExam = async () => { await addDoc(collection(db, "exams"), {title:document.getElementById('nt').value, time:parseInt(document.getElementById('nm').value)}); alert("Done"); admView('exam'); }
        window.upJson = async () => { try { const d=JSON.parse(document.getElementById('jt').value); for(const q of d) await addDoc(collection(db,"questions"),{examId:document.getElementById('es').value, ...q}); alert("Done"); } catch(e){alert("Error");} }
        window.addRoutine = async () => { await addDoc(collection(db, "routines"), {title:document.getElementById('rt').value, time:document.getElementById('rm').value}); alert("Added"); admView('routine'); }
        window.addNote = async () => { await addDoc(collection(db, "notes"), {title:document.getElementById('pt').value, link:document.getElementById('pl').value}); alert("Added"); admView('notes'); }
        window.delDoc = async (c, id) => { if(confirm("Sure?")) { await deleteDoc(doc(db, c, id)); alert("Deleted"); admView(c==='users'?'student':c==='exams'?'exam':c.slice(0,-1)); } }
        window.sendBC = async () => { await setDoc(doc(db, "settings", "broadcast"), {message: document.getElementById('bcm').value}); alert("Sent"); }
        window.clearBC = async () => { await deleteDoc(doc(db, "settings", "broadcast")); alert("Cleared"); }
        window.setTh = async (c) => { await setDoc(doc(db,"settings","theme"),{color:c}); document.documentElement.style.setProperty('--primary', c); alert("Theme Set"); }

        // --- UTILS ---
        async function loadTheme() {
            const s = await getDoc(doc(db, "settings", "theme"));
            if(s.exists()) document.documentElement.style.setProperty('--primary', s.data().color);
        }
        function updateNav(i) { document.querySelectorAll('.nav-item').forEach((n,x)=> n.classList.toggle('active', i===x)); }
        function openModal(t, b) { document.getElementById('modal-title').innerText = t; document.getElementById('modal-body').innerHTML = b; document.getElementById('generic-modal').style.display = 'flex'; }
        window.closeModal = () => document.getElementById('generic-modal').style.display = 'none';
        function toggleLoader(s) { document.getElementById('loader').style.display = s?'flex':'none'; }

    </script>
</body>
</html>
