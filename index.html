<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExamPro Final</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --primary: #6C63FF; --primary-dark: #5a52d5;
            --bg: #F4F7F6; --card-bg: #ffffff;
            --text: #2d3436; --text-sec: #636e72;
            --border: #eeeeee; --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --radius: 16px;
        }
        .dark-mode {
            --bg: #1e1e2e; --card-bg: #27293d;
            --text: #e0e0e0; --text-sec: #a0a0a0;
            --border: #444444; --shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Hind Siliguri', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 90px; transition: 0.3s; -webkit-tap-highlight-color: transparent; }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 0% { transform: scale(0.95); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* GLOBAL STYLES */
        .screen { display: none; min-height: 100vh; animation: fadeIn 0.4s ease; }
        .active-screen { display: block; }
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        
        /* PREMIUM CARDS & INPUTS */
        .card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); margin-bottom: 15px; box-shadow: var(--shadow); position: relative; border: 1px solid var(--border); }
        
        input, select, textarea {
            width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 12px;
            background: var(--card-bg); color: var(--text); font-size: 1rem; margin-bottom: 10px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3); }
        .btn-danger { background: #ff4757; color: white; }
        .btn:active { transform: scale(0.98); }

        /* HEADER */
        header { background: var(--card-bg); padding: 15px 20px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); }

        /* MCQ PREMIUM UI (NEW) */
        .mcq-option {
            display: flex; align-items: center; padding: 15px; 
            border: 2px solid var(--border); border-radius: 12px; 
            margin-bottom: 10px; cursor: pointer; transition: 0.2s;
        }
        .mcq-option.selected { border-color: var(--primary); background: rgba(108, 99, 255, 0.05); animation: pop 0.2s; }
        .mcq-circle {
            height: 20px; width: 20px; border: 2px solid #ccc; border-radius: 50%; 
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
        }
        .mcq-option.selected .mcq-circle { border-color: var(--primary); }
        .mcq-option.selected .mcq-circle::after {
            content: ''; width: 10px; height: 10px; background: var(--primary); border-radius: 50%;
        }

        /* ADMIN CARDS (NEW) */
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .admin-item { background: var(--card-bg); padding: 25px; border-radius: 18px; text-align: center; box-shadow: var(--shadow); cursor: pointer; border-bottom: 4px solid var(--primary); }
        
        .student-card { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .student-card:hover { background: rgba(0,0,0,0.02); }
        .student-avatar { width: 45px; height: 45px; border-radius: 50%; background: #eee; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid var(--border); z-index: 1000; }
        .nav-item { text-align: center; color: #aaa; font-size: 0.75rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 3px; }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; max-height: 85vh; overflow-y: auto; animation: fadeIn 0.3s; }
        
        /* CUSTOM ALERT */
        #custom-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: var(--card-bg); padding: 25px; width: 85%; max-width: 350px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; z-index: 10000; display: none; border: 1px solid var(--border); }

        #loader { position: fixed; inset: 0; background: var(--card-bg); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>
    
    <div id="custom-alert">
        <h2 style="color:var(--primary); margin-bottom:10px;">ExamPro</h2>
        <p id="alert-msg" style="color:var(--text-sec); margin-bottom:20px;">Message</p>
        <button onclick="closeAlert()" class="btn btn-primary">OK</button>
    </div>

    <section id="auth-screen" class="screen">
        <div style="min-height:100vh; display:flex; justify-content:center; align-items:center; background:linear-gradient(135deg, var(--primary), #8f94fb); padding:20px;">
            <div class="card" style="width:100%; max-width:400px; text-align:center;">
                <h1 style="color:var(--primary); font-size:2.5rem;">ExamPro</h1>
                <p style="color:#888; margin-bottom:30px;">Login to continue</p>
                
                <div id="login-form">
                    <input type="email" id="l-email" placeholder="Email">
                    <input type="password" id="l-pass" placeholder="Password">
                    <button onclick="handleLogin()" class="btn btn-primary">Log In</button>
                    <p style="margin-top:15px; font-size:0.9rem;">New? <b onclick="toggleAuth('signup')" style="color:var(--primary); cursor:pointer;">Register</b></p>
                </div>

                <div id="signup-form" style="display:none;">
                    <input type="text" id="s-name" placeholder="Full Name">
                    <select id="s-gender"><option value="">Gender</option><option value="Male">Male</option><option value="Female">Female</option></select>
                    <input type="text" id="s-edu" placeholder="Education">
                    <input type="email" id="s-email" placeholder="Email">
                    <input type="password" id="s-pass" placeholder="Password">
                    <button onclick="handleSignup()" class="btn btn-primary">Sign Up</button>
                    <p style="margin-top:15px; font-size:0.9rem;">Has account? <b onclick="toggleAuth('login')" style="color:var(--primary); cursor:pointer;">Log In</b></p>
                </div>
                
                <div style="margin:20px 0; border-top:1px solid var(--border);"></div>
                <button onclick="handleGoogle()" class="btn" style="background:white; border:1px solid #ddd; color:#333;"><i class="fab fa-google" style="color:#EA4335"></i> Google Login</button>
            </div>
        </div>
    </section>

    <section id="app-screen" class="screen">
        <header>
            <div class="logo">ExamPro</div>
            <div style="display:flex; gap:15px; align-items:center;">
                <i onclick="toggleTheme()" id="theme-icon" class="fas fa-moon" style="font-size:1.4rem; cursor:pointer;"></i>
                <i onclick="handleLogout()" class="fas fa-power-off" style="color:#ff4757; font-size:1.4rem; cursor:pointer;"></i>
            </div>
        </header>

        <div id="main-content" class="container"></div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="renderHome()"><i class="fas fa-home"></i> <span>Home</span></div>
            <div class="nav-item" onclick="renderLeaderboard()"><i class="fas fa-trophy"></i> <span>Rank</span></div>
            <div class="nav-item" onclick="renderProfile()"><i class="fas fa-user"></i> <span>Profile</span></div>
            <div class="nav-item" id="admin-nav" style="display:none;" onclick="renderAdmin()"><i class="fas fa-th-large"></i> <span>Admin</span></div>
        </nav>
    </section>

    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom:20px; color:var(--primary);">Title</h2>
            <div id="modal-body"></div>
            <button onclick="closeModal()" class="btn" style="background:#eee; color:#333; margin-top:20px;">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBW0-UiTB83ikUOztrT6ECAkOlnzxykKYQ",
            authDomain: "mcq-exam-b150e.firebaseapp.com",
            projectId: "mcq-exam-b150e",
            storageBucket: "mcq-exam-b150e.firebasestorage.app",
            messagingSenderId: "751727102033",
            appId: "1:751727102033:web:35995f15619e300872d070",
            measurementId: "G-9NS51NRGER"
        };
        const ADMIN_EMAIL = "mdwld2005@gmail.com";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUser = null;
        let timerInterval;
        let allStudents = []; // Cache for search

        // UTILS
        window.showMsg = (m) => { document.getElementById('alert-msg').innerText = m; document.getElementById('custom-alert').style.display='block'; }
        window.closeAlert = () => document.getElementById('custom-alert').style.display='none';
        window.toggleTheme = () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark?'dark':'light');
            document.getElementById('theme-icon').className = isDark?'fas fa-sun':'fas fa-moon';
        }
        if(localStorage.getItem('theme')==='dark') { document.body.classList.add('dark-mode'); document.getElementById('theme-icon').className='fas fa-sun'; }
        function openModal(t,b) { document.getElementById('modal-title').innerText=t; document.getElementById('modal-body').innerHTML=b; document.getElementById('generic-modal').style.display='flex'; }
        window.closeModal = () => document.getElementById('generic-modal').style.display='none';
        function toggleLoader(s) { document.getElementById('loader').style.display=s?'flex':'none'; }
        function updateNav(i) { document.querySelectorAll('.nav-item').forEach((n,x)=> n.classList.toggle('active', i===x)); }

        // AUTH
        window.toggleAuth = (m) => { document.getElementById('login-form').style.display=m==='login'?'block':'none'; document.getElementById('signup-form').style.display=m==='signup'?'block':'none'; }
        window.handleLogin = async () => { try { toggleLoader(true); await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value); } catch(e){ showMsg(e.message); toggleLoader(false); } }
        window.handleSignup = async () => { 
            const n=document.getElementById('s-name').value, g=document.getElementById('s-gender').value, edu=document.getElementById('s-edu').value;
            if(!n || !g) return showMsg("Fill details");
            try { toggleLoader(true); const r=await createUserWithEmailAndPassword(auth, document.getElementById('s-email').value, document.getElementById('s-pass').value); 
            await setDoc(doc(db,"users",r.user.uid), { name:n, gender:g, education:edu, email:r.user.email, role:'student', points:0, joined:new Date().toLocaleDateString() }); showMsg("Success!"); } catch(e){ showMsg(e.message); toggleLoader(false); } 
        }
        window.handleGoogle = async () => { try { const r=await signInWithPopup(auth, googleProvider); const ref=doc(db,"users",r.user.uid); if(!(await getDoc(ref)).exists()) await setDoc(ref,{name:r.user.displayName, email:r.user.email, gender:'Male', education:'Not Set', role:'student', points:0, joined:new Date().toLocaleDateString()}); } catch(e){ showMsg(e.message); } }
        window.handleLogout = () => signOut(auth).then(()=>location.reload());

        // MAIN LOGIC
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                const s = await getDoc(doc(db, "users", user.uid));
                if(!s.exists()) { signOut(auth); return showMsg("Account Deleted"); }
                currentUser = { uid: user.uid, ...s.data() };
                loadTheme();
                document.getElementById('auth-screen').classList.remove('active-screen');
                document.getElementById('app-screen').classList.add('active-screen');
                if(currentUser.role==='admin') document.getElementById('admin-nav').style.display='block';
                renderHome();
            } else {
                document.getElementById('app-screen').classList.remove('active-screen');
                document.getElementById('auth-screen').classList.add('active-screen');
            }
            toggleLoader(false);
        });

        // HOME
        window.renderHome = async () => {
            updateNav(0);
            const bc = await getDoc(doc(db,"settings","broadcast"));
            document.getElementById('main-content').innerHTML = `
                ${bc.exists()?`<div class="card" style="background:linear-gradient(to right,#ff9966,#ff5e62); color:white; padding:15px; margin-bottom:15px;">üì¢ ${bc.data().message}</div>`:''}
                <div class="card" style="background:linear-gradient(135deg, var(--primary), #8f94fb); color:white; border:none; padding:30px;">
                    <h2>Hi, ${currentUser.name}! üëã</h2><p style="opacity:0.9">Points: <b>${currentUser.points||0}</b></p>
                </div>
                <div class="dash-grid">
                    <div class="dash-btn" onclick="viewRoutine()"><i class="fas fa-calendar" style="color:#FF9F43"></i><span>Routine</span></div>
                    <div class="dash-btn" onclick="renderLeaderboard()"><i class="fas fa-trophy" style="color:#28C76F"></i><span>Rank</span></div>
                    <div class="dash-btn" onclick="viewNotes()"><i class="fas fa-book" style="color:#00CFE8"></i><span>Notes</span></div>
                </div>
                <h3>Live Exams</h3><div id="exam-list">Loading...</div>
            `;
            const s = await getDocs(collection(db, "exams"));
            const l = document.getElementById('exam-list'); l.innerHTML='';
            if(s.empty) return l.innerHTML='<p style="text-align:center; color:gray">No exams.</p>';
            s.forEach(d => l.innerHTML+=`<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><div><h4>${d.data().title}</h4><small>${d.data().time} Min</small></div><button class="btn btn-primary" style="width:auto; padding:10px 20px; margin:0;" onclick="startExam('${d.id}','${d.data().title}',${d.data().time})">Start</button></div>`);
        }

        // EXAM SYSTEM (NEW UI)
        window.startExam = async (id, title, time) => {
            const div = document.getElementById('main-content');
            div.innerHTML = `<div id="q-area">Loading...</div>`;
            const s = await getDocs(query(collection(db, "questions"), where("examId", "==", id)));
            if(s.empty) return div.innerHTML = "No questions.";
            
            let qs=[]; s.forEach(d=>qs.push({id:d.id, ...d.data()}));
            window.currentQ = qs; window.userAns = {};

            document.getElementById('q-area').innerHTML = `
                <div style="position:sticky; top:75px; background:var(--primary); color:white; padding:15px; border-radius:15px; margin-bottom:20px; z-index:90; display:flex; justify-content:space-between;"><b>${title}</b><span id="timer">00:00</span></div>
                ${qs.map((d, i) => `
                    <div class="card">
                        <p style="font-weight:600; margin-bottom:15px; font-size:1.1rem;">${i+1}. ${d.question}</p>
                        ${d.options.map((o, idx) => `
                            <div class="mcq-option" id="opt-${d.id}-${idx+1}" onclick="selectOption('${d.id}', ${idx+1})">
                                <div class="mcq-circle"></div> <span>${o}</span>
                            </div>
                        `).join('')}
                    </div>`).join('')}
                <button onclick="submitExam('${title}')" class="btn btn-primary" style="margin-bottom:50px;">Submit Exam</button>
            `;

            let left = time*60;
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                let m=Math.floor(left/60), s=left%60; document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
                left--; if(left<0) submitExam(title);
            }, 1000);
        }

        window.selectOption = (qid, val) => {
            window.userAns[qid] = val;
            // Visual Update
            for(let i=1; i<=4; i++) {
                const el = document.getElementById(`opt-${qid}-${i}`);
                if(el) el.classList.remove('selected');
            }
            const sel = document.getElementById(`opt-${qid}-${val}`);
            if(sel) sel.classList.add('selected');
        }

        window.submitExam = async (title) => {
            clearInterval(timerInterval); toggleLoader(true);
            let score=0, review='';
            window.currentQ.forEach((q, i) => {
                const ans = window.userAns[q.id], correct = ans === q.correct;
                if(correct) score++;
                review += `<div class="card" style="border-left:5px solid ${correct?'#00b894':'#ff7675'}; padding:15px;"><p><b>Q${i+1}:</b> ${q.question}</p><p>Your Ans: <b>${ans?q.options[ans-1]:'Skipped'}</b> ${correct?'‚úÖ':'‚ùå'}</p>${!correct?`<p style="color:#00b894">Correct: ${q.options[q.correct-1]}</p>`:''}</div>`;
            });
            const np = (currentUser.points||0)+score;
            await updateDoc(doc(db,"users",currentUser.uid),{points:np});
            await addDoc(collection(db,"results"),{userId:currentUser.uid, exam:title, score, total:window.currentQ.length, date:new Date().toLocaleDateString()});
            currentUser.points = np;
            renderHome();
            openModal(`Result: ${score}/${window.currentQ.length}`, `<h1 style="text-align:center; color:var(--primary); font-size:3rem;">${score}</h1>${review}`);
            toggleLoader(false);
        }

        // ADMIN PANEL
        window.renderAdmin = () => {
            updateNav(3);
            document.getElementById('main-content').innerHTML = `
                <div class="admin-grid">
                    <div class="admin-item" onclick="admView('exam')"><i class="fas fa-file-alt"></i><h4>Exams</h4></div>
                    <div class="admin-item" onclick="admView('student')"><i class="fas fa-users"></i><h4>Students</h4></div>
                    <div class="admin-item" onclick="admView('routine')"><i class="fas fa-calendar"></i><h4>Routine</h4></div>
                    <div class="admin-item" onclick="admView('notes')"><i class="fas fa-file-pdf"></i><h4>Notes</h4></div>
                    <div class="admin-item" onclick="admView('broadcast')"><i class="fas fa-bullhorn"></i><h4>Broadcast</h4></div>
                    <div class="admin-item" onclick="admView('settings')"><i class="fas fa-cogs"></i><h4>Settings</h4></div>
                </div><div id="adm-area" style="margin-top:20px;"></div>
            `;
        }

        window.admView = async (m) => {
            const a = document.getElementById('adm-area'); a.innerHTML='<div class="card">Loading...</div>';
            if(m==='exam') {
                a.innerHTML = `
                    <div class="card"><h3>Create Exam</h3><input id="nt" placeholder="Title"><input id="nm" type="number" placeholder="Time (Min)"><button onclick="addExam()" class="btn btn-primary">Create</button></div>
                    <div class="card"><h3>Manage Exams</h3><div id="el"></div></div>
                    <div class="card"><h3>Add MCQ (JSON)</h3><div style="display:flex; gap:10px;"><select id="es"></select><button onclick="copyFormat()" class="btn btn-sec" style="width:auto; margin:0 0 10px 0;">Copy Format</button></div><textarea id="jt" rows="4" placeholder="Paste JSON here..."></textarea><button onclick="upJson()" class="btn btn-primary">Upload</button></div>`;
                const s = await getDocs(collection(db, "exams")); let h='', o=''; 
                s.forEach(d=>{ h+=`<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><b>${d.data().title}</b><button class="btn btn-danger" style="width:auto; padding:8px;" onclick="delDoc('exams','${d.id}')"><i class="fas fa-trash"></i></button></div>`; o+=`<option value="${d.id}">${d.data().title}</option>`; });
                document.getElementById('el').innerHTML = h||"<p>No exams</p>"; document.getElementById('es').innerHTML = o;
            }
            if(m==='student') {
                const s = await getDocs(collection(db, "users")); allStudents = [];
                s.forEach(d => { if(d.data().role!=='admin') allStudents.push({id:d.id, ...d.data()}) });
                a.innerHTML = `<div class="card"><h3>Students</h3><input id="st-search" placeholder="Search Name/Email..." onkeyup="filterStudents()"></div><div id="sl"></div>`;
                renderStudentList(allStudents);
            }
            // Other admin views remain similar but with card styles
            if(m==='routine') { a.innerHTML=`<div class="card"><h3>Add Routine</h3><input id="rt" placeholder="Title"><input id="rm" placeholder="Time"><button onclick="addRt()" class="btn btn-primary">Add</button></div><div id="rl"></div>`; loadList('routines','rl'); }
            if(m==='notes') { a.innerHTML=`<div class="card"><h3>Add Note</h3><input id="pt" placeholder="Title"><input id="pl" placeholder="Link"><button onclick="addNt()" class="btn btn-primary">Add</button></div><div id="nl"></div>`; loadList('notes','nl'); }
            if(m==='broadcast') { a.innerHTML=`<div class="card"><h3>Broadcast</h3><textarea id="bcm" placeholder="Message"></textarea><button onclick="sendBc()" class="btn btn-primary">Send</button><button onclick="clrBc()" class="btn btn-sec">Clear</button></div>`; }
            if(m==='settings') { a.innerHTML=`<div class="card"><h3>Actions</h3><button onclick="resetLb()" class="btn btn-danger">Reset Ranks</button><div style="margin-top:15px;"><input id="adm-mail" placeholder="User Email"><button onclick="mkAdmin()" class="btn btn-primary">Make Admin</button></div></div>`; }
        }

        window.renderStudentList = (list) => {
            const div = document.getElementById('sl'); div.innerHTML='';
            list.forEach(u => div.innerHTML += `
                <div class="card student-card" onclick="viewUser('${u.id}')">
                    <div class="student-avatar">${u.name.charAt(0)}</div>
                    <div style="flex:1;"><b>${u.name}</b><br><small>${u.email}</small></div>
                </div>`);
        }
        window.filterStudents = () => {
            const q = document.getElementById('st-search').value.toLowerCase();
            const f = allStudents.filter(u => u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q));
            renderStudentList(f);
        }
        window.viewUser = async (uid) => {
            const u = await getDoc(doc(db,"users",uid));
            const r = await getDocs(query(collection(db,"results"), where("userId","==",uid)));
            let h = ""; r.forEach(d => h += `<div><b>${d.data().exam}</b>: ${d.data().score}/${d.data().total}</div>`);
            openModal("Student Details", `
                <h3>${u.data().name}</h3><p>${u.data().email}</p><p>Joined: ${u.data().joined}</p><p>Edu: ${u.data().education}</p>
                <button onclick="delDoc('users','${uid}')" class="btn btn-danger" style="margin-bottom:15px;">Ban User</button>
                <hr><h4>History</h4>${h||"No exams"}
            `);
        }

        // OTHER FUNCTIONS
        window.loadList = async (c, id) => {
            const s = await getDocs(collection(db, c)); let h='';
            s.forEach(d => h+=`<div class="card" style="display:flex; justify-content:space-between;"><span>${d.data().title}</span><button class="btn btn-danger" style="width:auto; padding:5px 10px;" onclick="delDoc('${c}','${d.id}')"><i class="fas fa-trash"></i></button></div>`);
            document.getElementById(id).innerHTML = h;
        }
        window.addExam = async () => { await addDoc(collection(db,"exams"),{title:document.getElementById('nt').value, time:parseInt(document.getElementById('nm').value)}); showMsg("Created"); admView('exam'); }
        window.upJson = async () => { try { const d=JSON.parse(document.getElementById('jt').value); for(const q of d) await addDoc(collection(db,"questions"),{examId:document.getElementById('es').value, ...q}); showMsg("Uploaded"); } catch(e){showMsg("JSON Error");} }
        window.copyFormat = () => { navigator.clipboard.writeText(`[{"question":"Q?","options":["A","B","C","D"],"correct":1}]`); showMsg("Copied!"); }
        window.addRt = async () => { await addDoc(collection(db,"routines"),{title:document.getElementById('rt').value, time:document.getElementById('rm').value}); showMsg("Added"); admView('routine'); }
        window.addNt = async () => { await addDoc(collection(db,"notes"),{title:document.getElementById('pt').value, link:document.getElementById('pl').value}); showMsg("Added"); admView('notes'); }
        window.delDoc = async (c, id) => { if(confirm("Delete?")) { await deleteDoc(doc(db,c,id)); showMsg("Deleted"); admView(c==='users'?'student':c==='exams'?'exam':c.slice(0,-1)); } }
        window.sendBc = async () => { await setDoc(doc(db,"settings","broadcast"),{message:document.getElementById('bcm').value}); showMsg("Sent"); }
        window.clrBc = async () => { await deleteDoc(doc(db,"settings","broadcast")); showMsg("Cleared"); }
        window.resetLb = async () => { if(confirm("Reset Ranks?")) { const s=await getDocs(collection(db,"users")); s.forEach(d=>updateDoc(d.ref,{points:0})); showMsg("Reset Done"); } }
        window.mkAdmin = async () => { const q=query(collection(db,"users"), where("email","==",document.getElementById('adm-mail').value)); const s=await getDocs(q); if(s.empty) return showMsg("Not found"); s.forEach(d=>updateDoc(d.ref,{role:'admin'})); showMsg("Admin Added"); }

        // RENDERS
        window.renderProfile = async () => { updateNav(2); document.getElementById('main-content').innerHTML = `<h3>Profile</h3><div class="card" style="text-align:center;"><div class="avatar ${currentUser.gender==='Female'?'female':'male'}"><i class="fas ${currentUser.gender==='Female'?'fa-female':'fa-male'}"></i></div><h2>${currentUser.name}</h2><p>${currentUser.email}</p><button onclick="editPro()" class="btn btn-primary">Edit</button><button onclick="clrHist()" class="btn btn-danger">Clear History</button></div>`; }
        window.editPro = () => openModal("Edit", `<input id="en" value="${currentUser.name}"><button onclick="savePro()" class="btn btn-primary">Save</button>`);
        window.savePro = async () => { const n=document.getElementById('en').value; await updateDoc(doc(db,"users",currentUser.uid),{name:n}); currentUser.name=n; closeModal(); renderProfile(); }
        window.clrHist = async () => { if(confirm("Clear?")) { const s=await getDocs(query(collection(db,"results"),where("userId","==",currentUser.uid))); s.forEach(d=>deleteDoc(d.ref)); showMsg("Cleared"); renderProfile(); } }
        window.renderLeaderboard = async () => { updateNav(1); document.getElementById('main-content').innerHTML='<h3>Rank</h3><div id="lb"></div>'; const s=await getDocs(collection(db,"users")); let u=[]; s.forEach(d=>u.push(d.data())); u.sort((a,b)=>(b.points||0)-(a.points||0)); u.slice(0,20).forEach((x,i)=>{ document.getElementById('lb').innerHTML+=`<div class="card" style="display:flex; justify-content:space-between; border-left:5px solid ${i<3?'#FFD700':'transparent'}"><b>#${i+1} ${x.name}</b><span>${x.points||0} pts</span></div>`; }); }
        
        async function loadServerTheme() { const s=await getDoc(doc(db,"settings","theme")); if(s.exists()) document.documentElement.style.setProperty('--primary', s.data().color); }
        window.viewRoutine = showRoutineView; window.viewNotes = showNotesView; // Shortcuts for home
    </script>
</body>
</html>
