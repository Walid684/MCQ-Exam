<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExamPro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #6C63FF;
            --primary-dark: #5a52d5; 
            --primary-light: #6c63ff26;
            --bg: #F4F7F6;
            --card-bg: #ffffff;
            --text: #2d3436;
            --text-sec: #636e72;
            --border: #eeeeee;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --radius: 18px;
            --danger: #ff4757;
            --success: #2ecc71;
            --white: #ffffff;
            --warning: #ffa502;
            --live-color: #ff3838;
            --medium: #f39c12;
        }

        .dark-mode {
            --bg: #1e1e2e;
            --card-bg: #27293d;
            --text: #e0e0e0;
            --text-sec: #a0a0a0;
            --border: #444444;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
            --primary-light: #6c63ff4d;
            --live-color: #ff6b6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Hind Siliguri', sans-serif; }
        body { 
            background: var(--bg); color: var(--text); padding-bottom: 90px; 
            transition: background 0.3s, color 0.3s; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: contain;
        }
        
        /* UTILS */
        .screen { display: none; min-height: 100vh; animation: fadeIn 0.4s ease; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        /* SPLASH SCREEN STYLES */
        #splash-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease-out;
        }
        .splash-logo-container {
            position: relative; width: 120px; height: 120px;
        }
        .splash-logo {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: pulseLogo 2s infinite ease-in-out;
            border: 4px solid var(--primary);
        }
        .splash-text {
            margin-top: 20px; font-size: 1.5rem; font-weight: 700; color: var(--primary);
            animation: fadeInUp 1s ease forwards; opacity: 0;
        }
        @keyframes pulseLogo {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108, 99, 255, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(108, 99, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108, 99, 255, 0); }
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* NETWORK STATUS POPUP */
        #network-status {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: var(--danger); color: white; text-align: center; 
            padding: 12px; z-index: 100000; display: none;
            font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* INPUTS */
        input, select, textarea {
            width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 15px;
            background: var(--card-bg); color: var(--text); font-size: 1rem; margin-bottom: 12px;
            outline: none; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15); }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 15px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-top: 5px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(0,0,0, 0.2); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sec { background: var(--border); color: var(--text); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn:active { transform: scale(0.98); }

        /* HEADER */
        header { 
            background: var(--primary);
            padding: 30px 15px 15px 20px;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            transition: background 0.3s ease;
        }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--white) !important; }
        #theme-icon { color: var(--white) !important; opacity: 0.9; }
        
        /* CARDS */
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        
        /* NOTIFICATION SLIDER */
        .news-slider { width: 100%; overflow: hidden; margin-bottom: 15px; display: none; }
        .news-track { display: flex; gap: 10px; animation: slideLeft 15s linear infinite; }
        .news-item {
            background: var(--card-bg); padding: 10px 15px; border-radius: 50px;
            white-space: nowrap; border: 1px solid var(--primary); color: var(--primary);
            font-size: 0.9rem; font-weight: 500; box-shadow: var(--shadow);
            display: flex; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .news-item.new-notification {
            animation: pulseNotification 2s infinite;
            background: linear-gradient(45deg, var(--primary), #8f94fb);
            color: white;
            border: none;
        }
        @keyframes slideLeft { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes pulseNotification {
            0% { box-shadow: 0 0 0 0 rgba(108, 99, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(108, 99, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(108, 99, 255, 0); }
        }

        /* NOTIFICATION POPUP - UPDATED */
        .notification-popup {
            position: fixed; top: 70px; right: 20px;
            background: var(--card-bg); padding: 15px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 10000;
            display: none; width: 320px; border-left: 5px solid var(--primary);
            animation: slideInRight 0.3s ease;
            border: 1px solid var(--border);
            max-height: 400px; overflow-y: auto;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
        .notification-item {
            padding: 10px; border-radius: 10px; margin-bottom: 8px;
            background: var(--bg); border-left: 3px solid var(--primary);
            font-size: 0.85rem; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .notification-item.unread { background: var(--primary-light); font-weight: 500; }
        .notification-delete {
            background: transparent; border: none; color: var(--danger);
            cursor: pointer; font-size: 1rem; margin-left: 10px;
            width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: 0.2s;
        }
        .notification-delete:hover { background: rgba(255, 71, 87, 0.1); }
        .notification-clear-all {
            width: 100%; margin-top: 10px; padding: 10px;
            background: var(--danger); color: white; border-radius: 10px;
            border: none; cursor: pointer; font-weight: 600;
        }

        /* MCQ STYLES */
        .mcq-anim { animation: slideUp 0.5s ease forwards; opacity: 0; }
        .mcq-option {
            display: flex; align-items: center; padding: 15px; margin-top: 10px;
            border: 2px solid var(--border); border-radius: 12px; cursor: pointer;
            transition: all 0.2s; background: var(--card-bg);
        }
        .mcq-option:hover { border-color: var(--primary); background: var(--bg); transform: translateX(5px); }
        .mcq-option.selected { border-color: var(--primary); background: var(--primary-light); font-weight: 600; }
        .mcq-circle {
            height: 20px; width: 20px; border: 2px solid var(--text-sec); border-radius: 50%;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
        }
        .mcq-option.selected .mcq-circle { border-color: var(--primary); background: var(--primary); }
        .mcq-option.selected .mcq-circle::after { content: ''; width: 8px; height: 8px; background: white; border-radius: 50%; }

        /* RESULT CARD COLOR BASED ON PERCENTAGE */
        .result-card-green {
            border-left: 5px solid var(--success) !important;
            background: linear-gradient(90deg, rgba(46, 204, 113, 0.1), transparent) !important;
        }
        .result-card-red {
            border-left: 5px solid var(--danger) !important;
            background: linear-gradient(90deg, rgba(255, 71, 87, 0.1), transparent) !important;
        }
        .result-card-medium {
            border-left: 5px solid var(--medium) !important;
            background: linear-gradient(90deg, rgba(243, 156, 18, 0.1), transparent) !important;
        }

        /* CURRENT USER HIGHLIGHT IN LEADERBOARD */
        .current-user-card {
            border: 3px solid var(--primary) !important;
            background: linear-gradient(135deg, rgba(108, 99, 255, 0.15), transparent) !important;
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(108, 99, 255, 0.2) !important;
            position: relative;
            overflow: hidden;
        }
        .current-user-card::before {
            content: 'YOU';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            font-size: 0.6rem;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            z-index: 1;
        }

        /* GRID CARDS */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 10px; }
        .mini-card {
            background: var(--card-bg); padding: 15px; border-radius: 15px;
            box-shadow: var(--shadow); text-align: center; cursor: pointer;
            border: 1px solid var(--border); transition: 0.2s; position: relative; overflow: hidden;
        }
        .mini-card:active { transform: scale(0.95); }
        .mini-card img { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; border: 2px solid var(--border); }
        .mini-card h4 { font-size: 0.9rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-card small { font-size: 0.75rem; color: var(--text-sec); }
        .banned-badge { position: absolute; top: 0; right: 0; background: var(--danger); color: white; font-size: 0.6rem; padding: 2px 8px; border-bottom-left-radius: 10px; }

        /* DASHBOARD & ADMIN */
        .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
        .dash-btn { background: var(--card-bg); padding: 20px 10px; border-radius: 18px; text-align: center; box-shadow: var(--shadow); cursor: pointer; border: 1px solid var(--border); }
        
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .admin-item { background: var(--card-bg); padding: 20px; border-radius: 18px; text-align: center; box-shadow: var(--shadow); cursor: pointer; border-bottom: 4px solid var(--primary); }
        .admin-item i { font-size: 1.8rem; color: var(--primary); margin-bottom: 10px; }

        /* LEVEL BADGE */
        .level-badge {
            display: inline-block; padding: 3px 10px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 600; margin-left: 5px;
            background: linear-gradient(45deg, var(--primary), #8f94fb);
            color: white;
        }

        /* LIVE BADGE */
        .live-badge {
            position: absolute; top: 10px; right: 10px;
            background: var(--live-color); color: white; font-size: 0.6rem;
            padding: 3px 8px; border-radius: 10px; animation: pulseLive 1.5s infinite;
            display: flex; align-items: center; gap: 3px;
        }
        @keyframes pulseLive {
            0% { box-shadow: 0 0 0 0 rgba(255, 56, 56, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(255, 56, 56, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 56, 56, 0); }
        }

        /* THEME SLIDER */
        .theme-slider-container { margin-top: 20px; padding: 10px; background: var(--bg); border-radius: 15px; }
        input[type=range].thermo { -webkit-appearance: none; width: 100%; margin: 10px 0; background: transparent; }
        input[type=range].thermo::-webkit-slider-runnable-track {
            width: 100%; height: 12px; cursor: pointer;
            background: linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            border-radius: 10px; border: 1px solid #ddd;
        }
        input[type=range].thermo::-webkit-slider-thumb {
            height: 25px; width: 25px; border-radius: 50%; background: #ffffff;
            cursor: pointer; -webkit-appearance: none; margin-top: -7px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 3px solid var(--text);
        }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; border-top: 1px solid var(--border); }
        .nav-item { text-align: center; color: #aaa; font-size: 0.7rem; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { font-size: 1.3rem; margin-bottom: 3px; display: block; }

        /* MODAL & ALERT */
        #custom-alert {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: var(--card-bg); padding: 25px; width: 90%; max-width: 350px;
            border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center; z-index: 10000; display: none; transition: 0.3s; border: 1px solid var(--border);
        }
        #custom-alert.show { display: block; animation: popIn 0.3s forwards; }
        @keyframes popIn { to { transform: translate(-50%, -50%) scale(1); } }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }

        /* FIXED POPUP CENTER */
        #confirm-modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 110000;
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
        }

        #confirm-modal.active {
            display: flex !important;
        }

        .confirm-box {
            background: var(--card-bg); 
            width: 90%; 
            max-width: 320px; 
            padding: 25px;
            border-radius: 20px; 
            text-align: center; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .confirm-icon { font-size: 3rem; color: var(--danger); margin-bottom: 15px; }
        .confirm-btns { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }

        /* PULL TO REFRESH INDICATOR */
        #refresh-indicator {
            position: fixed; top: -50px; left: 50%; transform: translateX(-50%);
            background: var(--card-bg); padding: 10px; border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 9999;
            transition: top 0.3s;
            display: flex; justify-content: center; align-items: center;
            width: 40px; height: 40px; color: var(--primary);
        }

        /* SMALL SPINNER FOR API */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* SHARE MODAL */
        .share-options {
            display: flex; flex-direction: column; gap: 10px; margin-top: 15px;
        }
        .share-option-btn {
            display: flex; align-items: center; gap: 10px;
            padding: 15px; border-radius: 12px; background: var(--bg);
            border: 2px solid var(--border); cursor: pointer; transition: 0.2s;
        }
        .share-option-btn:hover {
            border-color: var(--primary); background: var(--primary-light);
            transform: translateX(5px);
        }
        .share-option-btn i {
            font-size: 1.5rem; width: 40px; text-align: center;
        }
        .telegram-btn { color: #0088cc; }
        .website-btn { color: var(--primary); }
        .app-btn { color: var(--success); }

        /* PROFILE CARD NEW STYLES */
        .profile-header-card {
            background: linear-gradient(135deg, var(--primary), #8f94fb);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .profile-avatar-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 4px solid rgba(255,255,255,0.3);
            overflow: hidden;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .profile-avatar-container:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .profile-avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* AVATAR SELECTION GRID */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg);
            border-radius: 15px;
        }
        .avatar-option {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 3px solid transparent;
            transition: 0.2s;
        }
        .avatar-option.selected {
            border-color: var(--primary);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3);
        }

        /* SUPPORT SECTION */
        #support-section {
            margin-top: 25px;
        }
        .support-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border);
            transition: 0.2s;
            cursor: pointer;
        }
        .support-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }
        .support-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        .support-info {
            flex: 1;
        }
        .support-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        .support-desc {
            font-size: 0.85rem;
            color: var(--text-sec);
        }
        
        /* SUPPORT ADMIN STYLES */
        .support-admin-grid {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }
        .support-admin-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        /* EXAM LEADERBOARD TAB */
        .exam-leaderboard-tabs {
            display: flex;
            margin-bottom: 15px;
            background: var(--bg);
            border-radius: 15px;
            padding: 5px;
            overflow-x: auto;
        }
        .exam-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 500;
            transition: 0.2s;
            white-space: nowrap;
            min-width: 80px;
        }
        .exam-tab.active {
            background: var(--primary);
            color: white;
        }

        /* REVIEW PAGE */
        .review-question {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            background: var(--bg);
        }
        .review-correct {
            border-left: 4px solid var(--success);
        }
        .review-wrong {
            border-left: 4px solid var(--danger);
        }
        .review-skipped {
            border-left: 4px solid var(--warning);
        }

        /* FORGOT PASSWORD STYLES */
        .forgot-password-link {
            text-align: center;
            margin-top: 15px;
        }
        .forgot-password-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        .forgot-password-link a:hover {
            text-decoration: underline;
        }
        
        /* REGISTRATION PAGE ENHANCEMENTS */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .auth-card {
            width: 100%;
            max-width: 450px;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .auth-title {
            text-align: center;
            color: var(--primary);
            font-size: 2.2rem;
            margin-bottom: 5px;
        }
        .auth-subtitle {
            text-align: center;
            color: var(--text-sec);
            margin-bottom: 30px;
            font-size: 0.95rem;
        }
        
        /* EXAM SELECT DROPDOWN FOR LEADERBOARD - IMPROVED */
        .exam-select-container {
            margin-bottom: 20px;
        }
        .exam-select-wrapper {
            position: relative;
            width: 100%;
        }
        .exam-select {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236C63FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            transition: all 0.3s ease;
        }
        .exam-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }
        .exam-select option {
            padding: 10px;
            background: var(--card-bg);
            color: var(--text);
        }
        
        /* CONGRATULATIONS MESSAGE */
        .congratulations-message {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* MCQ UPLOAD REPORT */
        .upload-report {
            margin-top: 15px;
            padding: 15px;
            border-radius: 12px;
            background: var(--bg);
        }
        .upload-success {
            color: var(--success);
            font-weight: 600;
        }
        .upload-failed {
            color: var(--danger);
            font-weight: 600;
        }

        /* CATEGORY FILTER STYLES - IMPROVED */
        .category-filter {
            margin-bottom: 20px;
        }
        .category-select-wrapper {
            position: relative;
            width: 100%;
        }
        .category-select {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236C63FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            transition: all 0.3s ease;
        }
        .category-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }
        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
        }

        /* ADMIN CATEGORY SELECT WITH PLUS BUTTON */
        .admin-category-select-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 12px;
        }
        .admin-category-select {
            width: 100%;
            padding: 15px 60px 15px 15px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236C63FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 45px center;
            background-size: 20px;
            transition: all 0.3s ease;
        }
        .admin-category-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }
        .add-category-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .add-category-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-50%) scale(1.1);
        }

        /* ADMIN CATEGORY MODAL */
        .add-category-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .add-category-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 400px;
            padding: 25px;
            border-radius: 20px;
            animation: slideUp 0.3s;
        }

        /* ADMIN EXAM FILTER */
        .admin-exam-filter {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .admin-filter-select {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
        }
        .admin-filter-select:focus {
            border-color: var(--primary);
        }

        /* ==================== */
        /* SMART STUDY PLAN CSS */
        /* ==================== */
        
        /* Motivational Carousel */
        .motivational-carousel {
            width: 100%;
            height: 120px;
            border-radius: 20px;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            background: linear-gradient(135deg, var(--primary), #8f94fb);
            box-shadow: var(--shadow);
        }
        
        .carousel-track {
            display: flex;
            height: 100%;
            transition: transform 0.5s ease;
        }
        
        .carousel-slide {
            min-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            color: white;
            animation: fadeIn 1s ease;
        }
        
        .carousel-quote {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .carousel-author {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .carousel-indicators {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .carousel-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: 0.3s;
        }
        
        .carousel-indicator.active {
            background: white;
            transform: scale(1.2);
        }
        
        /* STUDY SELECT DROPDOWN */
        .study-select-container {
            margin-bottom: 20px;
        }
        .study-select-wrapper {
            position: relative;
            width: 100%;
        }
        .study-select {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236C63FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            transition: all 0.3s ease;
        }
        .study-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }
        
        /* Journey Panel */
        .journey-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            animation: slideUp 0.5s ease;
        }
        
        .journey-goal {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .countdown-timer {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .countdown-item {
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            min-width: 60px;
        }
        
        .countdown-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }
        
        .countdown-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        /* Progress Cards */
        .progress-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .progress-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideUp 0.6s ease;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-title {
            font-weight: 600;
            color: var(--text);
        }
        
        .progress-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .progress-bar-container {
            height: 10px;
            background: var(--bg);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #8f94fb);
            border-radius: 5px;
            transition: width 1s ease;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-sec);
        }
        
        /* Study Level Selector */
        .study-level-selector {
            margin-bottom: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .study-level-select-wrapper {
            position: relative;
            width: 100%;
        }
        
        .study-level-select {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236C63FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            transition: all 0.3s ease;
        }
        
        .study-level-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }
        
        /* Study Cards */
        .study-cards-container {
            margin-bottom: 20px;
        }
        
        .study-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .study-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .study-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: 0.3s;
            animation: slideUp 0.7s ease;
            position: relative;
            overflow: hidden;
        }
        
        .study-card.locked {
            opacity: 0.6;
            filter: grayscale(0.5);
        }
        
        .study-card.completed {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), var(--card-bg));
        }
        
        .study-card.in-progress {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(255, 165, 2, 0.1), var(--card-bg));
        }
        
        .study-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .study-day {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .study-status {
            font-size: 0.8rem;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .status-completed {
            background: var(--success);
            color: white;
        }
        
        .status-in-progress {
            background: var(--warning);
            color: white;
        }
        
        .status-pending {
            background: var(--text-sec);
            color: white;
        }
        
        .study-topic {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }
        
        .study-description {
            font-size: 0.9rem;
            color: var(--text-sec);
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .study-metrics {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.8rem;
        }
        
        .study-metric {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-sec);
        }
        
        .study-actions {
            display: flex;
            gap: 10px;
        }
        
        .read-again-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text);
        }
        
        /* Study Leaderboard */
        .study-leaderboard-tabs {
            display: flex;
            background: var(--bg);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 15px;
        }
        
        .study-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 500;
            transition: 0.2s;
        }
        
        .study-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .study-leaderboard-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideUp 0.5s ease;
        }
        
        .study-rank {
            font-size: 1.2rem;
            font-weight: 700;
            width: 40px;
            text-align: center;
            color: var(--primary);
        }
        
        .study-user-info {
            flex: 1;
        }
        
        .study-user-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .study-user-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .study-user-progress-bar {
            flex: 1;
            height: 6px;
            background: var(--bg);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .study-user-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #8f94fb);
            border-radius: 3px;
        }
        
        .study-user-percentage {
            font-weight: 600;
            color: var(--primary);
            min-width: 45px;
            text-align: right;
        }
        
        /* Admin Study Manager */
        .study-json-format {
            background: var(--bg);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.8rem;
            margin-bottom: 15px;
            overflow-x: auto;
            white-space: pre-wrap;
            border: 1px solid var(--border);
            position: relative;
        }
        
        .copy-json-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s;
        }
        
        .copy-json-btn:hover {
            background: var(--primary-dark);
        }
        
        /* Practice Quiz Modal */
        .practice-quiz-modal .modal-content {
            max-width: 500px;
        }
        
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .quiz-timer {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        /* Shimmer Effect */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .shimmer {
            background: linear-gradient(90deg, var(--bg) 25%, var(--card-bg) 50%, var(--bg) 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Animations */
        @keyframes fadeInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .fade-in-left { animation: fadeInLeft 0.5s ease; }
        .bounce-in { animation: bounceIn 0.6s ease; }
        
        /* UPLOAD PHOTO BUTTON */
        .upload-photo-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--primary);
            color: white;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            justify-content: center;
            margin-top: 10px;
            transition: 0.2s;
        }
        
        .upload-photo-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        /* PROFILE PHOTO UPLOAD MODAL - IMPROVED */
        .photo-upload-modal .modal-content {
            max-width: 450px;
            padding: 30px;
        }
        
        .photo-preview-container {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            margin: 0 auto 25px;
            border: 5px solid var(--border);
            overflow: hidden;
            position: relative;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .photo-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-upload-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .photo-option-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 12px;
            background: var(--bg);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: 0.3s;
        }
        
        .photo-option-btn:hover {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: translateX(5px);
        }
        
        .photo-option-btn i {
            font-size: 1.8rem;
            width: 50px;
            text-align: center;
            color: var(--primary);
        }
        
        .photo-option-info {
            flex: 1;
        }
        
        .photo-option-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .photo-option-desc {
            font-size: 0.85rem;
            color: var(--text-sec);
        }
        
        /* STUDY GOAL SELECTOR */
        .study-goal-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow);
        }
        
        .goal-icon {
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        /* ADMIN STUDY QUESTIONS LIST - DAY BASED */
        .study-questions-list {
            margin-top: 15px;
        }
        
        .study-question-day-item {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--card-bg);
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .day-title {
            font-weight: 600;
            color: var(--primary);
        }
        
        .day-question-count {
            font-size: 0.8rem;
            color: var(--text-sec);
            background: var(--bg);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .question-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* RANK BADGE IN RESULT */
        .rank-badge {
            display: inline-block;
            padding: 8px 15px;
            background: linear-gradient(135deg, #ff9a00, #ff5e00);
            color: white;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.2rem;
            margin: 10px 0;
            animation: pulse 1.5s infinite;
        }
        
        /* LEADERBOARD RANK STYLES */
        .rank-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500) !important;
        }
        
        .rank-2 {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0) !important;
        }
        
        .rank-3 {
            background: linear-gradient(135deg, #CD7F32, #A0522D) !important;
        }
        
        .rank-badge-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .rank-1 .rank-badge-icon {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
        }
        
        .rank-2 .rank-badge-icon {
            background: rgba(192, 192, 192, 0.2);
            color: #C0C0C0;
        }
        
        .rank-3 .rank-badge-icon {
            background: rgba(205, 127, 50, 0.2);
            color: #CD7F32;
        }
        
        /* RANK SELECTOR */
        .rank-selector-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .rank-filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .rank-filter-select {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
        }
        
        .rank-filter-select:focus {
            border-color: var(--primary);
        }
        
        /* EXAM RANK INFO */
        .exam-rank-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-light), transparent);
            border-radius: 15px;
            margin-bottom: 15px;
        }
        
        .exam-rank-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary), #8f94fb);
        }
        
        .exam-rank-details {
            flex: 1;
        }
        
        .exam-rank-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .exam-rank-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: var(--text-sec);
        }
        
        /* ADMIN STUDY LIST */
        .admin-study-list {
            margin-top: 15px;
        }
        
        .study-list-item {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .study-list-info {
            flex: 1;
        }
        
        .study-list-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .study-list-meta {
            font-size: 0.8rem;
            color: var(--text-sec);
            display: flex;
            gap: 10px;
        }
        
        .study-list-actions {
            display: flex;
            gap: 10px;
        }

        /* ==================== */
        /* MEMORIZING PART CSS */
        /* ==================== */
        
        .memorizing-tabs {
            display: flex;
            background: var(--bg);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
        }
        
        .memorizing-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 500;
            transition: 0.2s;
        }
        
        .memorizing-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .memorizing-category-selector {
            margin-bottom: 20px;
        }
        
        .memorizing-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .memorizing-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeIn 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 150px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
        }
        
        .memorizing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .memorizing-card.difficult {
            border-color: var(--danger);
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), var(--card-bg));
        }
        
        .memorizing-card.completed {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), var(--card-bg));
        }
        
        .memorizing-card-content {
            font-size: 1.1rem;
            font-weight: 500;
            line-height: 1.4;
            color: var(--text);
            padding: 10px;
        }
        
        .memorizing-card-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .memorizing-card-status {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .status-difficult {
            background: var(--danger);
            color: white;
        }
        
        .status-completed {
            background: var(--success);
            color: white;
        }
        
        .memorizing-progress {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow);
        }
        
        .memorizing-day-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .memorizing-day-badge {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .memorizing-stats {
            display: flex;
            gap: 15px;
        }
        
        .memorizing-stat {
            text-align: center;
        }
        
        .memorizing-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            display: block;
        }
        
        .memorizing-stat-label {
            font-size: 0.8rem;
            color: var(--text-sec);
        }
        
        /* ADMIN MEMORIZING MANAGEMENT */
        .admin-memorizing-container {
            margin-top: 20px;
        }
        
        .memorizing-category-list {
            margin-top: 15px;
        }
        
        .memorizing-category-item {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .memorizing-items-count {
            font-size: 0.8rem;
            color: var(--text-sec);
            background: var(--bg);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .memorizing-bulk-upload {
            margin-top: 20px;
        }
        
        .memorizing-json-format {
            background: var(--bg);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.8rem;
            margin-bottom: 15px;
            overflow-x: auto;
            white-space: pre-wrap;
            border: 1px solid var(--border);
            position: relative;
        }
        
        /* IMPROVED STUDY PLAN UI */
        .study-plan-header {
            background: linear-gradient(135deg, var(--primary), #8f94fb);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .study-plan-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .study-plan-meta {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        
        .study-plan-meta-item {
            text-align: center;
            flex: 1;
        }
        
        .study-plan-meta-value {
            font-size: 1.8rem;
            font-weight: 700;
            display: block;
        }
        
        .study-plan-meta-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .study-plan-countdown {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
            margin-top: 15px;
        }
        
        .countdown-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .countdown-cell {
            background: rgba(255,255,255,0.3);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }
        
        .countdown-cell-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }
        
        .countdown-cell-label {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        /* IMPROVED ADMIN STUDY PLAN UI */
        .admin-study-plan-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: 0.3s;
        }
        
        .admin-study-plan-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        
        .admin-study-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .admin-study-plan-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .admin-study-plan-stat {
            font-size: 0.8rem;
            color: var(--text-sec);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ERROR POPUP FOR LOGIN */
        .error-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(255, 71, 87, 0.3);
            z-index: 10000;
            display: none;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
        }
        
        .error-popup.show {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* PERFORMANCE OPTIMIZATIONS */
        .will-change-transform {
            will-change: transform;
        }
        
        .content-visibility-auto {
            content-visibility: auto;
        }
        
        /* NEW STUDY PLAN FORM */
        .study-plan-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .study-plan-duration-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
    </style>
</head>
<body>

    <div id="refresh-indicator"><i class="fas fa-sync-alt fa-spin"></i></div>
    
    <!-- Network Status Popup -->
    <div id="network-status">
        <i class="fas fa-wifi-slash"></i> No internet connection. Please check your network.
    </div>

    <!-- Error Popup for Login -->
    <div class="error-popup" id="login-error-popup">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
            <div style="font-weight: 600;">Login Failed</div>
            <div style="font-size: 0.9rem; opacity: 0.9;" id="login-error-msg"></div>
        </div>
    </div>

    <!-- Notification Popup - UPDATED -->
    <div class="notification-popup" id="notification-popup">
        <div class="notification-header">
            <h4 style="color: var(--primary); margin:0;">Notifications</h4>
            <i class="fas fa-times" onclick="closeNotificationPopup()" style="cursor:pointer;"></i>
        </div>
        <div id="notification-list"></div>
        <button class="notification-clear-all" onclick="clearAllNotifications()" id="clear-all-btn" style="display:none;">
            <i class="fas fa-trash"></i> Clear All
        </button>
    </div>

    <div id="splash-screen">
        <div class="splash-logo-container">
            <img src="13877.jpg" alt="Logo" class="splash-logo">
        </div>
        <div class="splash-text">ExamPro</div>
    </div>

    <div id="loader"><div class="spinner"></div></div>

    <div id="custom-alert">
        <h2 style="color:var(--primary); margin-bottom:10px;">ExamPro</h2>
        <p id="alert-msg" style="color:var(--text-sec); margin-bottom:20px; font-size:1rem;">Message</p>
        <button onclick="closeAlert()" class="btn btn-primary">OK</button>
    </div>

    <div id="confirm-modal">
        <div class="confirm-box">
            <i class="fas fa-exclamation-triangle confirm-icon"></i>
            <h3 style="margin-bottom:10px;">Are you sure?</h3>
            <p id="conf-msg" style="color:var(--text-sec); font-size:0.95rem;">This action cannot be undone.</p>
            <div class="confirm-btns">
                <button onclick="resolveConfirm(false)" class="btn btn-sec" style="margin-top:0;">Cancel</button>
                <button onclick="resolveConfirm(true)" class="btn btn-danger" style="margin-top:0;">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <h2 style="margin-bottom:20px; color:var(--primary);">Reset Password</h2>
            <p style="color:var(--text-sec); margin-bottom:15px;">Enter your email address and we'll send you a link to reset your password.</p>
            <input type="email" id="reset-email" placeholder="Email Address">
            <button onclick="sendPasswordResetEmail()" class="btn btn-primary">Send Reset Link</button>
            <button onclick="closeForgotPasswordModal()" class="btn btn-sec" style="margin-top:10px;">Cancel</button>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="add-category-modal" class="add-category-modal">
        <div class="add-category-content">
            <h2 style="margin-bottom:20px; color:var(--primary); text-align:center;">
                <i class="fas fa-plus-circle"></i> Add New Category
            </h2>
            <input type="text" id="new-category-name" placeholder="Category Name (e.g. Math, Physics)" style="margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <button onclick="saveNewCategory()" class="btn btn-primary">Save Category</button>
                <button onclick="closeAddCategoryModal()" class="btn btn-sec">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Practice Quiz Modal -->
    <div id="practice-quiz-modal" class="modal practice-quiz-modal">
        <div class="modal-content">
            <div class="quiz-header">
                <h3 id="quiz-title" style="color:var(--primary); margin:0;">Practice Quiz</h3>
                <div class="quiz-timer" id="practice-quiz-timer">2:00</div>
            </div>
            <div id="practice-quiz-questions"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="submitPracticeQuiz()" class="btn btn-primary">Submit Quiz</button>
                <button onclick="closePracticeQuiz()" class="btn btn-sec">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Photo Upload Modal - IMPROVED -->
    <div id="photo-upload-modal" class="modal photo-upload-modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px; color:var(--primary); text-align:center;">
                <i class="fas fa-camera"></i> Upload Profile Picture
            </h2>
            
            <div class="photo-preview-container">
                <img id="photo-preview" class="photo-preview" src="" alt="Preview">
                <div id="photo-placeholder" style="display:none; text-align:center; color:var(--text-sec);">
                    <i class="fas fa-user-circle" style="font-size:5rem;"></i>
                    <div style="margin-top:10px;">No photo selected</div>
                </div>
            </div>
            
            <div class="photo-upload-options">
                <div class="photo-option-btn" onclick="openCloudinaryWidget()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <div class="photo-option-info">
                        <div class="photo-option-title">Upload from Device</div>
                        <div class="photo-option-desc">Select photo from your phone or computer</div>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="photo-option-btn" onclick="openAvatarSelector()">
                    <i class="fas fa-user-circle"></i>
                    <div class="photo-option-info">
                        <div class="photo-option-title">Choose Avatar</div>
                        <div class="photo-option-desc">Select from our collection of avatars</div>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="photo-option-btn" onclick="openCamera()">
                    <i class="fas fa-camera"></i>
                    <div class="photo-option-info">
                        <div class="photo-option-title">Take Photo</div>
                        <div class="photo-option-desc">Use your camera to take a new photo</div>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:25px;">
                <button onclick="saveProfilePhoto()" class="btn btn-success" style="flex:1;">
                    <i class="fas fa-check"></i> Save Photo
                </button>
                <button onclick="closePhotoUploadModal()" class="btn btn-sec" style="flex:1;">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Avatar Selector Modal -->
    <div id="avatar-selector-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px; color:var(--primary); text-align:center;">
                <i class="fas fa-user-circle"></i> Choose Avatar
            </h2>
            
            <div style="margin-bottom:20px;">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="filterAvatars('all')" class="btn btn-sec" style="width:auto; padding:8px 15px;">All</button>
                    <button onclick="filterAvatars('male')" class="btn btn-sec" style="width:auto; padding:8px 15px;">Male</button>
                    <button onclick="filterAvatars('female')" class="btn btn-sec" style="width:auto; padding:8px 15px;">Female</button>
                </div>
            </div>
            
            <div class="avatar-grid" id="avatar-grid">
                <!-- Avatars will be loaded here -->
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="selectAvatar()" class="btn btn-primary" style="flex:1;">
                    <i class="fas fa-check"></i> Select Avatar
                </button>
                <button onclick="closeAvatarSelector()" class="btn btn-sec" style="flex:1;">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <section id="auth-screen" class="screen">
        <div class="auth-container" style="background:linear-gradient(135deg, var(--primary), #8f94fb);">
            <div class="auth-card">
                <h1 class="auth-title">ExamPro</h1>
                <p class="auth-subtitle">Login to continue your learning journey</p>
                
                <div id="login-form">
                    <input type="email" id="l-email" placeholder="Email Address">
                    <input type="password" id="l-pass" placeholder="Password">
                    <button onclick="handleLogin()" class="btn btn-primary">Log In</button>
                    
                    <div class="forgot-password-link">
                        <a onclick="showForgotPasswordModal()">Forgot Password?</a>
                    </div>
                    
                    <p style="margin-top:20px; color:var(--text-sec); text-align:center;">
                        New User? 
                        <b onclick="toggleAuth('signup')" style="color:var(--primary); cursor:pointer; font-weight:600;">
                            Create Account
                        </b>
                    </p>
                </div>

                <div id="signup-form" style="display:none;">
                    <input type="text" id="s-name" placeholder="Full Name">
                    <select id="s-gender">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <input type="text" id="s-edu" placeholder="Education (e.g. HSC)">
                    <input type="email" id="s-email" placeholder="Email Address">
                    <input type="password" id="s-pass" placeholder="Password (minimum 6 characters)">
                    <button onclick="handleSignup()" class="btn btn-primary">Create Account</button>
                    
                    <p style="margin-top:20px; color:var(--text-sec); text-align:center;">
                        Already have an account? 
                        <b onclick="toggleAuth('login')" style="color:var(--primary); cursor:pointer; font-weight:600;">
                            Log In
                        </b>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section id="app-screen" class="screen">
        <header>
            <div class="logo">ExamPro</div>
            <div style="display:flex; gap:15px; align-items:center;">
                <i onclick="toggleNotificationPopup()" class="fas fa-bell" id="notification-icon" style="font-size:1.4rem; cursor:pointer; color:var(--white); position:relative;">
                    <span id="notification-count" style="display:none; position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; border-radius:50%; width:18px; height:18px; font-size:0.6rem; display:flex; align-items:center; justify-content:center;">0</span>
                </i>
                <i onclick="toggleTheme()" id="theme-icon" class="fas fa-moon" style="font-size:1.4rem; cursor:pointer;"></i>
            </div>
        </header>

        <div id="main-content" class="container"></div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="renderHome()"><i class="fas fa-home"></i> <span>Home</span></div>
            <div class="nav-item" onclick="renderStudy()"><i class="fas fa-book-open"></i> <span>Study</span></div>
            <div class="nav-item" onclick="renderReview()"><i class="fas fa-clipboard-check"></i> <span>Review</span></div>
            <div class="nav-item" onclick="renderLeaderboard()"><i class="fas fa-chart-line"></i> <span>Rank</span></div>
            <div class="nav-item" onclick="renderProfile()"><i class="fas fa-user"></i> <span>Profile</span></div>
            <div class="nav-item" id="admin-nav" style="display:none;" onclick="renderAdmin()"><i class="fas fa-th-large"></i> <span>Admin</span></div>
        </nav>
    </section>

    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom:20px; color:var(--primary);">Title</h2>
            <div id="modal-body"></div>
            <button onclick="closeModal()" class="btn btn-sec" style="margin-top:20px;">Close</button>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px; color:var(--primary); text-align:center;">
                <i class="fas fa-share-alt"></i> Share ExamPro
            </h2>
            <div class="share-options">
                <div class="share-option-btn telegram-btn" onclick="shareViaPlatform('telegram')">
                    <i class="fab fa-telegram"></i>
                    <div>
                        <div style="font-weight:600;">Telegram Bot</div>
                        <small style="color:var(--text-sec);">Share via Telegram bot</small>
                    </div>
                </div>
                <div class="share-option-btn website-btn" onclick="shareViaPlatform('website')">
                    <i class="fas fa-globe"></i>
                    <div>
                        <div style="font-weight:600;">Website</div>
                        <small style="color:var(--text-sec);">Share website link</small>
                    </div>
                </div>
                <div class="share-option-btn app-btn" onclick="shareViaPlatform('app')">
                    <i class="fas fa-mobile-alt"></i>
                    <div>
                        <div style="font-weight:600;">App</div>
                        <small style="color:var(--text-sec);">Share app download link</small>
                    </div>
                </div>
            </div>
            <button onclick="closeShareModal()" class="btn btn-sec" style="margin-top:20px;">Cancel</button>
        </div>
    </div>

    <!-- Memorizing Category Modal -->
    <div id="memorizing-category-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px; color:var(--primary); text-align:center;">
                <i class="fas fa-plus-circle"></i> Add Memorizing Category
            </h2>
            <input type="text" id="new-memorizing-category-name" placeholder="Category Name (e.g. Vocabulary, Quotes)" style="margin-bottom:15px;">
            <textarea id="new-memorizing-category-desc" placeholder="Description (optional)" rows="3" style="margin-bottom:15px;"></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="saveNewMemorizingCategory()" class="btn btn-primary">Save Category</button>
                <button onclick="closeMemorizingCategoryModal()" class="btn btn-sec">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Audio for notification sound -->
    <audio id="notification-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Audio for alert sound -->
    <audio id="alert-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" type="audio/mpeg">
    </audio>

    <!-- Audio for exam completion sound -->
    <audio id="exam-complete-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, deleteDoc, updateDoc, onSnapshot, Timestamp, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBW0-UiTB83ikUOztrT6ECAkOlnzxykKYQ",
            authDomain: "mcq-exam-b150e.firebaseapp.com",
            projectId: "mcq-exam-b150e",
            storageBucket: "mcq-exam-b150e.firebasestorage.app",
            messagingSenderId: "751727102033",
            appId: "1:751727102033:web:35995f15619e300872d070",
            measurementId: "G-9NS51NRGER"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let timerInterval;
        let allStudentsCache = [];
        let allNotifications = [];
        let unreadNotifications = 0;
        let selectedCategory = localStorage.getItem('selectedCategory') || '';
        let allCategories = [];
        
        // Smart Study Plan Variables
        let studyProgress = null;
        let studyPlans = [];
        let currentStudyPlan = null;
        let currentStudyLevel = 1;
        let motivationalQuotes = [];
        let studySettings = null;
        let carouselInterval = null;
        let currentCarouselIndex = 0;
        let practiceQuizQuestions = [];
        let practiceQuizAnswers = {};
        let practiceQuizTimer = null;
        let practiceQuizTimeLeft = 120; // 2 minutes in seconds
        let currentPracticeDay = null;
        let currentPracticeLevel = null;
        
        // Memorizing Part Variables
        let memorizingCategories = [];
        let memorizingItems = [];
        let memorizingProgress = null;
        let currentMemorizingCategory = null;
        let currentMemorizingDay = 1;
        let currentMemorizingCards = [];
        let difficultCards = [];
        
        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: 'dsmvmq076',
            uploadPreset: 'my_app_upload'
        };

        // AVATAR IMAGES
        const AVATAR_MALE = [
            "https://cdn-icons-png.flaticon.com/512/4825/4825038.png",
            "https://cdn-icons-png.flaticon.com/512/4333/4333609.png",
            "https://cdn-icons-png.flaticon.com/512/4140/4140047.png",
            "https://cdn-icons-png.flaticon.com/512/4322/4322992.png",
            "https://cdn-icons-png.flaticon.com/512/3135/3135715.png",
            "https://cdn-icons-png.flaticon.com/512/921/921071.png"
        ];
        
        const AVATAR_FEMALE = [
            "https://cdn-icons-png.flaticon.com/512/4825/4825112.png",
            "https://cdn-icons-png.flaticon.com/512/6997/6997662.png",
            "https://cdn-icons-png.flaticon.com/512/4140/4140037.png",
            "https://cdn-icons-png.flaticon.com/512/4322/4322991.png",
            "https://cdn-icons-png.flaticon.com/512/3135/3135782.png",
            "https://cdn-icons-png.flaticon.com/512/921/921124.png"
        ];

        // Default Motivational Quotes
        const DEFAULT_QUOTES = [
            { quote: "The secret of getting ahead is getting started.", author: "Mark Twain" },
            { quote: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
            { quote: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
            { quote: "Education is the most powerful weapon which you can use to change the world.", author: "Nelson Mandela" },
            { quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { quote: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" }
        ];

        // SHARE LINKS DEFAULT
        let shareLinks = {
            telegram: "https://t.me/your_bot",
            website: "https://yourexampro.com",
            app: "https://play.google.com/store/apps/details?id=com.exampro"
        };

        // SUPPORT LINKS
        let supportLinks = [];

        // --- SOUND FUNCTIONS ---
        function playNotificationSound() {
            const audio = document.getElementById('notification-sound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Notification sound play failed:", e));
        }

        function playAlertSound() {
            const audio = document.getElementById('alert-sound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Alert sound play failed:", e));
        }

        function playExamCompleteSound() {
            const audio = document.getElementById('exam-complete-sound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Exam complete sound play failed:", e));
        }

        // --- NETWORK CONNECTIVITY ---
        function updateNetworkStatus() {
            const networkStatus = document.getElementById('network-status');
            if (!navigator.onLine) {
                networkStatus.style.display = 'block';
            } else {
                networkStatus.style.display = 'none';
            }
        }

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        updateNetworkStatus();

        // --- SPLASH SCREEN LOGIC ---
        function hideSplash() {
            const splash = document.getElementById('splash-screen');
            if(splash) {
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 600);
            }
        }

        // --- PULL TO REFRESH LOGIC ---
        let touchStart = 0;
        let touchEnd = 0;
        const refInd = document.getElementById('refresh-indicator');
        
        window.addEventListener('touchstart', e => {
            if(window.scrollY === 0) touchStart = e.changedTouches[0].screenY;
        }, {passive: true});

        window.addEventListener('touchmove', e => {
            if(window.scrollY === 0 && touchStart > 0) {
                touchEnd = e.changedTouches[0].screenY;
                if(touchEnd > touchStart) {
                    const pull = Math.min((touchEnd - touchStart) * 0.4, 80); 
                    refInd.style.top = `${pull}px`;
                }
            }
        }, {passive: true});

        window.addEventListener('touchend', e => {
            if(window.scrollY === 0 && touchStart > 0) {
                touchEnd = e.changedTouches[0].screenY;
                if(touchEnd - touchStart > 120) { 
                    refInd.style.top = '20px';
                    setTimeout(() => location.reload(), 300);
                } else {
                    refInd.style.top = '-50px'; 
                }
            }
            touchStart = 0;
        }, {passive: true});

        // --- CUSTOM CONFIRM LOGIC ---
        let confirmResolver = null;
        window.customConfirm = (msg) => {
            const m = document.getElementById('confirm-modal');
            document.getElementById('conf-msg').innerText = msg;
            m.classList.add('active'); 
            return new Promise((resolve) => {
                confirmResolver = resolve;
            });
        }
        window.resolveConfirm = (val) => {
            const m = document.getElementById('confirm-modal');
            m.classList.remove('active');
            if(confirmResolver) confirmResolver(val);
        }

        // --- UTILS ---
        window.showMsg = (msg) => {
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('custom-alert').classList.add('show');
            playAlertSound();
        }
        
        window.closeAlert = () => document.getElementById('custom-alert').classList.remove('show');
        
        window.toggleTheme = () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').className = 'fas fa-sun';
        }

        // --- ERROR POPUP FOR LOGIN ---
        function showLoginError(msg) {
            const errorPopup = document.getElementById('login-error-popup');
            const errorMsg = document.getElementById('login-error-msg');
            errorMsg.textContent = msg;
            errorPopup.classList.add('show');
            
            setTimeout(() => {
                errorPopup.classList.remove('show');
            }, 5000);
        }

        // --- FORGOT PASSWORD FUNCTIONS ---
        window.showForgotPasswordModal = () => {
            document.getElementById('forgot-password-modal').style.display = 'flex';
        }

        window.closeForgotPasswordModal = () => {
            document.getElementById('forgot-password-modal').style.display = 'none';
        }

        window.sendPasswordResetEmail = async () => {
            const email = document.getElementById('reset-email').value;
            if(!email) return showMsg("Please enter your email");
            try {
                toggleLoader(true);
                await sendPasswordResetEmail(auth, email);
                showMsg("Password reset email sent! Check your inbox.");
                closeForgotPasswordModal();
            } catch(e) {
                showMsg(e.message);
            } finally {
                toggleLoader(false);
            }
        }

        // --- SHARE FUNCTIONS ---
        window.showShareOptions = () => {
            document.getElementById('share-modal').style.display = 'flex';
        }

        window.closeShareModal = () => {
            document.getElementById('share-modal').style.display = 'none';
        }

        window.shareViaPlatform = async (platform) => {
            const shareLinksSnap = await getDoc(doc(db, "settings", "shareLinks"));
            if (shareLinksSnap.exists()) {
                shareLinks = shareLinksSnap.data();
            }
            
            let shareUrl = "";
            let platformName = "";
            
            switch(platform) {
                case 'telegram':
                    shareUrl = shareLinks.telegram || "https://t.me/your_bot";
                    platformName = "Telegram Bot";
                    break;
                case 'website':
                    shareUrl = shareLinks.website || "https://yourexampro.com";
                    platformName = "Website";
                    break;
                case 'app':
                    shareUrl = shareLinks.app || "https://play.google.com/store/apps/details?id=com.exampro";
                    platformName = "App";
                    break;
            }
            
            const shareText = `Hey! Check out ExamPro - the best exam preparation app! Join me using this ${platformName} link: ${shareUrl}`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'ExamPro',
                        text: shareText,
                        url: shareUrl,
                    });
                } catch (err) {
                    copyToClipboard(shareText);
                }
            } else {
                copyToClipboard(shareText);
            }
            
            closeShareModal();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMsg("Link copied to clipboard! Share it with your friends.");
            });
        }

        // --- NOTIFICATION FUNCTIONS ---
        function showNotificationPopup(title, message) {
            playNotificationSound();
            const popup = document.getElementById('notification-popup');
            popup.style.display = 'block';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 5000);
        }

        window.toggleNotificationPopup = () => {
            const popup = document.getElementById('notification-popup');
            if(popup.style.display === 'block') {
                popup.style.display = 'none';
            } else {
                loadNotifications();
                popup.style.display = 'block';
            }
        }

        window.closeNotificationPopup = () => {
            document.getElementById('notification-popup').style.display = 'none';
        }

        async function loadNotifications() {
            try {
                const q = query(collection(db, "notifications"), where("userId", "==", currentUser.uid));
                const snap = await getDocs(q);
                
                allNotifications = [];
                unreadNotifications = 0;
                snap.forEach(doc => {
                    const notif = { id: doc.id, ...doc.data() };
                    allNotifications.push(notif);
                    if(!notif.read) unreadNotifications++;
                });
                
                allNotifications.sort((a, b) => b.timestamp?.toMillis() - a.timestamp?.toMillis());
                
                updateNotificationUI();
            } catch(error) {
                console.error("Error loading notifications:", error);
            }
        }

        function updateNotificationUI() {
            const list = document.getElementById('notification-list');
            const countElem = document.getElementById('notification-count');
            const clearAllBtn = document.getElementById('clear-all-btn');
            
            if(allNotifications.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:var(--text-sec); padding:10px;">No notifications</p>';
                clearAllBtn.style.display = 'none';
            } else {
                let html = '';
                allNotifications.forEach(notif => {
                    const icon = getNotificationIcon(notif.type);
                    const time = formatTime(notif.timestamp?.toMillis() || Date.now());
                    html += `
                        <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="markAsRead('${notif.id}')">
                            <div class="notification-item-content">
                                <div style="display:flex; gap:10px;">
                                    <i class="fas ${icon}" style="color:var(--primary);"></i>
                                    <div>
                                        <div style="font-weight:600;">${notif.title}</div>
                                        <div style="font-size:0.8rem; color:var(--text-sec);">${notif.message}</div>
                                        <div style="font-size:0.7rem; color:var(--text-sec); margin-top:3px;">${time}</div>
                                    </div>
                                </div>
                            </div>
                            <button class="notification-delete" onclick="deleteNotification('${notif.id}', event)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                });
                list.innerHTML = html;
                clearAllBtn.style.display = 'block';
            }
            
            if(unreadNotifications > 0) {
                countElem.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
                countElem.style.display = 'flex';
            } else {
                countElem.style.display = 'none';
            }
        }

        window.deleteNotification = async (notificationId, event) => {
            if (event) event.stopPropagation();
            await deleteDoc(doc(db, "notifications", notificationId));
            loadNotifications();
        }

        window.clearAllNotifications = async () => {
            if(await customConfirm("Clear all notifications?")) {
                const q = query(collection(db, "notifications"), where("userId", "==", currentUser.uid));
                const snap = await getDocs(q);
                
                const batch = writeBatch(db);
                snap.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                loadNotifications();
                showMsg("All notifications cleared!");
            }
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'exam': return 'fa-file-alt';
                case 'routine': return 'fa-calendar';
                case 'note': return 'fa-book';
                case 'broadcast': return 'fa-bullhorn';
                case 'support': return 'fa-headset';
                default: return 'fa-bell';
            }
        }

        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            if(diff < 60000) return 'Just now';
            if(diff < 3600000) return `${Math.floor(diff/60000)} min ago`;
            if(diff < 86400000) return `${Math.floor(diff/3600000)} hour ago`;
            return `${Math.floor(diff/86400000)} day ago`;
        }

        async function markAsRead(notificationId) {
            await updateDoc(doc(db, "notifications", notificationId), { read: true });
            loadNotifications();
        }

        async function sendNotification(userId, title, message, type = 'general') {
            await addDoc(collection(db, "notifications"), {
                userId: userId,
                title: title,
                message: message,
                type: type,
                read: false,
                timestamp: Timestamp.now()
            });
        }

        // --- LOAD SUPPORT LINKS ---
        async function loadSupportLinks() {
            const snap = await getDocs(collection(db, "supportLinks"));
            supportLinks = [];
            snap.forEach(doc => {
                supportLinks.push({ id: doc.id, ...doc.data() });
            });
            supportLinks.sort((a, b) => (a.order || 0) - (b.order || 0));
        }

        // --- RENDER SUPPORT SECTION ---
        function renderSupportSection() {
            if (supportLinks.length === 0) return '';
            
            let html = `
                <div id="support-section">
                    <h3 style="margin-bottom:15px; color:var(--text); display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-headset" style="color:var(--primary)"></i> Support & Contact
                    </h3>`;
            
            supportLinks.forEach(link => {
                const iconColor = link.color || '#6C63FF';
                html += `
                    <div class="support-card" onclick="window.open('${link.link}', '_blank')">
                        <div class="support-icon" style="background: ${iconColor}">
                            <i class="${link.icon}"></i>
                        </div>
                        <div class="support-info">
                            <div class="support-title">${link.title}</div>
                            <div class="support-desc">${link.description || 'Click to connect'}</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color:var(--text-sec);"></i>
                    </div>
                `;
            });
            
            html += `</div>`;
            return html;
        }

        // --- CATEGORY FUNCTIONS ---
        async function loadAllCategories() {
            try {
                // First try to load from categories collection
                const categoriesSnap = await getDocs(collection(db, "categories"));
                const categoriesSet = new Set();
                
                categoriesSnap.forEach(doc => {
                    const data = doc.data();
                    if(data.name) {
                        categoriesSet.add(data.name);
                    }
                });
                
                // Also load from exams for backward compatibility
                const examsSnap = await getDocs(collection(db, "exams"));
                examsSnap.forEach(doc => {
                    const data = doc.data();
                    if(data.category) {
                        categoriesSet.add(data.category);
                    }
                });
                
                allCategories = Array.from(categoriesSet).sort();
                return allCategories;
            } catch(error) {
                console.error("Error loading categories:", error);
                return [];
            }
        }

        window.showAddCategoryModal = () => {
            document.getElementById('add-category-modal').style.display = 'flex';
            document.getElementById('new-category-name').focus();
        }

        window.closeAddCategoryModal = () => {
            document.getElementById('add-category-modal').style.display = 'none';
            document.getElementById('new-category-name').value = '';
        }

        window.saveNewCategory = async () => {
            const newCategory = document.getElementById('new-category-name').value.trim();
            if(!newCategory) return showMsg("Please enter a category name");
            
            try {
                // Check if category already exists
                const q = query(collection(db, "categories"), where("name", "==", newCategory));
                const existingCat = await getDocs(q);
                
                if(!existingCat.empty) {
                    showMsg("Category already exists!");
                    return;
                }
                
                // Add to Firebase categories collection
                await addDoc(collection(db, "categories"), {
                    name: newCategory,
                    createdAt: Timestamp.now(),
                    createdBy: currentUser.uid
                });
                
                // Reload categories
                await loadAllCategories();
                
                // Update the category select in admin panel
                updateAdminCategorySelect();
                updateAdminExamCategorySelects();
                
                showMsg(`Category "${newCategory}" added successfully!`);
                closeAddCategoryModal();
            } catch(error) {
                console.error("Error saving category:", error);
                showMsg("Error saving category: " + error.message);
            }
        }

        function updateAdminCategorySelect() {
            const adminSelect = document.getElementById('admin-category-select');
            if(adminSelect) {
                let options = '<option value="">Select Category</option>';
                allCategories.forEach(cat => {
                    options += `<option value="${cat}">${cat}</option>`;
                });
                adminSelect.innerHTML = options;
            }
            
            // Also update other category selects
            const homeCategorySelect = document.getElementById('category-select');
            if(homeCategorySelect) {
                let options = '<option value="">All Categories</option>';
                allCategories.forEach(cat => {
                    options += `<option value="${cat}" ${cat === selectedCategory ? 'selected' : ''}>${cat}</option>`;
                });
                homeCategorySelect.innerHTML = options;
            }
        }

        function updateAdminExamCategorySelects() {
            // Update create exam category select
            const createSelect = document.getElementById('nc');
            if(createSelect) {
                let createOptions = '<option value="">Select Category</option>';
                allCategories.forEach(cat => {
                    createOptions += `<option value="${cat}">${cat}</option>`;
                });
                createSelect.innerHTML = createOptions;
            }
            
            // Update filter category select
            const filterSelect = document.getElementById('admin-exam-filter');
            if(filterSelect) {
                let filterOptions = '<option value="">All Categories</option>';
                allCategories.forEach(cat => {
                    filterOptions += `<option value="${cat}">${cat}</option>`;
                });
                filterSelect.innerHTML = filterOptions;
            }
        }

        // --- AUTH ---
        window.toggleAuth = (m) => {
            document.getElementById('login-form').style.display = m==='login'?'block':'none';
            document.getElementById('signup-form').style.display = m==='signup'?'block':'none';
        }
        
        window.handleLogin = async () => {
            const email = document.getElementById('l-email').value;
            const password = document.getElementById('l-pass').value;
            
            if(!email || !password) {
                showLoginError("Please enter both email and password");
                return;
            }
            
            try { 
                toggleLoader(true); 
                await signInWithEmailAndPassword(auth, email, password); 
            } 
            catch(e) { 
                let errorMsg = "Login failed. ";
                if(e.code === 'auth/invalid-email') {
                    errorMsg += "Invalid email format.";
                } else if(e.code === 'auth/user-not-found') {
                    errorMsg += "No account found with this email.";
                } else if(e.code === 'auth/wrong-password') {
                    errorMsg += "Incorrect password.";
                } else if(e.code === 'auth/too-many-requests') {
                    errorMsg += "Too many failed attempts. Try again later.";
                } else {
                    errorMsg += e.message;
                }
                showLoginError(errorMsg);
                toggleLoader(false); 
            }
        }
        
        window.handleSignup = async () => {
            const n=document.getElementById('s-name').value, 
                  g=document.getElementById('s-gender').value, 
                  e=document.getElementById('s-edu').value,
                  em=document.getElementById('s-email').value,
                  p=document.getElementById('s-pass').value;
            
            if(!n || !g || !em || !p) {
                showLoginError("Please fill all required details");
                return;
            }
            if(p.length < 6) {
                showLoginError("Password must be at least 6 characters");
                return;
            }
            
            try {
                toggleLoader(true);
                const res = await createUserWithEmailAndPassword(auth, em, p);
                
                const defaultAvatar = g === 'Female' ? AVATAR_FEMALE[0] : AVATAR_MALE[0];
                
                await setDoc(doc(db, "users", res.user.uid), {
                    name: n, gender: g, education: e, email: res.user.email, role: 'student', 
                    points: 0, level: 1, joined: new Date().toLocaleDateString(), isBanned: false,
                    examsTaken: [], avatar: defaultAvatar,
                    selectedStudyPlan: null
                });
                showMsg("Account Created Successfully!");
                toggleAuth('login');
            } catch(e) { 
                let errorMsg = "Signup failed. ";
                if(e.code === 'auth/email-already-in-use') {
                    errorMsg += "Email already in use.";
                } else if(e.code === 'auth/invalid-email') {
                    errorMsg += "Invalid email format.";
                } else if(e.code === 'auth/weak-password') {
                    errorMsg += "Password is too weak.";
                } else {
                    errorMsg += e.message;
                }
                showLoginError(errorMsg);
                toggleLoader(false); 
            }
        }
        
        window.handleLogout = () => signOut(auth).then(()=>location.reload());

        // --- AUTH STATE ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                await loadServerTheme();
                const shareLinksSnap = await getDoc(doc(db, "settings", "shareLinks"));
                if (shareLinksSnap.exists()) {
                    shareLinks = shareLinksSnap.data();
                }
                
                await loadSupportLinks();
                await loadAllCategories();
                await loadStudyData();
                await loadStudyPlans();
                await loadMemorizingData(); // Load memorizing data
                
                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists()) {
                    currentUser = { uid: user.uid, ...snap.data() };
                    
                    if(currentUser.isBanned) {
                        await signOut(auth);
                        showMsg("You are BANNED by Admin.");
                        toggleLoader(false);
                        hideSplash();
                        return;
                    }

                    document.getElementById('auth-screen').classList.remove('active-screen');
                    document.getElementById('app-screen').classList.add('active-screen');
                    if(currentUser.role === 'admin') document.getElementById('admin-nav').style.display = 'block';
                    
                    loadNotifications();
                    setupNotificationListener();
                    
                    renderHome();
                } else {
                    await signOut(auth);
                }
            } else {
                document.getElementById('app-screen').classList.remove('active-screen');
                document.getElementById('auth-screen').classList.add('active-screen');
            }
            toggleLoader(false);
            setTimeout(hideSplash, 500); 
        });

        // Notification listener
        function setupNotificationListener() {
            if(!currentUser) return;
            
            const q = query(collection(db, "notifications"), where("userId", "==", currentUser.uid));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if(change.type === "added") {
                        const newNotif = change.doc.data();
                        if(!newNotif.read) {
                            playNotificationSound();
                            showNotificationPopup(newNotif.title, newNotif.message);
                            loadNotifications();
                        }
                    }
                });
            });
        }

        // --- MEMORIZING PART FUNCTIONS ---
        async function loadMemorizingData() {
            if (!currentUser) return;
            
            try {
                // Load memorizing categories
                const categoriesSnap = await getDocs(collection(db, "memorizingCategories"));
                memorizingCategories = [];
                categoriesSnap.forEach(doc => {
                    memorizingCategories.push({ id: doc.id, ...doc.data() });
                });
                
                // Load user's memorizing progress
                const progressSnap = await getDoc(doc(db, "memorizingProgress", currentUser.uid));
                if (progressSnap.exists()) {
                    memorizingProgress = progressSnap.data();
                    currentMemorizingDay = memorizingProgress.currentDay || 1;
                    difficultCards = memorizingProgress.difficultItems || [];
                } else {
                    memorizingProgress = {
                        userId: currentUser.uid,
                        currentDay: 1,
                        difficultItems: [],
                        completedItems: [],
                        lastStudied: null
                    };
                    await setDoc(doc(db, "memorizingProgress", currentUser.uid), memorizingProgress);
                }
                
            } catch(error) {
                console.error("Error loading memorizing data:", error);
            }
        }

        async function loadMemorizingItems(categoryId) {
            try {
                const q = query(collection(db, "memorizingItems"), where("categoryId", "==", categoryId));
                const snap = await getDocs(q);
                
                memorizingItems = [];
                snap.forEach(doc => {
                    memorizingItems.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by day and order
                memorizingItems.sort((a, b) => {
                    if(a.day !== b.day) return a.day - b.day;
                    return (a.order || 0) - (b.order || 0);
                });
                
            } catch(error) {
                console.error("Error loading memorizing items:", error);
            }
        }

        function getCurrentMemorizingCards() {
            if (!currentMemorizingCategory || memorizingItems.length === 0) return [];
            
            // Get items for current day
            const dayItems = memorizingItems.filter(item => item.day === currentMemorizingDay);
            
            // Add difficult cards from previous days
            const difficultItems = memorizingItems.filter(item => 
                difficultCards.includes(item.id) && item.day < currentMemorizingDay
            );
            
            // Combine and limit to 10 cards
            let allCards = [...difficultItems, ...dayItems];
            allCards = allCards.slice(0, 10);
            
            // Mark completed cards
            const completedItems = memorizingProgress.completedItems || [];
            allCards = allCards.map(card => ({
                ...card,
                isCompleted: completedItems.includes(card.id),
                isDifficult: difficultCards.includes(card.id)
            }));
            
            return allCards;
        }

        window.toggleMemorizingTab = (tab) => {
            // Update active tab
            document.querySelectorAll('.memorizing-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'cards') {
                document.getElementById('memorizing-cards-container').style.display = 'grid';
                document.getElementById('memorizing-stats-container').style.display = 'none';
            } else {
                document.getElementById('memorizing-cards-container').style.display = 'none';
                document.getElementById('memorizing-stats-container').style.display = 'block';
            }
        }

        window.changeMemorizingCategory = async (categoryId) => {
            currentMemorizingCategory = memorizingCategories.find(cat => cat.id === categoryId);
            if (!currentMemorizingCategory) return;
            
            await loadMemorizingItems(categoryId);
            currentMemorizingCards = getCurrentMemorizingCards();
            renderMemorizingCards();
        }

        function renderMemorizingCards() {
            const container = document.getElementById('memorizing-cards-grid');
            if (!container || currentMemorizingCards.length === 0) {
                container.innerHTML = '<p style="grid-column: 1 / -1; text-align:center; color:var(--text-sec); padding:20px;">No cards available for today.</p>';
                return;
            }
            
            let html = '';
            currentMemorizingCards.forEach((card, index) => {
                const cardClass = card.isDifficult ? 'difficult' : (card.isCompleted ? 'completed' : '');
                const statusClass = card.isDifficult ? 'status-difficult' : (card.isCompleted ? 'status-completed' : '');
                const statusText = card.isDifficult ? 'Difficult' : (card.isCompleted ? 'Completed' : 'New');
                
                html += `
                    <div class="memorizing-card ${cardClass}" ondblclick="toggleCardDifficulty('${card.id}', this)">
                        <div class="memorizing-card-number">${index + 1}</div>
                        <div class="memorizing-card-status ${statusClass}">${statusText}</div>
                        <div class="memorizing-card-content">${card.content}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        window.toggleCardDifficulty = async (cardId, element) => {
            if (difficultCards.includes(cardId)) {
                // Remove from difficult cards
                difficultCards = difficultCards.filter(id => id !== cardId);
                element.classList.remove('difficult');
                element.querySelector('.memorizing-card-status').className = 'memorizing-card-status status-completed';
                element.querySelector('.memorizing-card-status').textContent = 'Completed';
            } else {
                // Add to difficult cards
                difficultCards.push(cardId);
                element.classList.add('difficult');
                element.querySelector('.memorizing-card-status').className = 'memorizing-card-status status-difficult';
                element.querySelector('.memorizing-card-status').textContent = 'Difficult';
            }
            
            // Update progress in Firebase
            await updateDoc(doc(db, "memorizingProgress", currentUser.uid), {
                difficultItems: difficultCards,
                lastStudied: Timestamp.now()
            });
        }

        window.completeMemorizingDay = async () => {
            if (currentMemorizingCards.length === 0) {
                showMsg("No cards to complete today!");
                return;
            }
            
            const completedCards = currentMemorizingCards
                .filter(card => !card.isDifficult)
                .map(card => card.id);
            
            const newCompletedItems = [...(memorizingProgress.completedItems || []), ...completedCards];
            
            // Move to next day
            currentMemorizingDay++;
            
            try {
                await updateDoc(doc(db, "memorizingProgress", currentUser.uid), {
                    currentDay: currentMemorizingDay,
                    completedItems: newCompletedItems,
                    difficultItems: difficultCards,
                    lastStudied: Timestamp.now()
                });
                
                memorizingProgress.currentDay = currentMemorizingDay;
                memorizingProgress.completedItems = newCompletedItems;
                
                // Reload cards for new day
                currentMemorizingCards = getCurrentMemorizingCards();
                renderMemorizingCards();
                updateMemorizingStats();
                
                showMsg(`Day ${currentMemorizingDay - 1} completed! Moving to Day ${currentMemorizingDay}`);
                
            } catch(error) {
                console.error("Error completing day:", error);
                showMsg("Error completing day: " + error.message);
            }
        }

        function updateMemorizingStats() {
            const totalCards = memorizingItems.length;
            const completedCards = (memorizingProgress.completedItems || []).length;
            const difficultCount = difficultCards.length;
            const completionRate = totalCards > 0 ? Math.round((completedCards / totalCards) * 100) : 0;
            
            document.getElementById('memorizing-total-cards').textContent = totalCards;
            document.getElementById('memorizing-completed-cards').textContent = completedCards;
            document.getElementById('memorizing-difficult-cards').textContent = difficultCount;
            document.getElementById('memorizing-completion-rate').textContent = `${completionRate}%`;
            document.getElementById('memorizing-current-day').textContent = `Day ${currentMemorizingDay}`;
        }

        // --- MEMORIZING ADMIN FUNCTIONS ---
        window.showMemorizingCategoryModal = () => {
            document.getElementById('memorizing-category-modal').style.display = 'flex';
            document.getElementById('new-memorizing-category-name').focus();
        }

        window.closeMemorizingCategoryModal = () => {
            document.getElementById('memorizing-category-modal').style.display = 'none';
            document.getElementById('new-memorizing-category-name').value = '';
            document.getElementById('new-memorizing-category-desc').value = '';
        }

        window.saveNewMemorizingCategory = async () => {
            const name = document.getElementById('new-memorizing-category-name').value.trim();
            const description = document.getElementById('new-memorizing-category-desc').value.trim();
            
            if(!name) return showMsg("Please enter a category name");
            
            try {
                await addDoc(collection(db, "memorizingCategories"), {
                    name: name,
                    description: description,
                    createdAt: Timestamp.now(),
                    createdBy: currentUser.uid,
                    itemCount: 0
                });
                
                showMsg(`Category "${name}" added successfully!`);
                closeMemorizingCategoryModal();
                admView('memorizing');
                
            } catch(error) {
                console.error("Error saving memorizing category:", error);
                showMsg("Error saving category: " + error.message);
            }
        }

        window.uploadMemorizingItems = async () => {
            const categoryId = document.getElementById('memorizing-category-select').value;
            const itemsText = document.getElementById('memorizing-items-json').value;
            
            if(!categoryId) {
                showMsg("Please select a category first");
                return;
            }
            
            if(!itemsText) {
                showMsg("Please enter items to upload");
                return;
            }
            
            try {
                // Parse comma-separated items
                const items = itemsText.split(',').map(item => item.trim()).filter(item => item.length > 0);
                
                if(items.length === 0) {
                    showMsg("No valid items found. Please enter items separated by commas.");
                    return;
                }
                
                toggleLoader(true);
                
                // Group items by day (10 items per day)
                let day = 1;
                let order = 0;
                let success = 0;
                
                for(let i = 0; i < items.length; i++) {
                    if(order >= 10) {
                        day++;
                        order = 0;
                    }
                    
                    try {
                        await addDoc(collection(db, "memorizingItems"), {
                            categoryId: categoryId,
                            content: items[i],
                            day: day,
                            order: order,
                            createdAt: Timestamp.now(),
                            createdBy: currentUser.uid
                        });
                        success++;
                        order++;
                    } catch(error) {
                        console.error("Error uploading item:", error);
                    }
                }
                
                // Update category item count
                const categoryRef = doc(db, "memorizingCategories", categoryId);
                const categorySnap = await getDoc(categoryRef);
                if(categorySnap.exists()) {
                    const currentCount = categorySnap.data().itemCount || 0;
                    await updateDoc(categoryRef, {
                        itemCount: currentCount + success
                    });
                }
                
                toggleLoader(false);
                
                document.getElementById('memorizing-upload-report').innerHTML = `
                    <div class="upload-report">
                        <h4>Upload Report:</h4>
                        <p><span class="upload-success">Successfully uploaded: ${success} items</span></p>
                        <p>Items organized into ${day} day(s)</p>
                    </div>
                `;
                
                showMsg(`Uploaded ${success} items successfully!`);
                document.getElementById('memorizing-items-json').value = '';
                
            } catch(error) {
                toggleLoader(false);
                console.error("Error uploading memorizing items:", error);
                showMsg("Error uploading items: " + error.message);
            }
        }

        // --- SMART STUDY PLAN FUNCTIONS ---
        async function loadStudyData() {
            if (!currentUser) return;
            
            try {
                // Load study progress for current user
                const progressSnap = await getDoc(doc(db, "Userstudy", currentUser.uid));
                if (progressSnap.exists()) {
                    studyProgress = progressSnap.data();
                } else {
                    // Create initial study progress
                    studyProgress = {
                        userId: currentUser.uid,
                        selectedStudyPlan: currentUser.selectedStudyPlan || null,
                        level: 1,
                        dailyProgress: 0,
                        totalProgress: 0,
                        completedTopics: [],
                        lastStudyDate: new Date().toISOString().split('T')[0],
                        dailyStudyTime: 0,
                        totalStudyTime: 0,
                        startDate: Timestamp.now()
                    };
                    await setDoc(doc(db, "Userstudy", currentUser.uid), studyProgress);
                }
                
                // Load motivational quotes
                const quotesSnap = await getDocs(collection(db, "MotivationalQuotes"));
                if (!quotesSnap.empty) {
                    motivationalQuotes = [];
                    quotesSnap.forEach(doc => {
                        motivationalQuotes.push(doc.data());
                    });
                } else {
                    motivationalQuotes = DEFAULT_QUOTES;
                }
                
                // Load study settings
                const settingsSnap = await getDoc(doc(db, "StudySettings", "global"));
                if (settingsSnap.exists()) {
                    studySettings = settingsSnap.data();
                } else {
                    studySettings = {
                        dailyGoal: 60, // 60 minutes daily
                        totalGoal: 1800 // 30 hours total
                    };
                    await setDoc(doc(db, "StudySettings", "global"), studySettings);
                }
                
            } catch(error) {
                console.error("Error loading study data:", error);
            }
        }

        // --- STUDY PLANS FUNCTIONS ---
        async function loadStudyPlans() {
            try {
                const plansSnap = await getDocs(collection(db, "StudyPlans"));
                studyPlans = [];
                plansSnap.forEach(doc => {
                    studyPlans.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort plans by order or creation date
                studyPlans.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                // Load user's selected plan
                if (currentUser && currentUser.selectedStudyPlan) {
                    currentStudyPlan = studyPlans.find(plan => plan.id === currentUser.selectedStudyPlan);
                } else if (studyPlans.length > 0) {
                    // Select first plan by default
                    currentStudyPlan = studyPlans[0];
                    if (currentUser) {
                        await updateDoc(doc(db, "users", currentUser.uid), {
                            selectedStudyPlan: studyPlans[0].id
                        });
                        currentUser.selectedStudyPlan = studyPlans[0].id;
                    }
                }
            } catch(error) {
                console.error("Error loading study plans:", error);
            }
        }

        // --- STUDY PAGE - IMPROVED ---
        window.renderStudy = async () => {
            updateNav(1);
            
            await loadStudyData();
            await loadStudyPlans();
            await loadMemorizingData();
            
            document.getElementById('main-content').innerHTML = `
                <div class="memorizing-tabs">
                    <div class="memorizing-tab active" onclick="showStudyTab('plan')">
                        <i class="fas fa-book"></i> Study Plan
                    </div>
                    <div class="memorizing-tab" onclick="showStudyTab('memorizing')">
                        <i class="fas fa-brain"></i> Memorizing Part
                    </div>
                </div>
                
                <div id="study-plan-tab">
                    ${await renderStudyPlanTab()}
                </div>
                
                <div id="memorizing-tab" style="display:none;">
                    ${await renderMemorizingTab()}
                </div>
            `;
            
            if (studyPlans.length === 0) {
                document.getElementById('study-plan-tab').innerHTML = `
                    <div class="card" style="text-align:center; padding:40px;">
                        <i class="fas fa-book" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
                        <h3>No Study Plans Available</h3>
                        <p style="color:var(--text-sec); margin-top:10px;">Study plans will be added by admin soon.</p>
                        <button onclick="renderHome()" class="btn btn-primary" style="margin-top:20px;">Back to Home</button>
                    </div>
                `;
            }
        }

        async function renderStudyPlanTab() {
            let html = `
                <div class="study-plan-header">
                    <div class="study-plan-title">Smart Study Journey</div>
                    <p style="opacity:0.9;">Track your progress and achieve your goals</p>
                    
                    <div class="study-plan-meta">
                        <div class="study-plan-meta-item">
                            <span class="study-plan-meta-value">${studyProgress ? studyProgress.totalProgress : 0}%</span>
                            <span class="study-plan-meta-label">Overall Progress</span>
                        </div>
                        <div class="study-plan-meta-item">
                            <span class="study-plan-meta-value">${studyProgress ? studyProgress.dailyProgress : 0}%</span>
                            <span class="study-plan-meta-label">Today's Goal</span>
                        </div>
                        <div class="study-plan-meta-item">
                            <span class="study-plan-meta-value">${studyProgress ? studyProgress.completedTopics.length : 0}</span>
                            <span class="study-plan-meta-label">Topics Done</span>
                        </div>
                    </div>
                    
                    ${currentStudyPlan ? `
                        <div class="study-plan-countdown">
                            <div style="font-size:0.9rem; margin-bottom:10px;">Time remaining for "${currentStudyPlan.name}"</div>
                            <div class="countdown-grid" id="study-countdown">
                                <div class="countdown-cell">
                                    <span class="countdown-cell-value" id="countdown-days">0</span>
                                    <span class="countdown-cell-label">Days</span>
                                </div>
                                <div class="countdown-cell">
                                    <span class="countdown-cell-value" id="countdown-hours">0</span>
                                    <span class="countdown-cell-label">Hours</span>
                                </div>
                                <div class="countdown-cell">
                                    <span class="countdown-cell-value" id="countdown-minutes">0</span>
                                    <span class="countdown-cell-label">Minutes</span>
                                </div>
                                <div class="countdown-cell">
                                    <span class="countdown-cell-value" id="countdown-weeks">0</span>
                                    <span class="countdown-cell-label">Weeks</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="study-select-container">
                    <div class="study-select-wrapper">
                        <select class="study-select" id="study-plan-select" onchange="changeStudyPlan(this.value)">
                            <option value="">Select Study Plan</option>
                            ${studyPlans.map(plan => 
                                `<option value="${plan.id}" ${plan.id === currentUser.selectedStudyPlan ? 'selected' : ''}>
                                    ${plan.name} ${plan.totalDuration ? `(${plan.totalDuration} days)` : ''}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="motivational-carousel">
                    <div class="carousel-track" id="carousel-track"></div>
                    <div class="carousel-indicators" id="carousel-indicators"></div>
                </div>
                
                <div class="progress-cards">
                    <div class="progress-card">
                        <div class="progress-header">
                            <div class="progress-title">Total Study Progress</div>
                            <div class="progress-percentage">${studyProgress ? studyProgress.totalProgress : 0}%</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${studyProgress ? studyProgress.totalProgress : 0}%"></div>
                        </div>
                        <div class="progress-stats">
                            <span>${studyProgress ? studyProgress.completedTopics.length : 0} Topics</span>
                            <span>${studyProgress ? studyProgress.totalStudyTime : 0} min</span>
                        </div>
                    </div>
                    
                    <div class="progress-card">
                        <div class="progress-header">
                            <div class="progress-title">Daily Study Progress</div>
                            <div class="progress-percentage">${studyProgress ? studyProgress.dailyProgress : 0}%</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${studyProgress ? studyProgress.dailyProgress : 0}%"></div>
                        </div>
                        <div class="progress-stats">
                            <span>Today's Goal</span>
                            <span>${studyProgress ? studyProgress.dailyStudyTime : 0}/${studySettings ? studySettings.dailyGoal : 60} min</span>
                        </div>
                    </div>
                </div>
                
                <div id="study-content-container" style="display:${currentStudyPlan ? 'block' : 'none'};">
                    <div class="study-level-selector">
                        <div class="study-level-select-wrapper">
                            <select class="study-level-select" id="study-level-select" onchange="changeStudyLevel(this.value)">
                                <option value="">Select Study Level</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="study-cards-container">
                        <h3 class="study-section-title">
                            <i class="fas fa-calendar-day"></i>
                            Study Plan - <span id="current-plan-name"></span>
                        </h3>
                        <div id="study-cards-grid" class="study-cards-grid">
                            <div class="shimmer" style="height:200px; border-radius:15px;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            startMotivationalCarousel();
            
            if (currentStudyPlan) {
                await loadStudyPlanContent();
                updateStudyCountdown();
            }
            
            return html;
        }

        async function renderMemorizingTab() {
            let html = `
                <div class="card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white;">
                    <h3 style="margin-bottom:10px;"><i class="fas fa-brain"></i> Memorizing Part</h3>
                    <p style="opacity:0.9;">Improve your memory with daily practice</p>
                </div>
                
                <div class="memorizing-category-selector">
                    <div class="study-select-wrapper">
                        <select class="study-select" id="memorizing-category-select" onchange="changeMemorizingCategory(this.value)">
                            <option value="">Select Category</option>
                            ${memorizingCategories.map(cat => 
                                `<option value="${cat.id}">${cat.name} (${cat.itemCount || 0} items)</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                
                ${currentMemorizingCategory ? `
                    <div class="memorizing-progress">
                        <div class="memorizing-day-info">
                            <div class="memorizing-day-badge" id="memorizing-current-day">Day ${currentMemorizingDay}</div>
                            <div>${currentMemorizingCategory.name}</div>
                        </div>
                        <div class="memorizing-stats">
                            <div class="memorizing-stat">
                                <span class="memorizing-stat-value" id="memorizing-completed-cards">0</span>
                                <span class="memorizing-stat-label">Completed</span>
                            </div>
                            <div class="memorizing-stat">
                                <span class="memorizing-stat-value" id="memorizing-difficult-cards">0</span>
                                <span class="memorizing-stat-label">Difficult</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="memorizing-tabs" style="margin-bottom:20px;">
                        <div class="memorizing-tab active" onclick="toggleMemorizingTab('cards')">
                            <i class="fas fa-th-large"></i> Cards
                        </div>
                        <div class="memorizing-tab" onclick="toggleMemorizingTab('stats')">
                            <i class="fas fa-chart-bar"></i> Stats
                        </div>
                    </div>
                    
                    <div id="memorizing-cards-container" class="memorizing-cards-container">
                        <div id="memorizing-cards-grid"></div>
                    </div>
                    
                    <div id="memorizing-stats-container" style="display:none;">
                        <div class="card">
                            <h4><i class="fas fa-chart-line"></i> Progress Statistics</h4>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
                                <div class="stat-item">
                                    <span class="stat-value" id="memorizing-total-cards">0</span>
                                    <span class="stat-label">Total Cards</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="memorizing-completion-rate">0%</span>
                                    <span class="stat-label">Completion</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="completeMemorizingDay()" class="btn btn-success" style="margin-top:20px;">
                        <i class="fas fa-check-circle"></i> Complete Today's Cards
                    </button>
                    
                    <div class="card" style="margin-top:20px;">
                        <h4><i class="fas fa-lightbulb"></i> How to Use</h4>
                        <ul style="margin-top:10px; padding-left:20px; color:var(--text-sec);">
                            <li>Study 10 cards each day</li>
                            <li>Double-click on difficult cards to mark them</li>
                            <li>Difficult cards will appear again tomorrow</li>
                            <li>Click "Complete" when finished with today's cards</li>
                        </ul>
                    </div>
                ` : `
                    <div class="card" style="text-align:center; padding:40px;">
                        <i class="fas fa-brain" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
                        <h3>Select a Category</h3>
                        <p style="color:var(--text-sec); margin-top:10px;">Choose a category to start memorizing</p>
                    </div>
                `}
            `;
            
            if (currentMemorizingCategory) {
                updateMemorizingStats();
                renderMemorizingCards();
            }
            
            return html;
        }

        window.showStudyTab = (tab) => {
            document.querySelectorAll('.memorizing-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'plan') {
                document.getElementById('study-plan-tab').style.display = 'block';
                document.getElementById('memorizing-tab').style.display = 'none';
            } else {
                document.getElementById('study-plan-tab').style.display = 'none';
                document.getElementById('memorizing-tab').style.display = 'block';
            }
        }

        function updateStudyCountdown() {
            if (!currentStudyPlan || !studyProgress.startDate) return;
            
            const startDate = studyProgress.startDate.toDate();
            const totalDuration = currentStudyPlan.totalDuration || 30; // Default 30 days
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + totalDuration);
            
            const now = new Date();
            const timeRemaining = endDate - now;
            
            if (timeRemaining <= 0) {
                // Study plan completed
                document.getElementById('study-countdown').innerHTML = `
                    <div style="grid-column: 1 / -1; text-align:center; padding:10px;">
                        <i class="fas fa-trophy" style="color:#FFD700;"></i>
                        <div style="font-weight:600; margin-top:5px;">Study Plan Completed!</div>
                    </div>
                `;
                return;
            }
            
            const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            const weeks = Math.floor(days / 7);
            
            document.getElementById('countdown-days').textContent = days;
            document.getElementById('countdown-hours').textContent = hours;
            document.getElementById('countdown-minutes').textContent = minutes;
            document.getElementById('countdown-weeks').textContent = weeks;
        }

        // ... [Rest of the code remains the same, just ensure all functions are included]

        // Note: Due to character limit, I'm showing the key changes. The complete code would include all the rest of the functions.
        // The important additions are the memorizing part functions and the improved study plan UI.

    </script>
</body>
</html>
